
<!DOCTYPE html>

<html lang="zh-tw">
<head>
<meta charset="utf-8"/>
<meta charset="utf-8" content="text/html" http-equiv="Content-Type">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>Starts Airflow task execution directly from the triggerer </title>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="origin" name="referrer"/>
<meta content="Pelican" name="generator"/>
<link href="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" rel="canonical"/>
<!-- Feed -->
<link href="https://blog.wei-lee.me/feeds/all.atom.xml" rel="alternate" title="Those aren't written down are meant to be forgotten Full Atom Feed" type="application/atom+xml"/>
<!-- TODO: combine -->
<link href="https://blog.wei-lee.me/theme/css/style.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pygments.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pagefind-ui-custom.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code-copy.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/pagefind/pagefind-ui.css" rel="stylesheet"/>
<!-- Custom fonts -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"/>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
<script>
    var siteUrl = 'https://blog.wei-lee.me';
  </script>
<script>
    var localTheme = localStorage.getItem('attila_theme');
    switch (localTheme) {
      case 'dark':
        document.documentElement.classList.add('theme-dark');
        break;
      case 'light':
        document.documentElement.classList.add('theme-light');
        break;
      default:
        break;
    }
  </script>
<meta content="A few weeks ago, I submitted #38674 to airflow to Airflow, which was later selected as the PR of the month. (Thanks, Kaxil, for the nomination!)" name="description"/>
<meta content="Wei Lee" name="author"/>
<meta content="Airflow" name="tags"/>
<meta content="Airflow 2.10" name="tags"/>
<meta content="Triggerer" name="tags"/>
<!-- Open Graph -->
<meta content="Those aren't written down are meant to be forgotten" prefix="og: http://ogp.me/ns#" property="og:site_name">
<meta content="Starts Airflow task execution directly from the triggerer " prefix="og: http://ogp.me/ns#" property="og:title">
<meta content="A few weeks ago, I submitted #38674 to airflow to Airflow, which was later selected as the PR of the month. (Thanks, Kaxil, for the nomination!)" prefix="og: http://ogp.me/ns#" property="og:description">
<meta content="zh-tw" prefix="og: http://ogp.me/ns#" property="og:locale">
<meta content="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" prefix="og: http://ogp.me/ns#" property="og:url">
<meta content="article" prefix="og: http://ogp.me/ns#" property="og:type"/>
<meta content="2024-06-02 18:20:00+08:00" prefix="og: http://ogp.me/ns#" property="article:published_time"/>
<meta content="2024-07-30 23:55:00+08:00" prefix="og: http://ogp.me/ns#" property="article:modified_time"/>
<meta content="https://blog.wei-lee.me/author/wei-lee.html" prefix="og: http://ogp.me/ns#" property="article:author"/>
<meta content="Tech" prefix="og: http://ogp.me/ns#" property="article:section">
<meta content="Airflow" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="Airflow 2.10" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="Triggerer" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="https://blog.wei-lee.me//images/cover.jpeg" prefix="og: http://ogp.me/ns#" property="og:image"/>
<!-- Twitter Card -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="@clleew" name="twitter:site"/>
<meta content="Starts Airflow task execution directly from the triggerer " name="twitter:title"/>
<meta content="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" name="twitter:url"/>
<meta content="https://blog.wei-lee.me//images/cover.jpeg" name="twitter:image:src"/>
<meta content="A few weeks ago, I submitted #38674 to airflow to Airflow, which was later selected as the PR of the month. (Thanks, Kaxil, for the nomination!)" name="twitter:description"/>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Starts Airflow task execution directly from the triggerer",
  "headline": "Starts Airflow task execution directly from the triggerer",
  "datePublished": "2024-06-02 18:20:00+08:00",
  "dateModified": "2024-07-30 23:55:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Wei Lee",
    "url": "https://blog.wei-lee.me/author/wei-lee.html"
  },
  "image": "https://blog.wei-lee.me//images/cover.jpeg",
  "url": "https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker",
  "description": "A few weeks ago, I submitted #38674 to airflow to Airflow, which was later selected as the PR of the month. (Thanks, Kaxil, for the nomination!)"
}
</script>
</meta></meta></meta></meta></meta></meta></link></meta><link href="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Those aren't written down are meant to be forgotten", "item": "https://blog.wei-lee.me"}, {"@type": "ListItem", "position": 2, "name": "Posts", "item": "https://blog.wei-lee.me/posts"}, {"@type": "ListItem", "position": 3, "name": "Tech", "item": "https://blog.wei-lee.me/posts/tech"}, {"@type": "ListItem", "position": 4, "name": "2024", "item": "https://blog.wei-lee.me/posts/tech/2024"}, {"@type": "ListItem", "position": 5, "name": "06", "item": "https://blog.wei-lee.me/posts/tech/2024/06"}, {"@type": "ListItem", "position": 6, "name": "Starts execution directly from triggerer without going to worker", "item": "https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker"}, {"@type": "ListItem", "position": 7, "name": "Index", "item": "https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Wei Lee"}, "publisher": {"@type": "Organization", "name": "Those aren't written down are meant to be forgotten"}, "headline": "Starts Airflow task execution directly from the triggerer", "about": "Tech", "datePublished": "2024-06-02 18:20"}</script><meta content="summary" name="twitter:card"/><meta content="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" property="og:url"/><meta content="article" property="og:type"/><meta content="Starts Airflow task execution directly from the triggerer" property="og:title"/><meta content="C" property="og:locale"/></head>
<body class="category-template">
<div class="nav-header">
<nav aria-label="Main" class="nav-wrapper">
<ul>
<li class="nav-üè† Home" role="presentation"><a href="/"><span>üè† Home</span></a></li>
<li class="nav-About Me" role="presentation"><a href="/pages/about-me.html"><span>About Me</span></a></li>
<li class="nav-üë®‚Äçüíª Tech active" role="presentation"><a href="/category/tech.html"><span>üë®‚Äçüíª Tech</span></a></li>
<li class="nav-üìö Book Digest" role="presentation"><a href="/category/book.html"><span>üìö Book Digest</span></a></li>
<li class="nav-üí¨ Gossiping" role="presentation"><a href="/category/gossiping.html"><span>üí¨ Gossiping</span></a></li>
<li class="nav-üè∑Ô∏è Tags" role="presentation"><a href="/tags.html"><span>üè∑Ô∏è Tags</span></a></li>
<li class="nav-üóÑÔ∏è Archives" role="presentation"><a href="/archives.html"><span>üóÑÔ∏è Archives</span></a></li>
<li class="nav-üìö Series" role="presentation"><a href="/series_list.html"><span>üìö Series</span></a></li>
<li class="nav-üîç Search" role="presentation"><a href="/search.html"><span>üîç Search</span></a></li>
</ul>
<ul class="nav-meta">
<li class="nav-linkedin"><a aria-label="Linkedin" href="https://tw.linkedin.com/in/clleew" target="_blank"><i aria-hidden="true" class="icon icon-linkedin"></i>
<span>Linkedin</span>
</a></li>
<li class="nav-github"><a aria-label="Github" href="https://github.com/Lee-W" target="_blank"><i aria-hidden="true" class="icon icon-github"></i>
<span>GitHub</span>
</a></li>
<li class="nav-twitter"><a aria-label="Twitter" href="https://twitter.com/clleew" target="_blank"><i aria-hidden="true" class="icon icon-twitter"></i>
<span>Twitter</span>
</a></li>
<li class="nav-search" style="display: none;">
<a title="Search">
<i aria-hidden="true" class="icon icon-search"></i>
<span>Search</span>
</a>
</li>
</ul> </nav>
<div class="nav-wrapper-control">
<div class="inner">
<a class="nav-menu" role="button"><i aria-hidden="true" class="icon icon-menu"></i>Menu</a>
<a class="nav-search" role="button" style="display: none;" title="Search"><i aria-hidden="true" class="icon icon-search"></i></a>
</div>
</div>
</div>
<div aria-label="Close" class="nav-close" role="button"></div>
<section class="page-wrapper" id="wrapper">
<!-- Progressbar -->
<div class="progress-container">
<span class="progress-bar"></span>
</div>
<!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="post-header has-cover">
<div class="inner">
<span class="post-info">
<span class="post-type">Article</span>
<span class="post-count">Tech</span>
</span>
<h1 class="post-title">
            Starts Airflow task execution directly from the triggerer
        </h1>
<div class="post-meta">
<div class="post-meta-avatars">
<figure class="post-meta-avatar avatar">
<a class="author-avatar" href="https://blog.wei-lee.me/author/wei-lee.html">
<img alt="Wei Lee" class="author-profile-image" src="https://blog.wei-lee.me//images/avatar.jpeg"/>
</a>
</figure>
</div>
<h4 class="post-meta-author">
            Wei Lee
          </h4>
<time datetime="2024/06/02 - Sun">2024/06/02 - Sun</time>
          ‚Ä¢ <time datetime="2024/07/30 - Tue"> Updated on 2024/07/30 - Tue</time>
          ‚Ä¢ 4 min read
        </div>
<div class="post-cover cover">
<img alt="Category Tech" src="https://blog.wei-lee.me//images/cover.jpeg"/>
</div>
</div>
</header>
<!-- Post content -->
<main class="content" data-pagefind-body="" role="main">
<article class="post">
<div class="inner">
<section class="post-content">
<p>A few weeks ago, I submitted <a href="https://github.com/apache/airflow/pull/38674">#38674</a> to <a href="https://github.com/apache/airflow">airflow</a> to Airflow, which was later selected as the PR of the month. (Thanks, Kaxil, for the nomination!)</p>
<!--more-->
<p>Thus, I was invited to present this feature at the  <a href="https://astronomer.zoom.us/meeting/register/tZYqcOqhpjkqHdWPk_L11pHpUVLRHB4uYBSv#/registration">Airflow Monthly Town-Hall</a>. Here is the <a href="https://speakerdeck.com/leew/starts-airflow-task-execution-directly-from-the-triggerer">slide</a> I used.</p>
<p>Even though this feature will not look the same after <a href="https://github.com/apache/airflow/pull/39585">#39585</a>, the core concept is similar, and I already finished 70% of this article before even creating that PR, so I still want to finish this writing üòÜ</p>
<div class="toc">
<ul>
<li><a href="#how-did-the-deferrable-operator-work-before-this-change">How did the deferrable operator work before this change?</a></li>
<li><a href="#why-do-we-want-it">Why do we want it?</a></li>
<li><a href="#how-does-it-affect-dag-authors">How does it affect DAG authors?</a></li>
<li><a href="#how-does-it-affect-operator-authors">How does it affect operator authors?</a></li>
<li><a href="#lets-see-how-it-looks-like">Let's see how it looks like</a></li>
<li><a href="#how-does-it-work-under-the-hook">How does it work under the hook</a></li>
<li><a href="#limitation">Limitation</a></li>
</ul>
</div>
<h2 id="how-did-the-deferrable-operator-work-before-this-change">How did the deferrable operator work before this change?</h2>
<p>When a task with <code>deferrable=True</code> is triggered, the <a href="https://airflow.apache.org/docs/apache-airflow/2.9.1/administration-and-deployment/scheduler.html">scheduler</a> assigns a worker to run the <code>execute</code> method of the operator (e.g., <a href="https://github.com/apache/airflow/blob/2d53c1089f78d8d1416f51af60e1e0354781c661/airflow/operators/trigger_dagrun.py#L73">TriggerDagRunOperator</a>). If the task runs <a href="https://github.com/apache/airflow/blob/2d53c1089f78d8d1416f51af60e1e0354781c661/airflow/operators/trigger_dagrun.py#L211">self.defer</a> which raises a <a href="https://github.com/apache/airflow/blob/2d53c1089f78d8d1416f51af60e1e0354781c661/airflow/models/baseoperator.py#L1684">TaskDeferred</a>. The scheduler will change the task instance state to <a href="https://github.com/apache/airflow/blob/e299ac91e2fddc709487aaaa4bb24162f77ba615/airflow/utils/state.py#L59C17-L59C25">deferred</a>. Then the <a href="https://airflow.apache.org/docs/apache-airflow/2.9.1/authoring-and-scheduling/deferring.html">triggerer</a> will pick up the task and run the task in an async manner. After finishing, the trigger <code>yield</code> a TriggerEvent. Then the scheduler will once again assign a worker to run this task and run the <code>next_method</code> which is usually named as <code>execute_complate</code>.</p>
<p>The current flow looks like this.</p>
<div class="mermaid">
sequenceDiagram
    autonumber
    Scheduler -&gt;&gt; Worker: change the TaskInstanceState to QUEUED
    Worker -&gt;&gt; Worker: run "execute" method
    Worker -&gt;&gt; Triggerer: raise "TaskDeferred" exception and change TaskInstanceState to DEFERRED
    Triggerer -) Triggerer: run "run" method and yield "TriggerEvent"
    Triggerer --) Scheduler: Change the TaskInstanceState to SCHEDULED
    Scheduler -&gt;&gt; Worker 2: Change the TaskInstanceState to QUEUED
    Worker 2 -&gt;&gt; Worker 2: run "next_method"
    Worker 2 -&gt;&gt; Scheduler: Change the TaskInstanceState to SUCCESS
</div>
<h2 id="why-do-we-want-it">Why do we want it?</h2>
<p>If you take a look at <a href="https://github.com/apache/airflow/blob/2d53c1089f78d8d1416f51af60e1e0354781c661/airflow/providers/amazon/aws/sensors/s3.py#L346-L367">S3KeysUnchangedSensor</a>, the only thing that the <a href="https://github.com/apache/airflow/blob/2d53c1089f78d8d1416f51af60e1e0354781c661/airflow/providers/amazon/aws/sensors/s3.py#L346-L367">execute method</a> do is pretty much just deferring. Thus, we don‚Äôt really to execute it from a worker and than defer it to triggerer. We can just start the execution from triggerer and change the flow to the following.</p>
<div class="mermaid">
sequenceDiagram
    autonumber
    Scheduler -&gt;&gt; Triggerer: raise "TaskDeferred" and change TaskInstanceState to DEFERRED
    Triggerer -) Triggerer: run "run" method and yield "TriggerEvent"
    Triggerer --) Scheduler: Change the TaskInstanceState to SCHEDULED
    Scheduler -&gt;&gt; Worker 2: Change the TaskInstanceState to QUEUED
    Worker 2 -&gt;&gt; Worker 2: run "next_method"
    Worker 2 -&gt;&gt; Scheduler: Change the TaskInstanceState to SUCCESS
</div>
<p>And, in some cases, we don‚Äôt even need to run ‚Äúnext_method‚Äù in the triggerer, so we probably could support skip ‚Äúnext_method‚Äù as well in the future.</p>
<div class="mermaid">
sequenceDiagram
    autonumber
    Scheduler -&gt;&gt; Triggerer: raise "TaskDeferred" and change TaskInstanceState to DEFERRED
    Triggerer -) Triggerer: run "run" and yield "TriggerEvent"
    Triggerer --) Scheduler: Change the TaskInstanceState to SUCCESS
</div>
<h2 id="how-does-it-affect-dag-authors">How does it affect DAG authors?</h2>
<p>Well, not much at this moment. Ideally, everything should be the same but more efficient, and it might also open new opportunities for other use cases.</p>
<h2 id="how-does-it-affect-operator-authors">How does it affect operator authors?</h2>
<p>A new way to way to implement operators in an async manner</p>
<h2 id="lets-see-how-it-looks-like">Let's see how it looks like</h2>
<p>Before this feature was added, to defer <code>WaitOneHourSensor</code>, we need to run call the <code>defer</code> method in <code>execute</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">airflow.sensors.base</span> <span class="kn">import</span> <span class="n">BaseSensorOperator</span>
<span class="kn">from</span> <span class="nn">airflow.triggers.temporal</span> <span class="kn">import</span> <span class="n">TimeDeltaTrigger</span>
<span class="kn">from</span> <span class="nn">airflow.utils.context</span> <span class="kn">import</span> <span class="n">Context</span>


<span class="k">class</span> <span class="nc">WaitOneHourSensor</span><span class="p">(</span><span class="n">BaseSensorOperator</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">TimeDeltaTrigger</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">method_name</span><span class="o">=</span><span class="s2">"execute_complete"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We have no more work to do here. Mark as complete.</span>
        <span class="k">return</span>
</code></pre></div>
<p>Now, we can add <code>start_trigger</code> and <code>next_method</code> attributes and the scheduler will know we want to execute this task directly from the triggerer.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>

<span class="kn">from</span> <span class="nn">airflow.sensors.base</span> <span class="kn">import</span> <span class="n">BaseSensorOperator</span>
<span class="kn">from</span> <span class="nn">airflow.triggers.temporal</span> <span class="kn">import</span> <span class="n">TimeDeltaTrigger</span>
<span class="kn">from</span> <span class="nn">airflow.utils.context</span> <span class="kn">import</span> <span class="n">Context</span>


<span class="k">class</span> <span class="nc">WaitOneHourSensor</span><span class="p">(</span><span class="n">BaseSensorOperator</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_trigger</span> <span class="o">=</span> <span class="n">TimeDeltaTrigger</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_method</span> <span class="o">=</span> <span class="s2">"execute_complete"</span>

    <span class="k">def</span> <span class="nf">execute_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We have no more work to do here. Mark as complete.</span>
        <span class="k">return</span>
</code></pre></div>
<h2 id="how-does-it-work-under-the-hook">How does it work under the hook</h2>
<p>Let's take a look at <a href="https://github.com/apache/airflow/blob/3d97474a49a00bb6fcd67cf20d470a1fc2861f4f/airflow/models/dagrun.py#L1541-L1553">airflow/models/dagrun.py</a></p>
<!-- blacken-docs:off -->
<div class="highlight"><pre><span></span><code>            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">start_trigger</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">next_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">on_execute_callback</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">on_success_callback</span>
                <span class="ow">and</span> <span class="ow">not</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">outlets</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">UP_FOR_RESCHEDULE</span><span class="p">:</span>
                    <span class="n">ti</span><span class="o">.</span><span class="n">try_number</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ti</span><span class="o">.</span><span class="n">defer_task</span><span class="p">(</span>
                    <span class="n">exception</span><span class="o">=</span><span class="n">TaskDeferred</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">start_trigger</span><span class="p">,</span> <span class="n">method_name</span><span class="o">=</span><span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">next_method</span><span class="p">),</span>
                    <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
                <span class="p">)</span>
</code></pre></div>
<!-- blacken-docs:on -->
<p>It checks whether a task has both <code>start_trigger</code> and <code>next_method</code> set. If so, we'll defer this task by calling <code>defer_task</code> instead of adding it to <code>schedulable_ti_ids.</code> (The <code>on_execute_callback</code>, <code>on_success_callback</code>, and <code>outlets</code> checks are actually wrong and are addressed in <a href="https://github.com/apache/airflow/pull/39585">#39585</a>).</p>
<h2 id="limitation">Limitation</h2>
<p>Dynamic Task Mapping / MappedOperator is not fully supported at this time due to the way this type of operator is initialized on the worker. However, a draft PR <a href="https://github.com/apache/airflow/pull/39912">#39912</a> has been created to address this.</p>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>
</section>
<section class="post-footer">
<div class="post-share">
<span class="post-info-label">Share</span>
<a aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=Starts Airflow task execution directly from the triggerer &amp;url=https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter">
<i aria-hidden="true" class="icon icon-twitter"></i><span class="hidden">Twitter</span>
</a>
<a aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Facebook">
<i aria-hidden="true" class="icon icon-facebook"></i><span class="hidden">Facebook</span>
</a>
<a aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker&amp;title=Starts Airflow task execution directly from the triggerer" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720');return false;" title="LinkedIn">
<i aria-hidden="true" class="icon icon-linkedin"></i><span class="hidden">LinkedIn</span>
</a>
<a aria-label="Email" class="email" href="mailto:?subject=Starts Airflow task execution directly from the triggerer&amp;body=https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" title="Email">
<i aria-hidden="true" class="icon icon-mail"></i><span class="hidden">Email</span>
</a>
<div class="clear"></div>
</div>
<aside class="post-tags">
<a href="https://blog.wei-lee.me/tag/airflow.html">Airflow</a><a href="https://blog.wei-lee.me/tag/airflow-210.html">Airflow 2.10</a><a href="https://blog.wei-lee.me/tag/triggerer.html">Triggerer</a> </aside>
<div class="clear"></div>
<div class="series">
<p>This post is part 1 of the "What If...? Running Airflow Tasks without the workers" series:</p>
<ol class="parts">
<li class="active">
<a href="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker">Starts Airflow task execution directly from the triggerer</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2024/08/enhancing-airflow-task-execution-with-start-trigger-args">Enhancing Airflow Task Execution with StartTriggerArgs</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2024/08/serialize-start-trigger-args">Serialize StartTriggerArgs - That's not how Airflow serialization works!</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger">Dynamic task mapping on operators that can start execution from trigger - This is not the feature you're looking for</a>
</li>
</ol>
</div>
</section>
<script type="text/javascript">var use_utterance = true;</script>
<section class="post-comments">
<script async="" crossorigin="anonymous" data-issue-term="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker" data-label="blog-comment" data-repo="Lee-W/main-blog" data-theme="github-light" src="https://utteranc.es/client.js">
</script>
</section>
<aside class="post-nav">
<div class="clear"></div>
</aside>
</div>
</article>
</main>
<div class="nav-footer">
<nav aria-label="Footer" class="nav-wrapper">
<span class="nav-copy">Those aren't written down are meant to be forgotten ¬© 2023
          <a class="nav-rss" href="https://blog.wei-lee.me/feeds/all.atom.xml" target="_blank" title="RSS"><i class="icon icon-rss"></i></a>
</span>
<span class="nav-credits">



          Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a> ‚Ä¢ Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a> ‚Ä¢
          <a class="menu-item js-theme" data-dark="Dark theme" data-light="Light theme" data-system="System theme" href="#">
<span class="theme-icon"></span><span class="theme-text">System theme</span>
</a>
</span>
</nav>
</div>
</section>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<!-- TODO: minify -->
<script src="https://blog.wei-lee.me/theme/js/jquery.fitvids.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/script.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/clipboard.min.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/copy-to-clipboard.js" type="text/javascript"></script>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3J7XQ46QH5"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3J7XQ46QH5', { 'anonymize_ip': true });
    </script>
<script src="/pagefind/pagefind-ui.js"></script>
<script>
      window.addEventListener('DOMContentLoaded', (event) => {
          new PagefindUI({
              element: "#search",
              showImages: false,
          });
      });
  </script>
<!-- 	The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in article.html, but it needs to be included down here, after jQuery has already loaded. -->
<script>
  $(document).ready(function () {
    var viewport = $(window);
    var post = $('.post-content');
    // Responsive videos with fitVids
    post.fitVids();

    // Reading progress bar on window top
    function readingProgress() {
      var postBottom = post.offset().top + post.height();
      var viewportHeight = viewport.height();
      var progress = 100 - (((postBottom - (viewport.scrollTop() + viewportHeight) + viewportHeight / 3) / (postBottom - viewportHeight + viewportHeight / 3)) * 100);
      $('.progress-bar').css('width', progress + '%');
      (progress > 100) ? $('.progress-container').addClass('complete'): $('.progress-container').removeClass('complete');
    }
    readingProgress();
    // Trigger reading progress
    viewport.on({
      'scroll': function() {
        readingProgress();
      },
      'resize': function() {
        readingProgress();
      },
      'orientationchange': function() {
        readingProgress();
      }
    });

  });
</script>
</body>
</html>
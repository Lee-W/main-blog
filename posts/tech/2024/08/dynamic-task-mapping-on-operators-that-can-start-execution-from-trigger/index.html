
<!DOCTYPE html>

<html lang="zh-tw">
<head>
<meta charset="utf-8"/>
<meta charset="utf-8" content="text/html" http-equiv="Content-Type">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>Dynamic task mapping on operators that can start execution from trigger  - This is not the feature you're looking for</title>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="origin" name="referrer"/>
<meta content="Pelican" name="generator"/>
<link href="https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" rel="canonical"/>
<!-- Feed -->
<link href="https://blog.wei-lee.me/feeds/all.atom.xml" rel="alternate" title="Those aren't written down are meant to be forgotten Full Atom Feed" type="application/atom+xml"/>
<!-- TODO: combine -->
<link href="https://blog.wei-lee.me/theme/css/style.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pygments.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pagefind-ui-custom.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code-copy.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/pagefind/pagefind-ui.css" rel="stylesheet"/>
<!-- Custom fonts -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"/>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
<script>
    var siteUrl = 'https://blog.wei-lee.me';
  </script>
<script>
    var localTheme = localStorage.getItem('attila_theme');
    switch (localTheme) {
      case 'dark':
        document.documentElement.classList.add('theme-dark');
        break;
      case 'light':
        document.documentElement.classList.add('theme-light');
        break;
      default:
        break;
    }
  </script>
<meta content="As mentioned in the first article of this series, dynamic task mapping was not supported before this PR. However, it's now supported...." name="description"/>
<meta content="Wei Lee" name="author"/>
<meta content="Python" name="tags"/>
<meta content="Airflow" name="tags"/>
<meta content="Airflow 2.10" name="tags"/>
<!-- Open Graph -->
<meta content="Those aren't written down are meant to be forgotten" prefix="og: http://ogp.me/ns#" property="og:site_name">
<meta content="Dynamic task mapping on operators that can start execution from trigger  - This is not the feature you're looking for" prefix="og: http://ogp.me/ns#" property="og:title">
<meta content="As mentioned in the first article of this series, dynamic task mapping was not supported before this PR. However, it's now supported...." prefix="og: http://ogp.me/ns#" property="og:description">
<meta content="zh-tw" prefix="og: http://ogp.me/ns#" property="og:locale">
<meta content="https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" prefix="og: http://ogp.me/ns#" property="og:url">
<meta content="article" prefix="og: http://ogp.me/ns#" property="og:type"/>
<meta content="2024-08-25 23:30:00+08:00" prefix="og: http://ogp.me/ns#" property="article:published_time"/>
<meta content="" prefix="og: http://ogp.me/ns#" property="article:modified_time"/>
<meta content="https://blog.wei-lee.me/author/wei-lee.html" prefix="og: http://ogp.me/ns#" property="article:author"/>
<meta content="Tech" prefix="og: http://ogp.me/ns#" property="article:section">
<meta content="Python" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="Airflow" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="Airflow 2.10" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="https://blog.wei-lee.me/images/posts-image/2024-dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger/not-looking-for.jpg" prefix="og: http://ogp.me/ns#" property="og:image"/>
<!-- Twitter Card -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="@clleew" name="twitter:site"/>
<meta content="Dynamic task mapping on operators that can start execution from trigger  - This is not the feature you're looking for" name="twitter:title"/>
<meta content="https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" name="twitter:url"/>
<meta content="https://blog.wei-lee.me/images/posts-image/2024-dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger/not-looking-for.jpg" name="twitter:image:src"/>
<meta content="As mentioned in the first article of this series, dynamic task mapping was not supported before this PR. However, it's now supported...." name="twitter:description"/>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Dynamic task mapping on operators that can start execution from trigger - This is not the feature you&#39;re looking for",
  "headline": "Dynamic task mapping on operators that can start execution from trigger - This is not the feature you&#39;re looking for",
  "datePublished": "2024-08-25 23:30:00+08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Wei Lee",
    "url": "https://blog.wei-lee.me/author/wei-lee.html"
  },
  "image": "",
  "url": "https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger",
  "description": "As mentioned in the first article of this series, dynamic task mapping was not supported before this PR. However, it's now supported...."
}
</script>
</meta></meta></meta></meta></meta></meta></link></meta><link href="https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Those aren't written down are meant to be forgotten", "item": "https://blog.wei-lee.me"}, {"@type": "ListItem", "position": 2, "name": "Posts", "item": "https://blog.wei-lee.me/posts"}, {"@type": "ListItem", "position": 3, "name": "Tech", "item": "https://blog.wei-lee.me/posts/tech"}, {"@type": "ListItem", "position": 4, "name": "2024", "item": "https://blog.wei-lee.me/posts/tech/2024"}, {"@type": "ListItem", "position": 5, "name": "08", "item": "https://blog.wei-lee.me/posts/tech/2024/08"}, {"@type": "ListItem", "position": 6, "name": "Dynamic task mapping on operators that can start execution from trigger", "item": "https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger"}, {"@type": "ListItem", "position": 7, "name": "Index", "item": "https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Wei Lee"}, "publisher": {"@type": "Organization", "name": "Those aren't written down are meant to be forgotten"}, "headline": "Dynamic task mapping on operators that can start execution from trigger", "about": "Tech", "datePublished": "2024-08-25 23:30"}</script><meta content="summary" name="twitter:card"/><meta content="https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" property="og:url"/><meta content="article" property="og:type"/><meta content="Dynamic task mapping on operators that can start execution from trigger" property="og:title"/><meta content="C" property="og:locale"/></head>
<body class="category-template">
<div class="nav-header">
<nav aria-label="Main" class="nav-wrapper">
<ul>
<li class="nav-üè† Home" role="presentation"><a href="/"><span>üè† Home</span></a></li>
<li class="nav-About Me" role="presentation"><a href="/pages/about-me.html"><span>About Me</span></a></li>
<li class="nav-üë®‚Äçüíª Tech active" role="presentation"><a href="/category/tech.html"><span>üë®‚Äçüíª Tech</span></a></li>
<li class="nav-üìö Book Digest" role="presentation"><a href="/category/book.html"><span>üìö Book Digest</span></a></li>
<li class="nav-üí¨ Gossiping" role="presentation"><a href="/category/gossiping.html"><span>üí¨ Gossiping</span></a></li>
<li class="nav-üè∑Ô∏è Tags" role="presentation"><a href="/tags.html"><span>üè∑Ô∏è Tags</span></a></li>
<li class="nav-üóÑÔ∏è Archives" role="presentation"><a href="/archives.html"><span>üóÑÔ∏è Archives</span></a></li>
<li class="nav-üìö Series" role="presentation"><a href="/series_list.html"><span>üìö Series</span></a></li>
<li class="nav-üîç Search" role="presentation"><a href="/search.html"><span>üîç Search</span></a></li>
</ul>
<ul class="nav-meta">
<li class="nav-linkedin"><a aria-label="Linkedin" href="https://tw.linkedin.com/in/clleew" target="_blank"><i aria-hidden="true" class="icon icon-linkedin"></i>
<span>Linkedin</span>
</a></li>
<li class="nav-github"><a aria-label="Github" href="https://github.com/Lee-W" target="_blank"><i aria-hidden="true" class="icon icon-github"></i>
<span>GitHub</span>
</a></li>
<li class="nav-twitter"><a aria-label="Twitter" href="https://twitter.com/clleew" target="_blank"><i aria-hidden="true" class="icon icon-twitter"></i>
<span>Twitter</span>
</a></li>
<li class="nav-search" style="display: none;">
<a title="Search">
<i aria-hidden="true" class="icon icon-search"></i>
<span>Search</span>
</a>
</li>
</ul> </nav>
<div class="nav-wrapper-control">
<div class="inner">
<a class="nav-menu" role="button"><i aria-hidden="true" class="icon icon-menu"></i>Menu</a>
<a class="nav-search" role="button" style="display: none;" title="Search"><i aria-hidden="true" class="icon icon-search"></i></a>
</div>
</div>
</div>
<div aria-label="Close" class="nav-close" role="button"></div>
<section class="page-wrapper" id="wrapper">
<!-- Progressbar -->
<div class="progress-container">
<span class="progress-bar"></span>
</div>
<!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="post-header has-cover">
<div class="inner">
<span class="post-info">
<span class="post-type">Article</span>
<span class="post-count">Tech</span>
</span>
<h1 class="post-title">
            Dynamic task mapping on operators that can start execution from trigger
            <br/>
<small class="post-subtitle-white">This is not the feature you're looking for</small>
</h1>
<div class="post-meta">
<div class="post-meta-avatars">
<figure class="post-meta-avatar avatar">
<a class="author-avatar" href="https://blog.wei-lee.me/author/wei-lee.html">
<img alt="Wei Lee" class="author-profile-image" src="https://blog.wei-lee.me//images/avatar.jpeg"/>
</a>
</figure>
</div>
<h4 class="post-meta-author">
            Wei Lee
          </h4>
<time datetime="2024/08/25 - Sun">2024/08/25 - Sun</time>
          ‚Ä¢ 5 min read
        </div>
<div class="post-cover cover">
<img alt="Category Tech" src="https://blog.wei-lee.me/images/posts-image/2024-dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger/not-looking-for.jpg"/>
</div>
</div>
</header>
<!-- Post content -->
<main class="content" data-pagefind-body="" role="main">
<article class="post">
<div class="inner">
<section class="post-content">
<p>As mentioned in <a href="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker">the first article of this series</a>, dynamic task mapping was not supported before <a href="https://github.com/apache/airflow/pull/39912">this PR</a>. However, it's now supported.</p>
<p>Well... partially</p>
<!--more-->
<h2 id="what-is-dynamic-task-mapping-anyway">What is dynamic task mapping anyway?</h2>
<p>In short, it's a way to define multiple tasks at runtime. For example,</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="n">dag_id</span><span class="o">=</span><span class="s2">"dynamic_task_mapping"</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="nd">@task</span>
    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>

    <span class="n">sum_values</span> <span class="o">=</span> <span class="nb">sum</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">300</span><span class="p">,</span> <span class="mi">400</span><span class="p">])</span>
</code></pre></div>
<p>will be interpreted as something like</p>
<div class="highlight"><pre><span></span><code><span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">400</span><span class="p">)</span>
<span class="nb">sum</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</code></pre></div>
<p>There are three methods you can use</p>
<ul>
<li><code>partial</code>: add fixed values</li>
<li><code>expand</code>: add values to expand</li>
<li><code>expand_kwargs</code>: add values to expand but in bundles</li>
</ul>
<p>The previous example can be modified to utilize <code>expand_kwargs</code>, and it will look like this</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span> <span class="n">DAG</span><span class="p">(</span><span class="n">dag_id</span><span class="o">=</span><span class="s2">"dynamic_task_mapping"</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2022</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="k">as</span> <span class="n">dag</span><span class="p">:</span>

    <span class="nd">@task</span>
    <span class="k">def</span> <span class="nf">sum</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>

    <span class="n">sum_values</span> <span class="o">=</span> <span class="nb">sum</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">expand_kwargs</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">{</span><span class="s2">"x"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">:</span> <span class="mi">300</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">"x"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">"x"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">:</span> <span class="mi">300</span><span class="p">},</span>
            <span class="p">{</span><span class="s2">"x"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">"y"</span><span class="p">:</span> <span class="mi">400</span><span class="p">},</span>
        <span class="p">]</span>
    <span class="p">)</span>
</code></pre></div>
<p>For more details, please check <a href="https://airflow.apache.org/docs/apache-airflow/2.10.0/authoring-and-scheduling/dynamic-task-mapping.html">Dynamic Task Mapping</a></p>
<h2 id="why-cant-it-be-supported-directly">Why can't it be supported directly?</h2>
<p>If we look back to <a href="https://github.com/apache/airflow/tree/25616424975e86f69cee35fb65c85283dcc0e245">commit 25616424975</a> (one commit before this PR), the decision on whether a task should be sent to the worker of the triggerer is made in <a href="https://github.com/apache/airflow/blob/25616424975e86f69cee35fb65c85283dcc0e245/airflow/models/dagrun.py#L1571-L1586">airflow/models/dagrun.py::DagRun::schedule_tis</a> and it used <code>start_from_trigger</code> and <code>start_trigger_args</code> to do so. To visualize this, let's take a look at the following two flowcharts.</p>
<p>This is what Airflow did before the introduction of the "start execution from trigger" feature. We checked whether the task inherited from an <a href="https://airflow.apache.org/docs/apache-airflow/2.10.0/_modules/airflow/operators/empty.html#EmptyOperator">EmptyOperator</a>. If so, we marked it as a success. Otherwise, we added the task to the list of tasks to be scheduled.</p>
<pre class="mermaid">
---
title: Schedule a task (before start_from_trigger was introduced)
---
flowchart TD
    start
    is_empty{"inherit from
              empty operator"}
    dummy["mark as success"]
    worker["add it to
            schedulable tasks"]

    start --&gt; is_empty
    is_empty --yes--&gt; dummy
    is_empty --noo--&gt; worker
</pre>
<p>Now, we add an additional check to see if <code>start_from_trigger</code> is set to True to determine whether to delay this task at this stage.</p>
<pre class="mermaid">
---
title: Schedule a task (after start_from_trigger was introduced)
---
flowchart TD
    start
    is_empty{"inherit from
              empty operator"}
    dummy["mark as success"]
    worker["add it to
            schedulable tasks"]
    start_from_trigger{"start_from_trigger
                        is True"}
    trigger["defer the task
             for the triggerer
             to pick up"]

    start --&gt; is_empty
    is_empty --yes--&gt; dummy
    is_empty --noo--&gt; start_from_trigger

    start_from_trigger --noo--&gt; worker
    start_from_trigger --yes--&gt; trigger

    style start_from_trigger color:#FFFFFF, stroke:#00C853, fill:#00C853
    style trigger color:#FFFFFF, stroke:#00C853, fill:#00C853
</pre>
<p>The issue is that when tasks are mapped, the scheduler does not execute their <code>__init__</code> method. We cannot determine the actual values of <code>start_from_trigger</code> and <code>start_trigger_args</code> until the task is initialized, which does not occur in the scheduler. If we only check these values at the class level, this feature becomes entirely useless, as we cannot map tasks with different values.</p>
<p>We are in a situation where we need these values to decide whether they should go to the worker or the triggerer, but we can only obtain them from the worker.</p>
<p><img alt="you need start_from_trigger" src="/images/posts-image/2024-dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger/you-need.jpg"/></p>
<h2 id="what-can-we-do">What can we do?</h2>
<p>There's not much we can do unless we rewrite the entire dynamic task mapping feature in Airflow. The following is pretty much the only workaround available at the moment.</p>
<p>Let's go back to <a href="https://github.com/apache/airflow/pull/39912/files#diff-649fbbf224bab54417f03338c27d0fdb3c3336e53a522a13dfd9806c99f63137R1580-R1594">where we decide whether to defer or not</a>. We implemented a new <code>expand_start_from_trigger</code> method and try to provide a way for the mapped operator to get <code>start_from_trigger.</code> For non-mapped operators, this method only returns <code>self.start_from_trigger</code>.</p>
<!-- blacken-docs:off -->
<div class="highlight"><pre><span></span><code>            <span class="c1"># check "start_trigger_args" to see whether the operator supports start execution from triggerer</span>
            <span class="c1"># if so, we'll then check "start_from_trigger" to see whether this feature is turned on and defer</span>
            <span class="c1"># this task.</span>
            <span class="c1"># if not, we'll add this "ti" into "schedulable_ti_ids" and later execute it to run in the worker</span>
            <span class="k">elif</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">start_trigger_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">get_template_context</span><span class="p">()</span>
                <span class="n">start_from_trigger</span> <span class="o">=</span> <span class="n">ti</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">expand_start_from_trigger</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">start_from_trigger</span><span class="p">:</span>
                    <span class="n">ti</span><span class="o">.</span><span class="n">start_date</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">ti</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">TaskInstanceState</span><span class="o">.</span><span class="n">UP_FOR_RESCHEDULE</span><span class="p">:</span>
                        <span class="n">ti</span><span class="o">.</span><span class="n">try_number</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">ti</span><span class="o">.</span><span class="n">defer_task</span><span class="p">(</span><span class="n">exception</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">schedulable_ti_ids</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ti</span><span class="o">.</span><span class="n">task_id</span><span class="p">,</span> <span class="n">ti</span><span class="o">.</span><span class="n">map_index</span><span class="p">))</span>
</code></pre></div>
<!-- blacken-docs:on -->
<p>For the mapped operator, it checks whether the argument <code>start_from_trigger</code> is passed through <code>partial</code>, <code>expand</code>, and <code>expand_kwargs</code> (the methods you need to use dynamic task mapping as mentioned in the "What is dynamic task mapping anyway?" section). If so, we'll use this value to decide whether to defer the task.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">expand_start_from_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Get the start_from_trigger value of the current abstract operator.</span>
<span class="sd">    MappedOperator uses this to unmap start_from_trigger to decide whether to start the task</span>
<span class="sd">    execution directly from triggerer.</span>
<span class="sd">    :meta private:</span>
<span class="sd">    """</span>
    <span class="c1"># start_from_trigger only makes sense when start_trigger_args exists.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_trigger_args</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">mapped_kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_expand_mapped_kwargs</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">include_xcom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disallow_kwargs_override</span><span class="p">:</span>
        <span class="n">prevent_duplicates</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">partial_kwargs</span><span class="p">,</span>
            <span class="n">mapped_kwargs</span><span class="p">,</span>
            <span class="n">fail_reason</span><span class="o">=</span><span class="s2">"unmappable or already specified"</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Ordering is significant; mapped kwargs should override partial ones.</span>
    <span class="k">return</span> <span class="n">mapped_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">"start_from_trigger"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">partial_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"start_from_trigger"</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_from_trigger</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
<p>Note that the argument name must be the same to take effect. If you're doing something like</p>
<div class="highlight"><pre><span></span><code>def __init__(self, sft: bool):
    self.start_from_trigger = sft
</code></pre></div>
<p>It won't take effect as the mapped operator won't run <code>__init__</code> at that stage.</p>
<p>As for <code>self.start_trigger_args</code>, we're doing something similar. After we have already decided we want to defer the task, we use the newly added <code>expand_start_trigger_args</code> method to get the value needed <a href="https://github.com/apache/airflow/pull/39912/files#diff-62f7d8a52fefdb8e05d4f040c6d3459b4a56fe46976c24f68843dbaeb5a98487R1621-R1631">here</a></p>
<p>One last thing to note is that we're not resolving XCom for these 2 values.</p>
<h2 id="so-how-can-we-use-it">So how can we use it?</h2>
<p>I intentionally don't include a table of contents in this article, and it starts with how this feature works under the hood instead of how to use it. If you don‚Äôt know if you need to combine this feature with dynamic task mapping, you don't.</p>
<p><img alt="this is not the feature you're looking for" src="/images/posts-image/2024-dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger/not-looking-for.jpg"/></p>
<p>This feature has some limitations. The syntax is slightly different from standard dynamic task mapping, which makes it easy to go wrong. Also, it does not resolve XCom when trying to expand <code>start_from_trigger</code> and <code>.start_trigger_arg</code>, which makes this feature less powerful.</p>
<p>Unless you know the risk and the difference between it and dynamic task mapping on standard operators.</p>
<p><img alt="don't try it" src="/images/posts-image/2024-dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger/donot-try-it.jpg"/></p>
<p><strong>Warning: Proceed at your own risk.</strong></p>
<p>First, you'll need to define arguments <code>trigger_kwargs</code> explicitly and  <code>start_from_trigger</code> in the <code>__init__</code> method so Airflow can expand it in the scheduler.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">WaitHoursSensor</span><span class="p">(</span><span class="n">BaseSensorOperator</span><span class="p">):</span>
    <span class="n">start_trigger_args</span> <span class="o">=</span> <span class="n">StartTriggerArgs</span><span class="p">(</span>
        <span class="n">trigger_cls</span><span class="o">=</span><span class="s2">"airflow.triggers.temporal.TimeDeltaTrigger"</span><span class="p">,</span>
        <span class="n">trigger_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">"moment"</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)},</span>
        <span class="n">next_method</span><span class="o">=</span><span class="s2">"execute_complete"</span><span class="p">,</span>
        <span class="n">next_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">trigger_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">start_from_trigger</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This whole method will be skipped during dynamic task mapping.</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_trigger_args</span><span class="o">.</span><span class="n">trigger_kwargs</span> <span class="o">=</span> <span class="n">trigger_kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_from_trigger</span> <span class="o">=</span> <span class="n">start_from_trigger</span>

    <span class="k">def</span> <span class="nf">execute_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># We have no more work to do here. Mark as complete.</span>
        <span class="k">return</span>
</code></pre></div>
<p>When defining the task, you need to pass <code>start_from_trigger</code> or <code>trigger_kwargs</code> to the <code>partial</code>, <code>expand</code>, or <code>expand_kwargs</code> method. The name needs to be precisely the same.</p>
<div class="highlight"><pre><span></span><code><span class="n">wait_hours_task</span> <span class="o">=</span> <span class="n">WaitHoursSensor</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">task_id</span><span class="o">=</span><span class="s2">"wait_for_n_hours"</span><span class="p">,</span> <span class="n">start_from_trigger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span>
    <span class="n">trigger_kwargs</span><span class="o">=</span><span class="p">[{</span><span class="s2">"hours"</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s2">"hours"</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>
<span class="p">)</span>
</code></pre></div>
<p>The entire <code>__init__</code> method will be disregarded before the task starts. The scheduler uses the values provided in these methods and saves them as a trigger row in the metadata database for the triggerer to pick up. Once the task is finished in the triggerer, it goes back to the scheduler and then gets assigned to a worker to execute the next method. <em>The <code>__init__</code> method will be run before the next method is executed.</em></p>
<script type="module">
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.esm.min.mjs';
    mermaid.initialize({ startOnLoad: true });
</script>
</section>
<section class="post-footer">
<div class="post-share">
<span class="post-info-label">Share</span>
<a aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=Dynamic task mapping on operators that can start execution from trigger  - This is not the feature you're looking for&amp;url=https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter">
<i aria-hidden="true" class="icon icon-twitter"></i><span class="hidden">Twitter</span>
</a>
<a aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Facebook">
<i aria-hidden="true" class="icon icon-facebook"></i><span class="hidden">Facebook</span>
</a>
<a aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger&amp;title=Dynamic task mapping on operators that can start execution from trigger" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720');return false;" title="LinkedIn">
<i aria-hidden="true" class="icon icon-linkedin"></i><span class="hidden">LinkedIn</span>
</a>
<a aria-label="Email" class="email" href="mailto:?subject=Dynamic task mapping on operators that can start execution from trigger&amp;body=https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" title="Email">
<i aria-hidden="true" class="icon icon-mail"></i><span class="hidden">Email</span>
</a>
<div class="clear"></div>
</div>
<aside class="post-tags">
<a href="https://blog.wei-lee.me/tag/python.html">Python</a><a href="https://blog.wei-lee.me/tag/airflow.html">Airflow</a><a href="https://blog.wei-lee.me/tag/airflow-210.html">Airflow 2.10</a> </aside>
<div class="clear"></div>
<div class="series">
<p>This post is part 4 of the "What If...? Running Airflow Tasks without the workers" series:</p>
<ol class="parts">
<li>
<a href="https://blog.wei-lee.me/posts/tech/2024/06/starts-execution-directly-from-triggerer-without-going-to-worker">Starts Airflow task execution directly from the triggerer</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2024/08/enhancing-airflow-task-execution-with-start-trigger-args">Enhancing Airflow Task Execution with StartTriggerArgs</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2024/08/serialize-start-trigger-args">Serialize StartTriggerArgs - That's not how Airflow serialization works!</a>
</li>
<li class="active">
<a href="https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger">Dynamic task mapping on operators that can start execution from trigger - This is not the feature you're looking for</a>
</li>
</ol>
</div>
</section>
<script type="text/javascript">var use_utterance = true;</script>
<section class="post-comments">
<script async="" crossorigin="anonymous" data-issue-term="https://blog.wei-lee.me/posts/tech/2024/08/dynamic-task-mapping-on-operators-that-can-start-execution-from-trigger" data-label="blog-comment" data-repo="Lee-W/main-blog" data-theme="github-light" src="https://utteranc.es/client.js">
</script>
</section>
<aside class="post-nav">
<div class="clear"></div>
</aside>
</div>
</article>
</main>
<div class="nav-footer">
<nav aria-label="Footer" class="nav-wrapper">
<span class="nav-copy">Those aren't written down are meant to be forgotten ¬© 2023
          <a class="nav-rss" href="https://blog.wei-lee.me/feeds/all.atom.xml" target="_blank" title="RSS"><i class="icon icon-rss"></i></a>
</span>
<span class="nav-credits">



          Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a> ‚Ä¢ Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a> ‚Ä¢
          <a class="menu-item js-theme" data-dark="Dark theme" data-light="Light theme" data-system="System theme" href="#">
<span class="theme-icon"></span><span class="theme-text">System theme</span>
</a>
</span>
</nav>
</div>
</section>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<!-- TODO: minify -->
<script src="https://blog.wei-lee.me/theme/js/jquery.fitvids.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/script.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/clipboard.min.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/copy-to-clipboard.js" type="text/javascript"></script>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3J7XQ46QH5"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3J7XQ46QH5', { 'anonymize_ip': true });
    </script>
<script src="/pagefind/pagefind-ui.js"></script>
<script>
      window.addEventListener('DOMContentLoaded', (event) => {
          new PagefindUI({
              element: "#search",
              showImages: false,
          });
      });
  </script>
<!-- 	The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in article.html, but it needs to be included down here, after jQuery has already loaded. -->
<!-- Add MathJax and FontAwesome for Asciidoc -->\
<script>
  $(document).ready(function () {
    var viewport = $(window);
    var post = $('.post-content');
    // Responsive videos with fitVids
    post.fitVids();

    var mdSelector=".highlight pre code";
    var rstSelector=".highlight pre code";
    // For ":source-highlighter: highlight.js`" in asciidoc
    var adocSelector="pre.highlight > code[data-lang]"
    var selector=mdSelector;
    // Format code blocks and add line numbers
    function codestyling() {
      $(selector).each(function(i, e) {
        // Code highlight
        hljs.highlightElement(e);
        // No lines for plain text blocks
        if (!$(this).hasClass('language-text')) {
          var code = $(this);
          // Calculate amount of lines
          var lines = code.html().split(/\n(?!$)/g).length;
          var numbers = [];
          if (lines > 1) {
            lines++;
          }
          for (i = 1; i < lines; i++) {
            numbers += '<span class="line" aria-hidden="true">' + i + '</span>';
          }
          code.parent().append('<div class="lines">' + numbers + '</div>');
        }
      });
    }

    // Format code blocks only
    function codestylingWithoutLineNumbers() {
      $(selector).each(function(i, e) {
        // Code highlight
        hljs.highlightElement(e);
      });
    }

    codestylingWithoutLineNumbers();
    // Reading progress bar on window top
    function readingProgress() {
      var postBottom = post.offset().top + post.height();
      var viewportHeight = viewport.height();
      var progress = 100 - (((postBottom - (viewport.scrollTop() + viewportHeight) + viewportHeight / 3) / (postBottom - viewportHeight + viewportHeight / 3)) * 100);
      $('.progress-bar').css('width', progress + '%');
      (progress > 100) ? $('.progress-container').addClass('complete'): $('.progress-container').removeClass('complete');
    }
    readingProgress();
    // Trigger reading progress
    viewport.on({
      'scroll': function() {
        readingProgress();
      },
      'resize': function() {
        readingProgress();
      },
      'orientationchange': function() {
        readingProgress();
      }
    });

  });
</script>
</body>
</html>
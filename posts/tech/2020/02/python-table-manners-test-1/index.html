
<!DOCTYPE html>

<html lang="zh-tw">
<head>
<meta charset="utf-8"/>
<meta charset="utf-8" content="text/html" http-equiv="Content-Type">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>Python Table Manners - 測試 (一) </title>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="origin" name="referrer"/>
<meta content="Pelican" name="generator"/>
<link href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1" rel="canonical"/>
<!-- Feed -->
<link href="https://blog.wei-lee.me/feeds/all.atom.xml" rel="alternate" title="Those aren't written down are meant to be forgotten Full Atom Feed" type="application/atom+xml"/>
<!-- TODO: combine -->
<link href="https://blog.wei-lee.me/theme/css/style.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pygments.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pagefind-ui-custom.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code-copy.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/pagefind/pagefind-ui.css" rel="stylesheet"/>
<!-- Custom fonts -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"/>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
<script>
    var siteUrl = 'https://blog.wei-lee.me';
  </script>
<script>
    var localTheme = localStorage.getItem('attila_theme');
    switch (localTheme) {
      case 'dark':
        document.documentElement.classList.add('theme-dark');
        break;
      case 'light':
        document.documentElement.classList.add('theme-light');
        break;
      default:
        break;
    }
  </script>
<meta content="設定完環境後，接著開始要開發程式的各項功能 要驗證程式正確性時，我們就會撰寫測試案例" name="description"/>
<meta content="Wei Lee" name="author"/>
<meta content="Python" name="tags"/>
<meta content="Test" name="tags"/>
<!-- Open Graph -->
<meta content="Those aren't written down are meant to be forgotten" prefix="og: http://ogp.me/ns#" property="og:site_name">
<meta content="Python Table Manners - 測試 (一) " prefix="og: http://ogp.me/ns#" property="og:title">
<meta content="設定完環境後，接著開始要開發程式的各項功能 要驗證程式正確性時，我們就會撰寫測試案例" prefix="og: http://ogp.me/ns#" property="og:description">
<meta content="zh-tw" prefix="og: http://ogp.me/ns#" property="og:locale">
<meta content="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1" prefix="og: http://ogp.me/ns#" property="og:url"/>
<meta content="article" prefix="og: http://ogp.me/ns#" property="og:type"/>
<meta content="2020-02-24 23:33:00+08:00" prefix="og: http://ogp.me/ns#" property="article:published_time"/>
<meta content="2020-10-04 15:33:00+08:00" prefix="og: http://ogp.me/ns#" property="article:modified_time"/>
<meta content="https://blog.wei-lee.me/author/wei-lee.html" prefix="og: http://ogp.me/ns#" property="article:author"/>
<meta content="Tech" prefix="og: http://ogp.me/ns#" property="article:section">
<meta content="Python" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="Test" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="https://blog.wei-lee.me//images/cover.jpeg" prefix="og: http://ogp.me/ns#" property="og:image"/>
<!-- Twitter Card -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="@clleew" name="twitter:site"/>
<meta content="Python Table Manners - 測試 (一) " name="twitter:title"/>
<meta content="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1" name="twitter:url"/>
<meta content="https://blog.wei-lee.me//images/cover.jpeg" name="twitter:image:src"/>
<meta content="設定完環境後，接著開始要開發程式的各項功能 要驗證程式正確性時，我們就會撰寫測試案例" name="twitter:description"/>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Python Table Manners - 測試 (一)",
  "headline": "Python Table Manners - 測試 (一)",
  "datePublished": "2020-02-24 23:33:00+08:00",
  "dateModified": "2020-10-04 15:33:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Wei Lee",
    "url": "https://blog.wei-lee.me/author/wei-lee.html"
  },
  "image": "https://blog.wei-lee.me//images/cover.jpeg",
  "url": "https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1",
  "description": "設定完環境後，接著開始要開發程式的各項功能 要驗證程式正確性時，我們就會撰寫測試案例"
}
</script>
</meta></meta></meta></meta></meta></link></meta><link href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Those aren't written down are meant to be forgotten", "item": "https://blog.wei-lee.me"}, {"@type": "ListItem", "position": 2, "name": "Posts", "item": "https://blog.wei-lee.me/posts"}, {"@type": "ListItem", "position": 3, "name": "Tech", "item": "https://blog.wei-lee.me/posts/tech"}, {"@type": "ListItem", "position": 4, "name": "2020", "item": "https://blog.wei-lee.me/posts/tech/2020"}, {"@type": "ListItem", "position": 5, "name": "02", "item": "https://blog.wei-lee.me/posts/tech/2020/02"}, {"@type": "ListItem", "position": 6, "name": "Python table manners test 1", "item": "https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1"}, {"@type": "ListItem", "position": 7, "name": "Index", "item": "https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Wei Lee"}, "publisher": {"@type": "Organization", "name": "Those aren't written down are meant to be forgotten"}, "headline": "Python Table Manners - 測試 (一)", "about": "Tech", "datePublished": "2020-02-24 23:33"}</script></head>
<body class="category-template">
<div class="nav-header">
<nav aria-label="Main" class="nav-wrapper">
<ul>
<li class="nav-🏠 Home" role="presentation"><a href="/"><span>🏠 Home</span></a></li>
<li class="nav-About Me" role="presentation"><a href="/pages/about-me.html"><span>About Me</span></a></li>
<li class="nav-👨‍💻 Tech active" role="presentation"><a href="/category/tech.html"><span>👨‍💻 Tech</span></a></li>
<li class="nav-📚 Book Digest" role="presentation"><a href="/category/book.html"><span>📚 Book Digest</span></a></li>
<li class="nav-💬 Gossiping" role="presentation"><a href="/category/gossiping.html"><span>💬 Gossiping</span></a></li>
<li class="nav-🗄️ Archives" role="presentation"><a href="/archives.html"><span>🗄️ Archives</span></a></li>
<li class="nav-📚 Series" role="presentation"><a href="/series_list.html"><span>📚 Series</span></a></li>
<li class="nav-🔍 Search" role="presentation"><a href="/search.html"><span>🔍 Search</span></a></li>
</ul>
<ul class="nav-meta">
<li class="nav-linkedin"><a aria-label="Linkedin" href="https://tw.linkedin.com/in/clleew" target="_blank"><i aria-hidden="true" class="icon icon-linkedin"></i>
<span>Linkedin</span>
</a></li>
<li class="nav-github"><a aria-label="Github" href="https://github.com/Lee-W" target="_blank"><i aria-hidden="true" class="icon icon-github"></i>
<span>GitHub</span>
</a></li>
<li class="nav-twitter"><a aria-label="Twitter" href="https://twitter.com/clleew" target="_blank"><i aria-hidden="true" class="icon icon-twitter"></i>
<span>Twitter</span>
</a></li>
<li class="nav-search" style="display: none;">
<a title="Search">
<i aria-hidden="true" class="icon icon-search"></i>
<span>Search</span>
</a>
</li>
</ul> </nav>
<div class="nav-wrapper-control">
<div class="inner">
<a class="nav-menu" role="button"><i aria-hidden="true" class="icon icon-menu"></i>Menu</a>
<a class="nav-search" role="button" style="display: none;" title="Search"><i aria-hidden="true" class="icon icon-search"></i></a>
</div>
</div>
</div>
<div aria-label="Close" class="nav-close" role="button"></div>
<section class="page-wrapper" id="wrapper">
<!-- Progressbar -->
<div class="progress-container">
<span class="progress-bar"></span>
</div>
<!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="post-header has-cover">
<div class="inner">
<span class="post-info">
<span class="post-type">Article</span>
<span class="post-count">Tech</span>
</span>
<h1 class="post-title">
            Python Table Manners - 測試 (一)
        </h1>
<div class="post-meta">
<div class="post-meta-avatars">
<figure class="post-meta-avatar avatar">
<a class="author-avatar" href="https://blog.wei-lee.me/author/wei-lee.html">
<img alt="Wei Lee" class="author-profile-image" src="https://blog.wei-lee.me//images/avatar.jpeg"/>
</a>
</figure>
</div>
<h4 class="post-meta-author">
            Wei Lee
          </h4>
<time datetime="2020/02/24 - Mon">2020/02/24 - Mon</time>
          • <time datetime="2020/10/04 - Sun"> Updated on 2020/10/04 - Sun</time>
          • 3 min read
        </div>
<div class="post-cover cover">
<img alt="Category Tech" src="https://blog.wei-lee.me//images/cover.jpeg"/>
</div>
</div>
</header>
<!-- Post content -->
<main class="content" data-pagefind-body="" role="main">
<article class="post">
<div class="inner">
<section class="post-content">
<p>設定完環境後，接著開始要開發程式的各項功能<br/>
要驗證程式正確性時，我們就會撰寫測試案例</p>
<!--more-->
<div class="toc">
<ul>
<li><a href="#_1">為什麼要寫自動化測試</a></li>
<li><a href="#unittest">unittest</a></li>
<li><a href="#pytest">pytest</a></li>
<li><a href="#unittest-pytest">從 Unittest 到 Pytest</a><ul>
<li><a href="#test-discovery">測試探索 (test discovery)</a></li>
<li><a href="#step-0">Step 0: 追朔程式碼</a></li>
<li><a href="#step-1-fixture-setup-teardown">Step 1: 使用 fixture 取代 setUp / tearDown</a></li>
<li><a href="#step-2-markskip">Step 2: 使用 mark.skip 跳過部分測試</a></li>
<li><a href="#step-3-class">Step 3: 扁平化 - 移除不必要的 class</a></li>
</ul>
</li>
<li><a href="#reference">Reference</a></li>
</ul>
</div>
<h2 id="_1">為什麼要寫自動化測試</h2>
<ul>
<li>如果沒有自動化測試<ul>
<li>必須手動去驗證程式的正確性，而且不能確定每次的測試方式都是相同的<br/>
 （如果因為很麻煩懶得測試，變成讓客戶去測試，就會造成更多的麻煩了 😱）</li>
<li>增加重構 (refactoring）的風險，因為很難驗證程式的功能有沒有在重構的過程中被改動</li>
<li>加入新的功能不知道會不會動到原本沒問題的功能</li>
</ul>
</li>
</ul>
<p>最後就會像是這樣</p>
<p><img alt="new-feature-without-test" src="/images/posts-image/2020-02-22-python-table-manner-series/new-feature.jpg"/></p>
<p><strong>總之，要寫測試！</strong></p>
<h2 id="unittest">unittest</h2>
<p><a href="https://docs.python.org/3/library/unittest.html">unittest</a> 是 Python 標準函式庫的測試框架<br/>
起源於 jUnit 的做法，所以在函式的命名上和設計上比較不符合 Python 風格<br/>
雖然它不會是今天的主角，我也不太建議使用它<br/>
不過我們還是可以稍微看一下它的用法</p>
<p>以下取自 <a href="https://docs.python.org/3/library/unittest.html">unittest</a> 文件中的其中一個範例</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">unittest</span>


<span class="k">class</span> <span class="nc">WidgetTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">Widget</span><span class="p">(</span><span class="s2">"The widget"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_default_widget_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="s2">"incorrect default size"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_widget_resize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">),</span> <span class="s2">"wrong size after resize"</span><span class="p">)</span>
</code></pre></div>
<p>可以看到幾個特點</p>
<ul>
<li>測試案例必須要繼承 <code>unittest.TestCase</code></li>
<li>使用 <code>setUp</code> 函式來初始化 <code>widget</code> （如果有需要清除資源則會使用 <code>tearDown</code>）</li>
<li>使用 <code>assertEqual</code> 來做正確性的驗證</li>
</ul>
<h2 id="pytest">pytest</h2>
<p><a href="https://docs.pytest.org/en/6.1.1/">pytest</a> 是現在 Python 專案建議使用的測試框架，也會是這篇文章的主角</p>
<ul>
<li>為什麼要用 pytest<ul>
<li>更符合 Python 程式碼風格 (Pythonic)</li>
<li>pytest 支援舊有的 unittest 風格</li>
<li>扁平化（不用繼承）</li>
<li>只需要使用 <code>assert</code>，不需要去記 <code>assert.+</code> (e.g., <code>assertEqual</code>) 等 API</li>
<li>更好的<a href="https://docs.pytest.org/en/6.1.1/goodpractices.html#test-discovery">測試探索 (test discovery)</a></li>
<li>更多的進階功能 (e.g., fixture, mark, parameterize and etc.)</li>
<li>強大的套件</li>
</ul>
</li>
</ul>
<p>以下是取自 <a href="https://docs.pytest.org/en/6.1.1/getting-started.html#create-your-first-test">pytest - Create your first test</a> 的範例<br/>
相比於 unittest 寫法相對簡潔</p>
<div class="highlight"><pre><span></span><code><span class="c1"># content of test_sample.py</span>
<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">test_answer</span><span class="p">():</span>
    <span class="k">assert</span> <span class="n">func</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span>
</code></pre></div>
<h2 id="unittest-pytest">從 Unittest 到 Pytest</h2>
<p>前面的比較其實不太公平，unittest 的範例要測的內容本身就比 pytest 的複雜</p>
<p>所以接下來會用 <a href="https://github.com/pycontw/pycontw-postevent-report-generator">pycontw-postevent-report-generator</a> 為例子<br/>
討論如何從 <a href="https://github.com/pycontw/pycontw-postevent-report-generator/tree/v1.0">v1.0</a> 的 unittest 風格改成在 <a href="https://github.com/pycontw/pycontw-postevent-report-generator/commit/83e48c6443303045ed1de2f020297c3110bb1300">commit 83e4</a> 的 pytest 風格</p>
<p>如果想跟著程式碼跑，可以把專案 clone 下來<br/>
（當然能貢獻專案就更棒了 XD）</p>
<div class="highlight"><pre><span></span><code><span class="c1"># clone 專案到本地</span>
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/pycontw/pycontw-postevent-report-generator

<span class="nb">cd</span><span class="w"> </span>pycontw-postevent-report-generator

<span class="c1"># 切換到 commit 83e4 的前一個 commit (因為commit 83e4 已經完成修正)</span>
git<span class="w"> </span>checkout<span class="w"> </span>83e4~1

<span class="c1"># 設定環境</span>
pipenv<span class="w"> </span>install<span class="w"> </span>--dev
</code></pre></div>
<h3 id="test-discovery">測試探索 (test discovery)</h3>
<p>原本在 <code>README.md</code> 中要跑測試的指令相當的冗長<br/>
而且還必須要切換到 test 資料夾 (i.e., <code>cd test</code>)</p>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span><span class="nb">test</span>
python<span class="w"> </span>-m<span class="w"> </span>unittest<span class="w"> </span>discover<span class="w"> </span>-s<span class="w"> </span>./<span class="w"> </span>-p<span class="w"> </span><span class="s1">'test_*.py'</span>
</code></pre></div>
<p>不過這其實是一開始的設計有誤<br/>
以下是 test 資料夾的內容</p>
<div class="highlight"><pre><span></span><code>└── test
    …
    ├── test_sponsor.py
    └── test_title.py
</code></pre></div>
<p>test (或 tests) 本身也必須是一個套件<br/>
所以必須先在 test 內加入 <code>__init__.py</code><br/>
（這是我在寫程式初期想開始寫測試遇到一個很大的坎 😢）</p>
<div class="highlight"><pre><span></span><code>└── test
    ├── __init__.py
    ...
    ├── test_sponsor.py
    └── test_title.py
</code></pre></div>
<p>做了改變後，就能改用更簡潔的指令跑測試了</p>
<div class="highlight"><pre><span></span><code>python<span class="w"> </span>-m<span class="w"> </span>unittest
</code></pre></div>
<p>因為 pytest 也支援 unittest 風格<br/>
所以也可以直接使用 <code>pytest</code> 指令跑測試</p>
<div class="highlight"><pre><span></span><code>pytest
</code></pre></div>
<p>不過在前一篇有提到使用虛擬環境的概念了<br/>
所以應該要確保每個專案的指令，都只在虛擬環境中跑<br/>
（因為前一篇建議使用 pipenv，之後的範例都會用 pipenv）</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 將 pytest 安裝到開發環境</span>
pipenv<span class="w"> </span>install<span class="w"> </span>pytest<span class="w"> </span>--dev

<span class="c1"># 執行 pytest</span>
pipenv<span class="w"> </span>run<span class="w"> </span>pytest
</code></pre></div>
<p>這時候的測試其實會有許多錯誤<br/>
但執行後應該要能看到類似的畫面</p>
<div class="highlight"><pre><span></span><code>===================== test session starts ======================
platform darwin -- Python 3.7.3, pytest-5.3.5, py-1.8.1, pluggy-0.13.1
rootdir: /....../pycontw-postevent-report-generator
plugins: mock-2.0.0, cov-2.8.1
collected 9 items

test/test_sponsor.py FFFFFFFF                            [ 88%]
test/test_title.py F                                     [100%]

=========================== FAILURES ===========================
......
</code></pre></div>
<p><code>F</code> 表示測試沒有通過，如果出現 <code>.</code> 則表示成功</p>
<h3 id="step-0">Step 0: 追朔程式碼</h3>
<p>以 <a href="https://github.com/pycontw/pycontw-postevent-report-generator/blob/v1.0/test/test_sponsor.py#L6">test/test_sponsor.py::TestSponsor::test_sponsor_number</a> 為例<br/>
（在套件以及模組的層級後， pytest 會使用 <code>::</code> 來區別不同的層級，試試 <code>pipenv run pytest -v</code> 指令）</p>
<p>原本 unittest 風格的程式碼中，做了三件事</p>
<ol>
<li>使用了 <code>setUp</code> 做 <code>self.sponsors</code> 的初始化</li>
<li>在 <code>test_sonpsor_number</code> 取用 <code>setUp</code> 中初始過的 <code>self.sponsors</code></li>
<li>使用 <code>self.assertEqual</code> 來看 <code>self.sponsors</code> 的長度是否等於 1</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">atta.partner</span> <span class="kn">import</span> <span class="n">sponsor</span>


<span class="k">class</span> <span class="nc">TestSponsor</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sponsors</span> <span class="o">=</span> <span class="n">sponsor</span><span class="o">.</span><span class="n">get_all_sponsors</span><span class="p">(</span><span class="s2">"./data/packages.yaml"</span><span class="p">,</span> <span class="s2">"./data/sponsors.yaml"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sponsors</span> <span class="o">=</span> <span class="n">sponsors</span>

        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_sponsor_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sponsors</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="o">...</span>
</code></pre></div>
<h3 id="step-1-fixture-setup-teardown">Step 1: 使用 fixture 取代 setUp / tearDown</h3>
<p>將 <code>unittest.TestCase</code> 移除，改用 pytest 的 <a href="https://docs.pytest.org/en/6.1.1/fixture.html">fixture</a> 取代 <code>setUp</code><br/>
fixture 跟 <code>setUp / tearDown</code> 的概念上相近，都是用來 準備 / 清除 資源<br/>
但 fixture 更加的輕量且更有彈性</p>
<p>在 <code>test_sponsor_number</code> 中加入參數 <code>sponsors</code><br/>
pytest 會去找 fixtures 中是否有 <code>sponsors</code> 並將之代入</p>
<p>接著將較為冗長的 <code>assertEqual</code>，改為 <code>assert</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">report_generator.partner</span> <span class="kn">import</span> <span class="n">sponsor</span>


<span class="k">class</span> <span class="nc">TestSponsor</span><span class="p">:</span>
    <span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"class"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">sponsors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">sponsor</span><span class="o">.</span><span class="n">get_all_sponsors</span><span class="p">(</span><span class="s2">"test/data/packages.yaml"</span><span class="p">,</span> <span class="s2">"test/data/sponsors.yaml"</span><span class="p">)</span>

        <span class="o">...</span>

    <span class="k">def</span> <span class="nf">test_sponsor_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sponsors</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sponsors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="o">...</span>
</code></pre></div>
<p>(p.s. 在這裡 <code>atta</code> 已經重新命名為 <code>report_generator</code>)</p>
<h3 id="step-2-markskip">Step 2: 使用 mark.skip 跳過部分測試</h3>
<p>原本的測試中有些邏輯錯誤<br/>
但我只想先完成風格的轉換，還不打算修正<br/>
因此先使用了 <a href="http://doc.pytest.org/en/6.1.1/example/markers.html">markers</a><br/>
在想跳過的測試案例前面加上 <code>@pytest.mark.skip</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">report_generator.partner</span> <span class="kn">import</span> <span class="n">sponsor</span>


<span class="k">class</span> <span class="nc">TestSponsor</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="s2">"No bronze sponsor in test case"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_sponsor_promotion_web_click_rank_bronze</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="n">sponsor</span><span class="o">.</span><span class="n">NA_CONTENT_MESSAGE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bronze_sponsor</span><span class="o">.</span><span class="n">web_click_rank</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>
</code></pre></div>
<p>執行 <code>pipenv run pytest</code> 後，就會發現有部分的測試案例變成了 <code>s</code></p>
<div class="highlight"><pre><span></span><code>========== test session starts ==========
platform darwin -- Python 3.7.3, pytest-5.3.5, py-1.8.1, pluggy-0.13.1
rootdir: /....../pycontw-postevent-report-generator
plugins: mock-2.0.0, cov-2.8.1
collected 9 items

test/test_sponsor.py ....ssss     [ 88%]
test/test_title.py .              [100%]
</code></pre></div>
<h3 id="step-3-class">Step 3: 扁平化 - 移除不必要的 class</h3>
<p>從上面的範例可以看到， <code>self</code> 其實並不必要<br/>
這些測試案例不需要是一個類別<br/>
因此可以更近一步，把 <code>TestSponsor</code> 類別移除</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">report_generator.partner</span> <span class="kn">import</span> <span class="n">sponsor</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">sponsors</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">sponsor</span><span class="o">.</span><span class="n">get_all_sponsors</span><span class="p">(</span><span class="s2">"test/data/packages.yaml"</span><span class="p">,</span> <span class="s2">"test/data/sponsors.yaml"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sponsor_number</span><span class="p">(</span><span class="n">sponsors</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sponsors</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</code></pre></div>
<p>不過這並不代表用類別就是錯的<br/>
一般我會在模組內測試案例比較多的時候，使用類別來將相似的測試案例歸在同一類</p>
<hr/>
<p>因為篇幅的關係，我決定把測試分成兩篇文章<br/>
<del>絕對不是因為我寫不完了</del><br/>
盡請期待明天更深入的 pytest 應用 😄</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://pragprog.com/book/bopytest/python-testing-with-pytest">Python Testing with pytest</a><ul>
<li>非常推薦用這本書上手 <code>pytest</code></li>
</ul>
</li>
<li><a href="https://www.youtube.com/watch?time_continue=201&amp;v=pX1_I_sEi8k">快快樂樂成為 Coding Ninja (by pytest) - PyCon APAC 2015</a></li>
<li><a href="https://wei-lee.me/pycon-note/posts/swiss-python-summit-2016/2019/11/pytest-rapid-simple-testing/">Pytest: Rapid Simple Testing -  Swiss Python Summit 2016</a></li>
</ul>
</section>
<section class="post-footer">
<div class="post-share">
<span class="post-info-label">Share</span>
<a aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=Python Table Manners - 測試 (一) &amp;url=https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter">
<i aria-hidden="true" class="icon icon-twitter"></i><span class="hidden">Twitter</span>
</a>
<a aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Facebook">
<i aria-hidden="true" class="icon icon-facebook"></i><span class="hidden">Facebook</span>
</a>
<a aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1&amp;title=Python Table Manners - 測試 (一)" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720');return false;" title="LinkedIn">
<i aria-hidden="true" class="icon icon-linkedin"></i><span class="hidden">LinkedIn</span>
</a>
<a aria-label="Email" class="email" href="mailto:?subject=Python Table Manners - 測試 (一)&amp;body=https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1" title="Email">
<i aria-hidden="true" class="icon icon-mail"></i><span class="hidden">Email</span>
</a>
<div class="clear"></div>
</div>
<aside class="post-tags">
<a href="https://blog.wei-lee.me/tag/python.html">Python</a><a href="https://blog.wei-lee.me/tag/test.html">Test</a> </aside>
<div class="clear"></div>
<div class="series">
<p>This post is part 3 of the "Python Table Manners" series:</p>
<ol class="parts">
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-series">Python Table Manners 系列</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-dependency-mangement">Python Table Manners - 虛擬環境和套件管理</a>
</li>
<li class="active">
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1">Python Table Manners - 測試 (一)</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2">Python Table Manners - 測試 (二)</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-coding-style">Python Table Manners - 程式碼風格</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-manage-trivial-tasks">Python Table Manners - 管理繁瑣任務</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-pre-commit">Python Table Manners - pre-commit: git commit 前做完檢查</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/03/python-table-manners-commitizen">Python Table Manners - Commitizen: 規格化 commit message</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/03/python-table-manners-security">Python Table Manners - 安全性檢查</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/04/python-table-manners-documentation">Python Table Manners - 文件</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/12/python-table-manner-continuous-integration">Python Table Manners - 持續整合/部署</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2021/01/python-table-manners-cookiecutter">Python Table Manners - Cookiecutter 專案模板</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2021/01/python-table-manner-editor">Python Table Manners 番外 - 編輯器</a>
</li>
</ol>
</div>
</section>
<script type="text/javascript">var use_utterance = true;</script>
<section class="post-comments">
<script async="" crossorigin="anonymous" data-issue-term="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1" data-label="blog-comment" data-repo="Lee-W/main-blog" data-theme="github-light" src="https://utteranc.es/client.js">
</script>
</section>
<aside class="post-nav">
<div class="clear"></div>
</aside>
</div>
</article>
</main>
<div class="nav-footer">
<nav aria-label="Footer" class="nav-wrapper">
<span class="nav-copy">Those aren't written down are meant to be forgotten © 2023
          <a class="nav-rss" href="https://blog.wei-lee.me/feeds/all.atom.xml" target="_blank" title="RSS"><i class="icon icon-rss"></i></a>
</span>
<span class="nav-credits">



          Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a> • Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a> •
          <a class="menu-item js-theme" data-dark="Dark theme" data-light="Light theme" data-system="System theme" href="#">
<span class="theme-icon"></span><span class="theme-text">System theme</span>
</a>
</span>
</nav>
</div>
</section>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<!-- TODO: minify -->
<script src="https://blog.wei-lee.me/theme/js/jquery.fitvids.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/script.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/clipboard.min.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/copy-to-clipboard.js" type="text/javascript"></script>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3J7XQ46QH5"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3J7XQ46QH5', { 'anonymize_ip': true });
    </script>
<script src="/pagefind/pagefind-ui.js"></script>
<script>
      window.addEventListener('DOMContentLoaded', (event) => {
          new PagefindUI({
              element: "#search",
              showImages: false,
          });
      });
  </script>
<!-- 	The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in article.html, but it needs to be included down here, after jQuery has already loaded. -->
<script>
  $(document).ready(function () {
    var viewport = $(window);
    var post = $('.post-content');
    // Responsive videos with fitVids
    post.fitVids();

    // Reading progress bar on window top
    function readingProgress() {
      var postBottom = post.offset().top + post.height();
      var viewportHeight = viewport.height();
      var progress = 100 - (((postBottom - (viewport.scrollTop() + viewportHeight) + viewportHeight / 3) / (postBottom - viewportHeight + viewportHeight / 3)) * 100);
      $('.progress-bar').css('width', progress + '%');
      (progress > 100) ? $('.progress-container').addClass('complete'): $('.progress-container').removeClass('complete');
    }
    readingProgress();
    // Trigger reading progress
    viewport.on({
      'scroll': function() {
        readingProgress();
      },
      'resize': function() {
        readingProgress();
      },
      'orientationchange': function() {
        readingProgress();
      }
    });

  });
</script>
</body>
</html>
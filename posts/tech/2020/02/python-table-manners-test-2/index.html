
<!DOCTYPE html>

<html lang="zh-tw">
<head>
<meta charset="utf-8"/>
<meta charset="utf-8" content="text/html" http-equiv="Content-Type">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>Python Table Manners - 測試 (二) </title>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="origin" name="referrer"/>
<meta content="Pelican" name="generator"/>
<link href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2" rel="canonical"/>
<!-- Feed -->
<link href="https://blog.wei-lee.me/feeds/all.atom.xml" rel="alternate" title="Those aren't written down are meant to be forgotten Full Atom Feed" type="application/atom+xml"/>
<!-- TODO: combine -->
<link href="https://blog.wei-lee.me/theme/css/style.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pygments.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pagefind-ui-custom.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code-copy.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/pagefind/pagefind-ui.css" rel="stylesheet"/>
<!-- Custom fonts -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"/>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
<script>
    var siteUrl = 'https://blog.wei-lee.me';
  </script>
<script>
    var localTheme = localStorage.getItem('attila_theme');
    switch (localTheme) {
      case 'dark':
        document.documentElement.classList.add('theme-dark');
        break;
      case 'light':
        document.documentElement.classList.add('theme-light');
        break;
      default:
        break;
    }
  </script>
<meta content="接續前一篇提到的 pytest，繼續看它的其他功能吧" name="description"/>
<meta content="Wei Lee" name="author"/>
<meta content="Python" name="tags"/>
<meta content="Test" name="tags"/>
<!-- Open Graph -->
<meta content="Those aren't written down are meant to be forgotten" prefix="og: http://ogp.me/ns#" property="og:site_name">
<meta content="Python Table Manners - 測試 (二) " prefix="og: http://ogp.me/ns#" property="og:title">
<meta content="接續前一篇提到的 pytest，繼續看它的其他功能吧" prefix="og: http://ogp.me/ns#" property="og:description">
<meta content="zh-tw" prefix="og: http://ogp.me/ns#" property="og:locale">
<meta content="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2" prefix="og: http://ogp.me/ns#" property="og:url"/>
<meta content="article" prefix="og: http://ogp.me/ns#" property="og:type"/>
<meta content="2020-02-25 18:05:00+08:00" prefix="og: http://ogp.me/ns#" property="article:published_time"/>
<meta content="2020-10-04 15:46:00+08:00" prefix="og: http://ogp.me/ns#" property="article:modified_time"/>
<meta content="https://blog.wei-lee.me/author/wei-lee.html" prefix="og: http://ogp.me/ns#" property="article:author"/>
<meta content="Tech" prefix="og: http://ogp.me/ns#" property="article:section">
<meta content="Python" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="Test" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="https://blog.wei-lee.me//images/cover.jpeg" prefix="og: http://ogp.me/ns#" property="og:image"/>
<!-- Twitter Card -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="@clleew" name="twitter:site"/>
<meta content="Python Table Manners - 測試 (二) " name="twitter:title"/>
<meta content="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2" name="twitter:url"/>
<meta content="https://blog.wei-lee.me//images/cover.jpeg" name="twitter:image:src"/>
<meta content="接續前一篇提到的 pytest，繼續看它的其他功能吧" name="twitter:description"/>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Python Table Manners - 測試 (二)",
  "headline": "Python Table Manners - 測試 (二)",
  "datePublished": "2020-02-25 18:05:00+08:00",
  "dateModified": "2020-10-04 15:46:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Wei Lee",
    "url": "https://blog.wei-lee.me/author/wei-lee.html"
  },
  "image": "https://blog.wei-lee.me//images/cover.jpeg",
  "url": "https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2",
  "description": "接續前一篇提到的 pytest，繼續看它的其他功能吧"
}
</script>
</meta></meta></meta></meta></meta></link></meta><link href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Those aren't written down are meant to be forgotten", "item": "https://blog.wei-lee.me"}, {"@type": "ListItem", "position": 2, "name": "Posts", "item": "https://blog.wei-lee.me/posts"}, {"@type": "ListItem", "position": 3, "name": "Tech", "item": "https://blog.wei-lee.me/posts/tech"}, {"@type": "ListItem", "position": 4, "name": "2020", "item": "https://blog.wei-lee.me/posts/tech/2020"}, {"@type": "ListItem", "position": 5, "name": "02", "item": "https://blog.wei-lee.me/posts/tech/2020/02"}, {"@type": "ListItem", "position": 6, "name": "Python table manners test 2", "item": "https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2"}, {"@type": "ListItem", "position": 7, "name": "Index", "item": "https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Wei Lee"}, "publisher": {"@type": "Organization", "name": "Those aren't written down are meant to be forgotten"}, "headline": "Python Table Manners - 測試 (二)", "about": "Tech", "datePublished": "2020-02-25 18:05"}</script></head>
<body class="category-template">
<div class="nav-header">
<nav aria-label="Main" class="nav-wrapper">
<ul>
<li class="nav-🏠 Home" role="presentation"><a href="/"><span>🏠 Home</span></a></li>
<li class="nav-About Me" role="presentation"><a href="/pages/about-me.html"><span>About Me</span></a></li>
<li class="nav-👨‍💻 Tech active" role="presentation"><a href="/category/tech.html"><span>👨‍💻 Tech</span></a></li>
<li class="nav-📚 Book Digest" role="presentation"><a href="/category/book.html"><span>📚 Book Digest</span></a></li>
<li class="nav-💬 Gossiping" role="presentation"><a href="/category/gossiping.html"><span>💬 Gossiping</span></a></li>
<li class="nav-🏷️ Tags" role="presentation"><a href="/tags.html"><span>🏷️ Tags</span></a></li>
<li class="nav-🗄️ Archives" role="presentation"><a href="/archives.html"><span>🗄️ Archives</span></a></li>
<li class="nav-📚 Series" role="presentation"><a href="/series_list.html"><span>📚 Series</span></a></li>
<li class="nav-🔍 Search" role="presentation"><a href="/search.html"><span>🔍 Search</span></a></li>
</ul>
<ul class="nav-meta">
<li class="nav-linkedin"><a aria-label="Linkedin" href="https://tw.linkedin.com/in/clleew" target="_blank"><i aria-hidden="true" class="icon icon-linkedin"></i>
<span>Linkedin</span>
</a></li>
<li class="nav-github"><a aria-label="Github" href="https://github.com/Lee-W" target="_blank"><i aria-hidden="true" class="icon icon-github"></i>
<span>GitHub</span>
</a></li>
<li class="nav-twitter"><a aria-label="Twitter" href="https://twitter.com/clleew" target="_blank"><i aria-hidden="true" class="icon icon-twitter"></i>
<span>Twitter</span>
</a></li>
<li class="nav-search" style="display: none;">
<a title="Search">
<i aria-hidden="true" class="icon icon-search"></i>
<span>Search</span>
</a>
</li>
</ul> </nav>
<div class="nav-wrapper-control">
<div class="inner">
<a class="nav-menu" role="button"><i aria-hidden="true" class="icon icon-menu"></i>Menu</a>
<a class="nav-search" role="button" style="display: none;" title="Search"><i aria-hidden="true" class="icon icon-search"></i></a>
</div>
</div>
</div>
<div aria-label="Close" class="nav-close" role="button"></div>
<section class="page-wrapper" id="wrapper">
<!-- Progressbar -->
<div class="progress-container">
<span class="progress-bar"></span>
</div>
<!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="post-header has-cover">
<div class="inner">
<span class="post-info">
<span class="post-type">Article</span>
<span class="post-count">Tech</span>
</span>
<h1 class="post-title">
            Python Table Manners - 測試 (二)
        </h1>
<div class="post-meta">
<div class="post-meta-avatars">
<figure class="post-meta-avatar avatar">
<a class="author-avatar" href="https://blog.wei-lee.me/author/wei-lee.html">
<img alt="Wei Lee" class="author-profile-image" src="https://blog.wei-lee.me//images/avatar.jpeg"/>
</a>
</figure>
</div>
<h4 class="post-meta-author">
            Wei Lee
          </h4>
<time datetime="2020/02/25 - Tue">2020/02/25 - Tue</time>
          • <time datetime="2020/10/04 - Sun"> Updated on 2020/10/04 - Sun</time>
          • 3 min read
        </div>
<div class="post-cover cover">
<img alt="Category Tech" src="https://blog.wei-lee.me//images/cover.jpeg"/>
</div>
</div>
</header>
<!-- Post content -->
<main class="content" data-pagefind-body="" role="main">
<article class="post">
<div class="inner">
<section class="post-content">
<p>接續前一篇提到的 <a href="https://docs.pytest.org/en/6.1.1/">pytest</a>，繼續看它的其他功能吧</p>
<!--more-->
<div class="toc">
<ul>
<li><a href="#fixture">fixture</a><ul>
<li><a href="#_1">準備 / 清除資源</a></li>
<li><a href="#scope">scope</a></li>
<li><a href="#conftestpy">conftest.py</a></li>
<li><a href="#fixture_1">常用的內建 fixture</a></li>
</ul>
</li>
<li><a href="#parameterize">參數化 (parameterize)</a></li>
<li><a href="#marker">marker</a><ul>
<li><a href="#marker_1">內建 marker</a></li>
<li><a href="#marker_2">自定義 marker</a></li>
</ul>
</li>
<li><a href="#_2">測試例外事件</a></li>
<li><a href="#pytest">pytest 常用命令列參數</a></li>
<li><a href="#pytest-cov">pytest-cov 測試覆蓋率</a></li>
<li><a href="#plugins">其他常用 plugins</a></li>
<li><a href="#_3">其他測試工具</a></li>
<li><a href="#reference">Reference</a></li>
</ul>
</div>
<h2 id="fixture">fixture</h2>
<p><a href="https://docs.pytest.org/en/6.1.1/fixture.html">fixture</a> 幾乎可以說是 pytest 最重要的功能<br/>
前一篇的例子中只有用到準備資源的部分<br/>
這裡再舉一些例子來說明它的其他應用</p>
<h3 id="_1">準備 / 清除資源</h3>
<p>假設我們已經有了虛構的 <code>db</code> 函式庫，它可以處理各種資料庫相關的功能</p>
<p>現在寫一個測試案例來驗證 <code>is_connected</code> 函式是否能正確的判斷資料庫有連線</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">DB</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">db</span><span class="p">():</span>
    <span class="c1"># 初始化 DB 的 instance</span>
    <span class="n">_db</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
    <span class="c1"># 連接到資料庫</span>
    <span class="n">_db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">yield</span> <span class="n">_db</span>

    <span class="c1"># 斷開資料庫連線</span>
    <span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">test_db_is_connected</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">db</span><span class="o">.</span><span class="n">is_connected</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span>
</code></pre></div>
<p>fixture <code>db</code> 中不使用 <code>return</code> 而是使用 <code>yield</code><br/>
連線資料庫後，就先將 <code>_db</code> instance 回傳<br/>
在 <code>test_db_is_connected</code> 引入 fixture <code>db</code> 時，資料庫會處於連線的狀態<br/>
結束後，則會執行 <code>_db.close()</code> 斷開資料庫的連線<br/>
（什麼時候才算結束則是看 <code>fixture</code> 的參數 <code>scope</code>，這會在後面說明）</p>
<p>接下來我還想要說明兩個概念</p>
<ol>
<li><code>fixture</code> 中使用 <code>fixture</code></li>
<li>用 <code>fixture</code> 準備跟清除資源，但不直接呼叫到資源 (<code>pytest.mark.usefixtures</code>)</li>
</ol>
<p>現在假設已經實作了 <code>model</code>，裡面有 <code>User</code> 的定義<br/>
我們想要驗證新增了一筆 admin 的使用者後，是否能成功查詢到這筆資料</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>

<span class="kn">from</span> <span class="nn">db</span> <span class="kn">import</span> <span class="n">DB</span>
<span class="kn">from</span> <span class="nn">model</span> <span class="kn">import</span> <span class="n">User</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">db</span><span class="p">():</span>
    <span class="n">_db</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
    <span class="n">_db</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="k">yield</span>

    <span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixtures</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s2">"function"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">insert_admin_user</span><span class="p">(</span><span class="n">db</span><span class="p">):</span>
    <span class="c1"># 初始化 user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"admin"</span><span class="p">)</span>
    <span class="c1"># 將 user 新增到資料庫</span>
    <span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>

    <span class="k">yield</span>
    <span class="c1"># 將 user 從資料庫移除</span>
    <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">usefixtures</span><span class="p">(</span><span class="s2">"insert_admin_user"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">test_admin_user_exists</span><span class="p">():</span>
    <span class="c1"># 從資料庫中找出第一筆 name 是 admin 的 user</span>
    <span class="n">admin_user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"admin"</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">assert</span> <span class="n">admin_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</code></pre></div>
<p>新增資料前，必須先跟資料庫建立連線<br/>
因此準備資料的 fixture <code>insert_admin_user</code> 會使用到 <code>db</code> fixture</p>
<p>而測試函式 <code>test_admin_user_exists</code> ，需要已經有 admin 使用者的資料庫，來測試 <code>User.query.filter(name="admin").first()</code> 是否能成功取得資料<br/>
但它不需要用到 <code>insert_admin_user</code> 這個變數，因此就能改成使用 <code>pytest.mark.usefixtures</code><br/>
這樣就能在不引入參數的情況下，使用 fixture 設定好的環境</p>
<h3 id="scope">scope</h3>
<p>fixture 的 <a href="https://docs.pytest.org/en/6.1.1/fixture.html#scope-sharing-a-fixture-instance-across-tests-in-a-class-module-or-session">scope</a> 共分為五種 （function, class, module, package, session）<br/>
表示 fixture 會在哪個階段前準備資源，並在哪個階段後清除<br/>
如果設定成 function，就會在每一個測試函式執行前和後做資源的處理</p>
<h3 id="conftestpy">conftest.py</h3>
<p><a href="https://docs.pytest.org/en/2.7.3/plugins.html?#conftest-py-local-per-directory-plugins">conftest.py</a> 是 pytest 中的一個特殊檔案<br/>
如果是整個套件（同一個資料夾）都會用到的 fixture 就能放在這， pytest 執行時會自動載入</p>
<p>以下面的結構為例， <code>test_sponsor.py</code> 就會自動載入上層的 <code>conftest.py</code> 中的 fixture</p>
<div class="highlight"><pre><span></span><code>└── tests
    ├── __init__.py
    ├── conftest.py
    ├── test_sponsor.py
    └── page
        ├── __init__.py
        ├── conftest.py
        └── test_title.py
</code></pre></div>
<h3 id="fixture_1">常用的內建 fixture</h3>
<ul>
<li><a href="https://docs.pytest.org/en/6.1.1/reference.html#std:fixture-caplog">caplog</a>: 抓 log 訊息</li>
<li><a href="https://docs.pytest.org/en/6.1.1/reference.html#std:fixture-capsys">capsys</a>: 抓 std out, std err</li>
<li><a href="https://docs.pytest.org/en/6.1.1/reference.html#std:fixture-tmpdir">tmpdir</a>: 暫時資料夾，通常用來測檔案相關的測試</li>
</ul>
<h2 id="parameterize">參數化 (parameterize)</h2>
<p>在測試資料比較簡單的時候，可以使用 <a href="https://docs.pytest.org/en/6.1.1/parametrize.html">parameterize</a> 來減少撰寫重複的程式碼</p>
<ul>
<li><code>@pytest.mark.parametrize(args1, arg2)</code><ul>
<li>第一個參數: 指定測試函式要使用的參數名稱</li>
<li>第二個參數: 測試資料的陣列</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span>
    <span class="s2">"x, y, expected_sum"</span><span class="p">,</span>
    <span class="p">(</span>
        <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
        <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="k">def</span> <span class="nf">test_add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">expected_sum</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">==</span> <span class="n">expected_sum</span>
</code></pre></div>
<h2 id="marker">marker</h2>
<p>前面已經介紹過 <code>parameterize</code> 和 <code>usefixtures</code><br/>
這裡會介紹 <a href="http://doc.pytest.org/en/6.1.1/example/markers.html">markers</a> 還可以做什麼</p>
<h3 id="marker_1">內建 marker</h3>
<ul>
<li><a href="http://doc.pytest.org/en/6.1.1/skipping.html#skip">skip</a>: 跳過這個測試案例</li>
<li><a href="http://doc.pytest.org/en/6.1.1/skipping.html#skipif">skipif</a>: 如果符合某個條件，則跳過這個測試案例</li>
<li><a href="http://doc.pytest.org/en/6.1.1/skipping.html#xfail">xfail</a>: 預期會失敗 （其實前一篇想跳過會失敗的案例應該要用 <code>xfail</code>，而不是 <code>skip</code>）</li>
</ul>
<h3 id="marker_2">自定義 marker</h3>
<p><code>@pytest.mark.[any custom marker]</code> 的用途是標記測試案例<br/>
像是如果有些測試會特別慢，就可以透過標記 <code>@pytest.mark.slow</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">slow</span>
<span class="k">def</span> <span class="nf">test_super_slow_test</span><span class="p">():</span>
    <span class="n">sleep</span><span class="p">(</span><span class="mi">99999999999999</span><span class="p">)</span>
</code></pre></div>
<p>執行時加上參數 <code>-m</code> 就能跳過（或只執行）這些案例</p>
<div class="highlight"><pre><span></span><code>pipenv run pytest -m "not slow"
</code></pre></div>
<p>上面的做法，如果有測試案例不小心打成 <code>@pytest.mark.slwo</code>，會不太容易被發現<br/>
但 pytest 還是會正常執行<br/>
這時候可以在專案加入設定檔 <code>pyproject.toml</code> (pytest 6.0.0 之後才支援這種設定檔格式) 定義 marker<br/>
p.s. 不建議使用 <code>setup.cfg</code> 做為 pytest 的設定檔 (Read More 👉 <a href="https://github.com/pytest-dev/pytest/issues/3523">deprecate setup.cfg support #3523</a>)</p>
<div class="highlight"><pre><span></span><code><span class="k">[tool.pytest.ini_options]</span>
<span class="n">minversion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"6.0"</span>
<span class="n">markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">"slow"</span>
<span class="p">]</span>
</code></pre></div>
<p>並在執行時加上 <code>--strict-markers</code> 參數</p>
<div class="highlight"><pre><span></span><code>pipenv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>--strict-markers<span class="w"> </span>-m<span class="w"> </span><span class="s2">"not slow"</span>
</code></pre></div>
<p>pytest 就會告訴我們 <code>slwo</code> 並不是被定義過的 maker</p>
<p>更進一步可以把 <code>--strict-markers</code> 直接寫入 <code>pyproject.toml</code></p>
<div class="highlight"><pre><span></span><code><span class="k">[tool.pytest.ini_options]</span>
<span class="n">minversion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"6.0"</span>
<span class="n">addopts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"--strict-markers"</span>
<span class="n">markers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s2">"slow"</span>
<span class="p">]</span>
</code></pre></div>
<h2 id="_2">測試例外事件</h2>
<p>透過 <code>pytest.raise</code> 確認測試案例是否有符合預期的丟出例外事件</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pytest</span>


<span class="k">def</span> <span class="nf">test_index_error</span><span class="p">():</span>
    <span class="n">some_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">some_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>
<h2 id="pytest">pytest 常用命令列參數</h2>
<ul>
<li><code>-v</code> (<code>-vv</code>, <code>-vvv</code>): 顯示更多資訊 （越多 v 就會顯示越多資訊）</li>
<li><code>--durations=N</code>: 只列出最慢的 <em>N</em> 個測試</li>
<li><code>-x</code> (<code>--exitfirst</code>): 遇到第一個失敗就終止測試</li>
<li><code>--maxfail=num</code>: 失敗次數達到 <em>num</em> 次，直接終止測試</li>
<li><code>--lf</code> (<code>--last-failed</code>): 只測試上次失敗的案例</li>
<li><code>--ff</code> (<code>--failed-first</code>): 從上次失敗的案例開始測試</li>
<li><code>--nf</code> <code>--new-first</code>: 從新的案例開始測試</li>
<li><code>-k EXPRESSION</code>: 只測試名稱符合 "EXPRESSION" 的案例</li>
<li><code>-m MARKEXPR</code>: 只測試有 "MARKEXPR" maker 的案例</li>
<li><code>--fixtures</code>: 列出所有 <code>fixtures</code></li>
</ul>
<h2 id="pytest-cov">pytest-cov 測試覆蓋率</h2>
<p><a href="https://github.com/pytest-dev/pytest-cov">pytest-cov</a> 可以用來產生測試覆蓋率的報告，讓我們知道程式碼還有哪些沒被測試到</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 安裝 pytest-cov</span>
pipenv<span class="w"> </span>install<span class="w"> </span>pytest-cov<span class="w"> </span>--dev
</code></pre></div>
<p>e.g.,</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 計算 myproj 的覆蓋率</span>
pipenv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>--cov<span class="o">=</span>myproj<span class="w"> </span>tests/
</code></pre></div>
<p>比較重要的參數有</p>
<ul>
<li><code>--cov=[SOURCE]</code>: 測試包含的程式碼範圍</li>
<li><code>--cov-report=TYPE</code>: 測試覆蓋率報告的種類 (term, term-missing, annotate, html, xml)</li>
<li><code>--cov-fail-under=MIN</code>: 如果覆蓋率小於 <em>MIN</em> 則跳出</li>
</ul>
<p>其中 <code>--cov</code>, <code>--cov-report</code> 都可以加入多個參數</p>
<p>回到 <a href="https://github.com/pycontw/pycontw-postevent-report-generator">pycontw-postevent-report-generator</a> 的例子<br/>
先 checkout 回 <a href="https://github.com/pycontw/pycontw-postevent-report-generator/tree/1.0.2">1.0.2</a>，來測試 1.0.2 上的測試覆蓋率</p>
<div class="highlight"><pre><span></span><code>pipenv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>--cov<span class="o">=</span>report_generator<span class="w"> </span>--cov-report<span class="o">=</span>term-missing<span class="w"> </span>test/
</code></pre></div>
<p>從下面的結果可以看到哪些檔案的哪些部分沒有被測試到</p>
<p><img alt="test-coverage" src="/images/posts-image/2020-02-22-python-table-manner-series/test-coverage.jpg"/></p>
<p>如果想看精美的網頁版報告，可以試試看以下的指令<br/>
報告會產生在專案資料夾下的 <code>htmlcov</code></p>
<div class="highlight"><pre><span></span><code>pipenv<span class="w"> </span>run<span class="w"> </span>pytest<span class="w"> </span>--cov<span class="o">=</span>report_generator<span class="w"> </span>--cov-report<span class="o">=</span>term-missing<span class="w"> </span>--cov-report<span class="o">=</span>html
</code></pre></div>
<p>一些更進階的設定，可以寫入設定檔 <code>pyproject.toml</code> (或 <code>.coveragerc</code>，但語法會不太一樣)<br/>
以下是我自己使用的 <code>pyproject.toml</code></p>
<div class="highlight"><pre><span></span><code><span class="k">[tool.coverage]</span>
<span class="w">    </span><span class="k">[tool.coverage.report]</span>
<span class="w">    </span><span class="n">show_missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="n">exclude_lines</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="c1"># Have to re-enable the standard pragma</span>
<span class="w">        </span><span class="s1">'pragma: no cover'</span><span class="p">,</span>

<span class="w">        </span><span class="c1"># Don't complain about missing debug-only code:</span>
<span class="w">        </span><span class="s1">'def __repr__'</span><span class="p">,</span>
<span class="w">        </span><span class="s1">'if self\.debug'</span><span class="p">,</span>

<span class="w">        </span><span class="c1"># Don't complain if tests don't hit defensive assertion code:</span>
<span class="w">        </span><span class="s1">'raise AssertionError'</span><span class="p">,</span>
<span class="w">        </span><span class="s1">'raise NotImplementedError'</span><span class="p">,</span>

<span class="w">        </span><span class="c1"># Don't complain if non-runnable code isn't run:</span>
<span class="w">        </span><span class="s1">'if 0:'</span><span class="p">,</span>
<span class="w">        </span><span class="s1">'if __name__ == .__main__.:'</span>
<span class="w">    </span><span class="p">]</span>
</code></pre></div>
<p>Read More 👉 <a href="https://coverage.readthedocs.io/en/coverage-5.0.3/config.html">Configuration reference</a></p>
<h2 id="plugins">其他常用 plugins</h2>
<ul>
<li><a href="https://pypi.org/project/pytest-xdist/">pytest-xdist</a><ul>
<li>用平行化加速測試的執行 (<code>pipenv run pytest -n NUM</code>)</li>
</ul>
</li>
<li><a href="https://github.com/pytest-dev/pytest-mock">pytest-mock</a><ul>
<li>使用 mocking 的技巧將部分不好測試的物件替換成假的物件</li>
<li>推薦參考 <a href="https://wei-lee.me/pycon-note/posts/pycon-us-2018/2020/01/demystifying-the-Patch-functionusing-python/">Demystifying the Patch Function - PyCon US 2018</a> （不過她不是用 pytest）</li>
</ul>
</li>
<li><a href="https://github.com/ESSS/pytest-regressions">pytest-regressions</a><ul>
<li>將冗長的測試結果寫成檔案，每次測試都去比對跟上次產生的結果是否相同</li>
</ul>
</li>
<li>尋找其他 plugins<ul>
<li><a href="https://docs.pytest.org/en/6.1.1/plugins.html">pytest - Installing and Using plugins¶</a></li>
<li><a href="https://github.com/pytest-dev">pytest-dev</a></li>
</ul>
</li>
</ul>
<h2 id="_3">其他測試工具</h2>
<ul>
<li><a href="https://tox.readthedocs.io/en/latest/">tox</a><ul>
<li>在各種不同版本的 Python 中做測試，幾乎是開源 Python 專案的標準工具</li>
</ul>
</li>
<li><a href="https://nox.thea.codes/en/stable/">nox</a><ul>
<li>基本上跟 tox 的功能相似，不過組態設定是使用 Python</li>
<li>tox 跟 nox 推薦參考 <a href="https://wei-lee.me/pycon-note/posts/pycon-us-2019/2019/08/break-the-cycle-three-excellent-python-tools-to-automate-repetitive-tasks/">Break the Cycle: Three excellent Python tools to automate repetitive tasks - PyCon US 2019</a></li>
</ul>
</li>
<li><a href="https://github.com/HypothesisWorks/hypothesis">hypothesis</a><ul>
<li>採用 Property-based testing，跟以往要自己產生測試資料不同，我們只需要給予資料的定義（e.g., 0 ~ 10000 之間的整數）， hypothsis 會根據定義來產生隨機的資料，也因此更容易包含到極端案例</li>
<li>推薦參考 <a href="https://wei-lee.me/pycon-note/posts/pycon-us-2019/2019/08/escape-from-auto-manual-testing-with-yypothesis/">Escape from auto-manual testing with Hypothesis!</a> （PyCon US 2019， Zac 投了 talk, sprint, tutorial, poster，很用心在推廣這套工具）</li>
</ul>
</li>
</ul>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://pragprog.com/book/bopytest/python-testing-with-pytest">Python Testing with pytest</a></li>
<li><a href="https://www.youtube.com/watch?time_continue=201&amp;v=pX1_I_sEi8k">快快樂樂成為 Coding Ninja (by pytest) - PyCon APAC 2015</a></li>
<li><a href="https://wei-lee.me/pycon-note/posts/swiss-python-summit-2016/2019/11/pytest-rapid-simple-testing/">Pytest: Rapid Simple Testing -  Swiss Python Summit 2016</a></li>
<li><a href="https://wei-lee.me/pycon-note/posts/pycon-us-2018/2020/01/demystifying-the-Patch-functionusing-python/">Demystifying the Patch Function - PyCon US 2018</a></li>
<li><a href="https://wei-lee.me/pycon-note/posts/pycon-us-2019/2019/08/escape-from-auto-manual-testing-with-yypothesis/">Escape from auto-manual testing with Hypothesis!</a></li>
<li><a href="https://wei-lee.me/pycon-note/posts/pycon-us-2019/2019/08/break-the-cycle-three-excellent-python-tools-to-automate-repetitive-tasks/">Break the Cycle: Three excellent Python tools to automate repetitive tasks - PyCon US 2019</a></li>
</ul>
</section>
<section class="post-footer">
<div class="post-share">
<span class="post-info-label">Share</span>
<a aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=Python Table Manners - 測試 (二) &amp;url=https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter">
<i aria-hidden="true" class="icon icon-twitter"></i><span class="hidden">Twitter</span>
</a>
<a aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Facebook">
<i aria-hidden="true" class="icon icon-facebook"></i><span class="hidden">Facebook</span>
</a>
<a aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2&amp;title=Python Table Manners - 測試 (二)" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720');return false;" title="LinkedIn">
<i aria-hidden="true" class="icon icon-linkedin"></i><span class="hidden">LinkedIn</span>
</a>
<a aria-label="Email" class="email" href="mailto:?subject=Python Table Manners - 測試 (二)&amp;body=https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2" title="Email">
<i aria-hidden="true" class="icon icon-mail"></i><span class="hidden">Email</span>
</a>
<div class="clear"></div>
</div>
<aside class="post-tags">
<a href="https://blog.wei-lee.me/tag/python.html">Python</a><a href="https://blog.wei-lee.me/tag/test.html">Test</a> </aside>
<div class="clear"></div>
<div class="series">
<p>This post is part 4 of the "Python Table Manners" series:</p>
<ol class="parts">
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-series">Python Table Manners 系列</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-dependency-mangement">Python Table Manners - 虛擬環境和套件管理</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-1">Python Table Manners - 測試 (一)</a>
</li>
<li class="active">
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2">Python Table Manners - 測試 (二)</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-coding-style">Python Table Manners - 程式碼風格</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-manage-trivial-tasks">Python Table Manners - 管理繁瑣任務</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-pre-commit">Python Table Manners - pre-commit: git commit 前做完檢查</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/03/python-table-manners-commitizen">Python Table Manners - Commitizen: 規格化 commit message</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/03/python-table-manners-security">Python Table Manners - 安全性檢查</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/04/python-table-manners-documentation">Python Table Manners - 文件</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2020/12/python-table-manner-continuous-integration">Python Table Manners - 持續整合/部署</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2021/01/python-table-manners-cookiecutter">Python Table Manners - Cookiecutter 專案模板</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2021/01/python-table-manner-editor">Python Table Manners 番外 - 編輯器</a>
</li>
</ol>
</div>
</section>
<script type="text/javascript">var use_utterance = true;</script>
<section class="post-comments">
<script async="" crossorigin="anonymous" data-issue-term="https://blog.wei-lee.me/posts/tech/2020/02/python-table-manners-test-2" data-label="blog-comment" data-repo="Lee-W/main-blog" data-theme="github-light" src="https://utteranc.es/client.js">
</script>
</section>
<aside class="post-nav">
<div class="clear"></div>
</aside>
</div>
</article>
</main>
<div class="nav-footer">
<nav aria-label="Footer" class="nav-wrapper">
<span class="nav-copy">Those aren't written down are meant to be forgotten © 2023
          <a class="nav-rss" href="https://blog.wei-lee.me/feeds/all.atom.xml" target="_blank" title="RSS"><i class="icon icon-rss"></i></a>
</span>
<span class="nav-credits">



          Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a> • Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a> •
          <a class="menu-item js-theme" data-dark="Dark theme" data-light="Light theme" data-system="System theme" href="#">
<span class="theme-icon"></span><span class="theme-text">System theme</span>
</a>
</span>
</nav>
</div>
</section>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<!-- TODO: minify -->
<script src="https://blog.wei-lee.me/theme/js/jquery.fitvids.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/script.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/clipboard.min.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/copy-to-clipboard.js" type="text/javascript"></script>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3J7XQ46QH5"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3J7XQ46QH5', { 'anonymize_ip': true });
    </script>
<script src="/pagefind/pagefind-ui.js"></script>
<script>
      window.addEventListener('DOMContentLoaded', (event) => {
          new PagefindUI({
              element: "#search",
              showImages: false,
          });
      });
  </script>
<!-- 	The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in article.html, but it needs to be included down here, after jQuery has already loaded. -->
<script>
  $(document).ready(function () {
    var viewport = $(window);
    var post = $('.post-content');
    // Responsive videos with fitVids
    post.fitVids();

    // Reading progress bar on window top
    function readingProgress() {
      var postBottom = post.offset().top + post.height();
      var viewportHeight = viewport.height();
      var progress = 100 - (((postBottom - (viewport.scrollTop() + viewportHeight) + viewportHeight / 3) / (postBottom - viewportHeight + viewportHeight / 3)) * 100);
      $('.progress-bar').css('width', progress + '%');
      (progress > 100) ? $('.progress-container').addClass('complete'): $('.progress-container').removeClass('complete');
    }
    readingProgress();
    // Trigger reading progress
    viewport.on({
      'scroll': function() {
        readingProgress();
      },
      'resize': function() {
        readingProgress();
      },
      'orientationchange': function() {
        readingProgress();
      }
    });

  });
</script>
</body>
</html>
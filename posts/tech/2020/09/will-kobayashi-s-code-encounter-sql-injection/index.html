
<!DOCTYPE html>

<html lang="zh-tw">
<head>
<meta charset="utf-8"/>
<meta charset="utf-8" content="text/html" http-equiv="Content-Type">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>小林的程式會不會遇到 SQL Injection </title>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="origin" name="referrer"/>
<meta content="Pelican" name="generator"/>
<link href="https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" rel="canonical"/>
<!-- Feed -->
<link href="https://blog.wei-lee.me/feeds/all.atom.xml" rel="alternate" title="Those aren't written down are meant to be forgotten Full Atom Feed" type="application/atom+xml"/>
<!-- TODO: combine -->
<link href="https://blog.wei-lee.me/theme/css/style.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pygments.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pagefind-ui-custom.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code-copy.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/pagefind/pagefind-ui.css" rel="stylesheet"/>
<!-- Custom fonts -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"/>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
<script>
    var siteUrl = 'https://blog.wei-lee.me';
  </script>
<script>
    var localTheme = localStorage.getItem('attila_theme');
    switch (localTheme) {
      case 'dark':
        document.documentElement.classList.add('theme-dark');
        break;
      case 'light':
        document.documentElement.classList.add('theme-light');
        break;
      default:
        break;
    }
  </script>
<meta content="其實這篇文章應該一年前就該寫了... 今年為了在 PyCon TW 的 Lightning Talk 想個梗，就拿出來講 (slide) 沒想到被投影機擺了一道......" name="description"/>
<meta content="Wei Lee" name="author"/>
<meta content="Python" name="tags"/>
<meta content="Anime" name="tags"/>
<!-- Open Graph -->
<meta content="Those aren't written down are meant to be forgotten" prefix="og: http://ogp.me/ns#" property="og:site_name">
<meta content="小林的程式會不會遇到 SQL Injection " prefix="og: http://ogp.me/ns#" property="og:title">
<meta content="其實這篇文章應該一年前就該寫了... 今年為了在 PyCon TW 的 Lightning Talk 想個梗，就拿出來講 (slide) 沒想到被投影機擺了一道......" prefix="og: http://ogp.me/ns#" property="og:description">
<meta content="zh-tw" prefix="og: http://ogp.me/ns#" property="og:locale">
<meta content="https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" prefix="og: http://ogp.me/ns#" property="og:url"/>
<meta content="article" prefix="og: http://ogp.me/ns#" property="og:type"/>
<meta content="2020-09-22 12:50:00+08:00" prefix="og: http://ogp.me/ns#" property="article:published_time"/>
<meta content="" prefix="og: http://ogp.me/ns#" property="article:modified_time"/>
<meta content="https://blog.wei-lee.me/author/wei-lee.html" prefix="og: http://ogp.me/ns#" property="article:author"/>
<meta content="Tech" prefix="og: http://ogp.me/ns#" property="article:section">
<meta content="Python" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="Anime" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="https://blog.wei-lee.me/images/cover.jpeg" prefix="og: http://ogp.me/ns#" property="og:image"/>
<!-- Twitter Card -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="@clleew" name="twitter:site"/>
<meta content="小林的程式會不會遇到 SQL Injection " name="twitter:title"/>
<meta content="https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" name="twitter:url"/>
<meta content="https://blog.wei-lee.me/images/cover.jpeg" name="twitter:image:src"/>
<meta content="其實這篇文章應該一年前就該寫了... 今年為了在 PyCon TW 的 Lightning Talk 想個梗，就拿出來講 (slide) 沒想到被投影機擺了一道......" name="twitter:description"/>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "小林的程式會不會遇到 SQL Injection",
  "headline": "小林的程式會不會遇到 SQL Injection",
  "datePublished": "2020-09-22 12:50:00+08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Wei Lee",
    "url": "https://blog.wei-lee.me/author/wei-lee.html"
  },
  "image": "https://blog.wei-lee.me//images/cover.jpeg",
  "url": "https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection",
  "description": "其實這篇文章應該一年前就該寫了... 今年為了在 PyCon TW 的 Lightning Talk 想個梗，就拿出來講 (slide) 沒想到被投影機擺了一道......"
}
</script>
</meta></meta></meta></meta></meta></link></meta><link href="https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Those aren't written down are meant to be forgotten", "item": "https://blog.wei-lee.me"}, {"@type": "ListItem", "position": 2, "name": "Posts", "item": "https://blog.wei-lee.me/posts"}, {"@type": "ListItem", "position": 3, "name": "Tech", "item": "https://blog.wei-lee.me/posts/tech"}, {"@type": "ListItem", "position": 4, "name": "2020", "item": "https://blog.wei-lee.me/posts/tech/2020"}, {"@type": "ListItem", "position": 5, "name": "09", "item": "https://blog.wei-lee.me/posts/tech/2020/09"}, {"@type": "ListItem", "position": 6, "name": "Will kobayashi s code encounter sql injection", "item": "https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection"}, {"@type": "ListItem", "position": 7, "name": "Index", "item": "https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Wei Lee"}, "publisher": {"@type": "Organization", "name": "Those aren't written down are meant to be forgotten"}, "headline": "小林的程式會不會遇到 SQL Injection", "about": "Tech", "datePublished": "2020-09-22 12:50"}</script><meta content="summary" name="twitter:card"/><meta content="https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" property="og:url"/><meta content="article" property="og:type"/><meta content="小林的程式會不會遇到 SQL Injection" property="og:title"/><meta content="C" property="og:locale"/></head>
<body class="category-template">
<div class="nav-header">
<nav aria-label="Main" class="nav-wrapper">
<ul>
<li class="nav-🏠 Home" role="presentation"><a href="/"><span>🏠 Home</span></a></li>
<li class="nav-About Me" role="presentation"><a href="/pages/about-me.html"><span>About Me</span></a></li>
<li class="nav-👨‍💻 Tech active" role="presentation"><a href="/category/tech.html"><span>👨‍💻 Tech</span></a></li>
<li class="nav-📚 Book Digest" role="presentation"><a href="/category/book.html"><span>📚 Book Digest</span></a></li>
<li class="nav-💬 Gossiping" role="presentation"><a href="/category/gossiping.html"><span>💬 Gossiping</span></a></li>
<li class="nav-🏷️ Tags" role="presentation"><a href="/tags.html"><span>🏷️ Tags</span></a></li>
<li class="nav-🗄️ Archives" role="presentation"><a href="/archives.html"><span>🗄️ Archives</span></a></li>
<li class="nav-📚 Series" role="presentation"><a href="/series_list.html"><span>📚 Series</span></a></li>
<li class="nav-🔍 Search" role="presentation"><a href="/search.html"><span>🔍 Search</span></a></li>
</ul>
<ul class="nav-meta">
<li class="nav-linkedin"><a aria-label="Linkedin" href="https://tw.linkedin.com/in/clleew" target="_blank"><i aria-hidden="true" class="icon icon-linkedin"></i>
<span>Linkedin</span>
</a></li>
<li class="nav-github"><a aria-label="Github" href="https://github.com/Lee-W" target="_blank"><i aria-hidden="true" class="icon icon-github"></i>
<span>GitHub</span>
</a></li>
<li class="nav-twitter"><a aria-label="Twitter" href="https://twitter.com/clleew" target="_blank"><i aria-hidden="true" class="icon icon-twitter"></i>
<span>Twitter</span>
</a></li>
<li class="nav-search" style="display: none;">
<a title="Search">
<i aria-hidden="true" class="icon icon-search"></i>
<span>Search</span>
</a>
</li>
</ul> </nav>
<div class="nav-wrapper-control">
<div class="inner">
<a class="nav-menu" role="button"><i aria-hidden="true" class="icon icon-menu"></i>Menu</a>
<a class="nav-search" role="button" style="display: none;" title="Search"><i aria-hidden="true" class="icon icon-search"></i></a>
</div>
</div>
</div>
<div aria-label="Close" class="nav-close" role="button"></div>
<section class="page-wrapper" id="wrapper">
<!-- Progressbar -->
<div class="progress-container">
<span class="progress-bar"></span>
</div>
<!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="post-header has-cover">
<div class="inner">
<span class="post-info">
<span class="post-type">Article</span>
<span class="post-count">Tech</span>
</span>
<h1 class="post-title">
            小林的程式會不會遇到 SQL Injection
        </h1>
<div class="post-meta">
<div class="post-meta-avatars">
<figure class="post-meta-avatar avatar">
<a class="author-avatar" href="https://blog.wei-lee.me/author/wei-lee.html">
<img alt="Wei Lee" class="author-profile-image" src="https://blog.wei-lee.me//images/avatar.jpeg"/>
</a>
</figure>
</div>
<h4 class="post-meta-author">
            Wei Lee
          </h4>
<time datetime="2020/09/22 - Tue">2020/09/22 - Tue</time>
          • 5 min read
        </div>
<div class="post-cover cover">
<img alt="Category Tech" src="https://blog.wei-lee.me/images/cover.jpeg"/>
</div>
</div>
</header>
<!-- Post content -->
<main class="content" data-pagefind-body="" role="main">
<article class="post">
<div class="inner">
<section class="post-content">
<p>其實這篇文章應該一年前就該寫了...<br/>
今年為了在 PyCon TW 的 Lightning Talk 想個梗，就拿出來講 (<a href="https://speakerdeck.com/leew/xiao-lin-de-cheng-shi-ma-hui-bu-hui-yu-dao-sql-injection">slide</a>)<br/>
沒想到被投影機擺了一道......</p>
<!--more-->
<div class="toc">
<ul>
<li><a href="#_1">前言雜談</a></li>
<li><a href="#sql-injection">什麼是 SQL injection</a></li>
<li><a href="#webpy-sql-injection">web.py 到底會不會有 SQL injection？</a><ul>
<li><a href="#_2">初始化資料庫</a></li>
<li><a href="#_3">實作登入功能</a></li>
<li><a href="#_4">該如何修正？</a></li>
</ul>
</li>
<li><a href="#_5">知其然還要知其所以然啊！</a><ul>
<li><a href="#pdbpp">pdbpp</a></li>
<li><a href="#webpy">追 web.py 原始碼</a></li>
</ul>
</li>
<li><a href="#_6">結語</a></li>
<li><a href="#one-more-thing">One more thing</a></li>
</ul>
</div>
<h2 id="_1">前言雜談</h2>
<p>去年看了京阿尼的作品<a href="https://zh.wikipedia.org/wiki/%E5%B0%8F%E6%9E%97%E5%AE%B6%E7%9A%84%E9%BE%8D%E5%A5%B3%E5%83%95">小林家的龍女僕</a></p>
<p>第一集就發現主角小林也是寫 Python 的工程師，就開心地分享了這個消息<br/>
<img alt="del" src="/images/posts-image/2020-will-kobayashi-s-code-encounter-sql-injection/del.jpg"/></p>
<p>沒想到馬上就有朋友問我這段程式碼會不會有 SQL injection<br/>
<img alt="will it encounter sql injection" src="/images/posts-image/2020-will-kobayashi-s-code-encounter-sql-injection/will it encounter sql injection.png"/></p>
<p>單看這一段程式碼其實很難直接下定論<br/>
畢竟 key 根本就不會被帶入 <code>session_id=$key</code>，誰知道 db 怎麼實作的</p>
<p>當然，早就有人注意到這段程式碼了<br/>
它出自 <a href="https://github.com/webpy/webpy/blob/webpy-0.39/web/session.py#L313">webpy/web/session.py</a></p>
<ul>
<li><a href="https://www.zhihu.com/question/51933296/answer/143492909">如何评价京都动画2017年1月新作 小林家的龙女仆?</a><ul>
<li>除了找到程式碼外，它還列出了劇情的其他 Python 程式碼，並討論了京都動畫使用這段程式碼會不會有法律問題</li>
</ul>
</li>
<li><a href="https://qiita.com/ygkn/items/6b3be1afa31e4092826e">小林さんちのメイドラゴンで出てきたコード（小林さんを探せ！）</a><ul>
<li>透過 <code>git blame</code> 來找出「到底誰是小林！」</li>
</ul>
</li>
<li><a href="https://ponkatsu807462913.wordpress.com/tag/sql-injection/">Ponkatsu - Tag: sql injection</a><ul>
<li>直接點出這段程式碼會遇到 SQL injection</li>
</ul>
</li>
</ul>
<p>但身為工程師還是要自己驗證一下到底會不會有 SQL injection</p>
<h2 id="sql-injection">什麼是 SQL injection</h2>
<p>根據 <a href="https://zh.wikipedia.org/wiki/SQL%E6%B3%A8%E5%85%A5">SQL注入</a> 維基百科頁面的例子<br/>
假設有一段產生 SQL 字串的程式碼是這樣寫的</p>
<div class="highlight"><pre><span></span><code><span class="n">sql_str</span> <span class="o">=</span> <span class="s2">"SELECT * FROM users WHERE (name = '"</span> <span class="o">+</span> <span class="n">username</span> <span class="o">+</span> <span class="s2">"') and (pw = '"</span> <span class="o">+</span> <span class="n">password</span> <span class="o">+</span> <span class="s2">"');"</span>
</code></pre></div>
<p>只要攻擊者輸入了</p>
<div class="highlight"><pre><span></span><code><span class="n">username</span> <span class="o">=</span> <span class="s2">"1' OR '1'='1"</span>
<span class="n">password</span> <span class="o">=</span> <span class="s2">"1' OR '1'='1"</span>
</code></pre></div>
<p>就會產生</p>
<div class="highlight"><pre><span></span><code><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'1'</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="s1">'1'</span><span class="o">=</span><span class="s1">'1'</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="p">(</span><span class="n">pw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'1'</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="s1">'1'</span><span class="o">=</span><span class="s1">'1'</span><span class="p">);</span>
</code></pre></div>
<p>因為 1 一定等於 1，這段 SQL 就會產生跟 <code>SELECT * FROM user;</code> 一樣的效果<br/>
也就是攻擊者在完全不知道帳號密碼的情況下，就可以取得所有 users 的帳號密碼</p>
<h2 id="webpy-sql-injection">web.py 到底會不會有 SQL injection？</h2>
<p>因為小林家的龍女僕是在 2017 年的 1 月到 4 月播出<br/>
根據 web.py 的 <a href="https://github.com/webpy/webpy/tags">tags</a> 頁面，在那之後的第一個發佈是 <code>webpy-0.39</code><br/>
可以推測，這最有可能是第一個包含小林撰寫程式碼的發佈</p>
<p><img alt="web.py release" src="/images/posts-image/2020-will-kobayashi-s-code-encounter-sql-injection/webpy tag.jpg"/></p>
<p>我們先從安裝 <code>web.py==0.39</code> 到虛擬環境中開始<br/>
（p.s. web 跟 py 中間的 . 是必要的，因為真的有個套件叫 webpy）</p>
<div class="highlight"><pre><span></span><code>poetry<span class="w"> </span>add<span class="w"> </span>web.py<span class="o">==</span><span class="m">0</span>.39
</code></pre></div>
<p>很不幸，如果使用的是 Python 3，會遇到以下的錯誤訊息</p>
<div class="highlight"><pre><span></span><code>Creating virtualenv kobayashi-pwI4Cysh-py3.8 in /Users/weilee/Library/Caches/pypoetry/virtualenvs

Updating dependencies
Resolving dependencies... (0.1s)

Writing lock file


Package operations: 1 install, 0 updates, 0 removals

  - Installing web.py (0.39)

[EnvCommandError]
Command ['/Users/weilee/Library/Caches/pypoetry/virtualenvs/kobayashi-pwI4Cysh-py3.8/bin/pip', 'install', '--no-deps', 'web.py==0.39'] errored with the following return code 1, and output:
Collecting web.py==0.39
  Using cached web.py-0.39.tar.gz (93 kB)
    ERROR: Command errored out with exit status 1:
     command: /Users/weilee/Library/Caches/pypoetry/virtualenvs/kobayashi-pwI4Cysh-py3.8/bin/python -c 'import sys, setuptools, tokenize; sys.argv[0] = '"'"'/.../web.py/setup.py'"'"'; __file__='"'"'/.../web.py/setup.py'"'"';f=getattr(tokenize, '"'"'open'"'"', open)(__file__);code=f.read().replace('"'"'\r\n'"'"', '"'"'\n'"'"');f.close();exec(compile(code, __file__, '"'"'exec'"'"'))' egg_info --egg-base /...
         cwd: /.../web.py/
    Complete output (7 lines):
    Traceback (most recent call last):
      File "&lt;string&gt;", line 1, in &lt;module&gt;
      File "/.../web.py/setup.py", line 6, in &lt;module&gt;
        from web import __version__
      File "/.../web.py/web/__init__.py", line 14, in &lt;module&gt;
        import utils, db, net, wsgi, http, webapi, httpserver, debugerror
    ModuleNotFoundError: No module named 'utils'
    ----------------------------------------
ERROR: Command errored out with exit status 1: python setup.py egg_info Check the logs for full command output.
WARNING: You are using pip version 20.1.1; however, version 20.2.3 is available.
You should consider upgrading via the '/Users/weilee/Library/Caches/pypoetry/virtualenvs/kobayashi-pwI4Cysh-py3.8/bin/python -m pip install --upgrade pip' command.
</code></pre></div>
<p>web.py 要到 0.40 才支援 Python 3 (Ref: <a href="https://github.com/webpy/webpy/issues/180">python3 ImportError: No module named utils #180</a>)</p>
<p>因為我不太想測試 Python 2，就假設小林的程式碼到 0.40 都沒什麼被改動到好了 😆</p>
<h3 id="_2">初始化資料庫</h3>
<p>要實驗到底有沒有辦法取得資料庫的資料，總是要先有一個資料庫<br/>
這裡做了三件事</p>
<ol>
<li>用 <code>sqlite3</code> 跟 "kobayashi.db" 建立連線</li>
<li>建立 <code>USER</code> 資料表</li>
<li>將 "kobayashi", "tohru", "kanna", "elma" 新增到 <code>USER</code> 資料表中</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">sqlite3</span>


<span class="k">def</span> <span class="nf">init_db</span><span class="p">():</span>
    <span class="c1"># connect and create "kobayashi.db"</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">"kobayashi.db"</span><span class="p">)</span>

    <span class="c1"># create USER table</span>
    <span class="n">create_table_sql</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    CREATE TABLE `USER` (</span>
<span class="s2">        `account`   TEXT NOT NULL UNIQUE,</span>
<span class="s2">        `password`  TEXT NOT NULL,</span>
<span class="s2">        PRIMARY KEY(`account`)</span>
<span class="s2">    );</span>
<span class="s2">    """</span>

    <span class="c1"># insert users into USER table</span>
    <span class="n">insert_user_sql</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">    INSERT INTO</span>
<span class="s2">        USER (account, password)</span>
<span class="s2">    VALUES</span>
<span class="s2">        ('kobayashi', '1'),</span>
<span class="s2">        ('tohru', '2'),</span>
<span class="s2">        ('kanna', '3'),</span>
<span class="s2">        ('elma', '3');</span>
<span class="s2">    """</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">create_table_sql</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">insert_user_sql</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">init_db</span><span class="p">()</span>
</code></pre></div>
<h3 id="_3">實作登入功能</h3>
<p><code>login</code> 會把使用者輸入的 account 跟 password 帶入 <code>where</code><br/>
如果在資料庫找到正確的匹配，就會回傳找到的第一筆 user<br/>
如果找不到就回傳 <code>None</code></p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">web</span>


<span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">account</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">web</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Storage</span><span class="p">]:</span>
    <span class="n">result_set</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s2">"USER"</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="sa">f</span><span class="s2">"account ='</span><span class="si">{</span><span class="n">account</span><span class="si">}</span><span class="s2">' AND password='</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">result_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"login succeeded"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"wrong username or password"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<p>這裡用三個案例來測試</p>
<ol>
<li>錯誤的帳號密碼 → 不應該取得 user</li>
<li>正確的帳號密碼 → 應該取得 user</li>
<li>SQL injection → 理想上，也不該取得 user</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">database</span><span class="p">(</span><span class="n">dbn</span><span class="o">=</span><span class="s2">"sqlite"</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="s2">"kobayashi.db"</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">login</span><span class="p">(</span><span class="s2">"kobayashi"</span><span class="p">,</span> <span class="s2">""</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">login</span><span class="p">(</span><span class="s2">"kobayashi"</span><span class="p">,</span> <span class="s2">"1"</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">login</span><span class="p">(</span><span class="s2">"1' OR '1'='1"</span><span class="p">,</span> <span class="s2">"1' OR '1'='1"</span><span class="p">))</span>
</code></pre></div>
<p>但這個世界始終不理想，包含了 SQL injection 的程式成功取得 user<br/>
之所以只取到一筆 user，是因為 <code>login</code> 只會回傳第一個物件，但這段 SQL 是能取到整個資料庫的 user 的</p>
<div class="highlight"><pre><span></span><code>0.0 (1): SELECT * FROM USER WHERE account ='kobayashi' AND password=''
wrong username or password
None

0.0 (2): SELECT * FROM USER WHERE account ='kobayashi' AND password='1'
login succeeded
&lt;Storage {'account': 'kobayashi', 'password': '1'}&gt;

0.0 (3): SELECT * FROM USER WHERE account ='1' OR '1'='1' AND password='1' OR '1'='1'
login succeeded
&lt;Storage {'account': 'kobayashi', 'password': '1'}&gt;
</code></pre></div>
<h3 id="_4">該如何修正？</h3>
<p>修正的方式很簡單，只要在呼叫 select 的時候用 <code>vars</code> 將參數帶進 <code>where</code> 即可<br/>
其實 web.py 的文件就有寫了 (Ref: <a href="https://webpy.org/cookbook/query">db.query</a>)</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">login</span><span class="p">(</span><span class="n">account</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">web</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">Storage</span><span class="p">]:</span>
    <span class="n">result_set</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
        <span class="s2">"USER"</span><span class="p">,</span>
        <span class="n">where</span><span class="o">=</span><span class="sa">f</span><span class="s2">"account=$account AND password=$password"</span><span class="p">,</span>
        <span class="nb">vars</span><span class="o">=</span><span class="p">{</span><span class="s2">"account"</span><span class="p">:</span> <span class="n">account</span><span class="p">,</span> <span class="s2">"password"</span><span class="p">:</span> <span class="n">password</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">result_set</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"login succeeded"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">"wrong username or password"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
<p>這次就算用原本 SQL injetion 的作法，也取不到任何的資料<br/>
因為沒有 account 是 <code>"1' OR '1'='1"</code></p>
<div class="highlight"><pre><span></span><code>0.0 (3): SELECT * FROM USER WHERE account ="1' OR '1'='1" AND password="1' OR '1'='1"
wrong username or password
None
</code></pre></div>
<h2 id="_5">知其然還要知其所以然啊！</h2>
<p>除了知道怎麼修正外，我還想知道 web.py 做了什麼<br/>
下面冗長的紀錄我追 web.py 原始碼的過程</p>
<h3 id="pdbpp">pdbpp</h3>
<p>寫這篇文章最大的收穫，大概就是大幅的提升了我對 pdb 的熟悉度<br/>
剛好聽到廣播 <a href="https://pythonbytes.fm/">Python Bytes</a> 推薦的 <a href="https://github.com/pdbpp/pdbpp">pdbpp</a> 就順手玩了一下<br/>
pdbpp 在安裝後會取代原生的 pdb<br/>
主要有這兩個功能比 pdb 好用</p>
<ol>
<li>syntax highlight<ul>
<li>不過需要注意的是，如果要能客製化 highlight 風格，需要直接從 master branch 安裝的版本，目前還沒把這個修正釋出到 PyPI 上</li>
</ul>
</li>
<li>sticky mode（在除錯器的上方一直顯示目前追到的程式碼）</li>
</ol>
<p><img alt="sticky mode example" src="/images/posts-image/2020-will-kobayashi-s-code-encounter-sql-injection/sticky mode.jpg"/></p>
<p>順便記錄一下常用到的 pdbpp 指令</p>
<ul>
<li><code>n</code>: 下一行</li>
<li><code>s</code>: 進到函式</li>
<li><code>p [var]</code> (e.g., <code>p locals()</code>): 印出變數 var</li>
<li><code>args</code>: 印出參數</li>
<li><code>ll</code>: 顯示現在在原始碼的哪裡（原本 pdb 的 longlist）</li>
</ul>
<h3 id="webpy">追 web.py 原始碼</h3>
<p>這部分的紀錄方式會是每進到一次函式 (在 pdb 裡面使用 <code>s</code>) 就會加一個四級標題<br/>
回到原本的函式，則會在標題後面加一個 back</p>
<p>首先當然是從 <code>login</code> 呼叫到 <code>db.select</code> 函式開始追回去</p>
<h4 id="webdbpydbselect">web/db.py::DB::select</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L845">web/db.py#L845</a></li>
</ul>
<p>跑完 874 行的 list comprehension 後，<code>clauses</code> 會包含以下四個部分</p>
<div class="highlight"><pre><span></span><code>(Pdb++) p clauses
[&lt;sql: 'SELECT *'&gt;, &lt;sql: 'FROM USER'&gt;, &lt;sql: 'WHERE account ="1\' OR \'1\'=\'1" AND password="1\' OR \'1\'=\'1"'&gt;]
</code></pre></div>
<p>看起來已經成功將特殊字元跳脫，解決 SQL injection<br/>
所以接下來要去追產生 <code>clause</code> 的 <code>gen_clause</code></p>
<h4 id="webdbpydbgen_clause">web/db.py::DB::gen_clause</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L934">web/db.py#L934</a></li>
</ul>
<p><code>gen_clause</code> 會被呼叫三次，當輸入的參數 sql 是 <code>WHERE</code> 時，會執行到 948 行的 <code>nout = reparam(val, vars)</code><br/>
此時輸入的各個參數如下</p>
<div class="highlight"><pre><span></span><code><span class="p">(</span><span class="n">Pdb</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">sql</span>
<span class="s1">'WHERE'</span>

<span class="p">(</span><span class="n">Pdb</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">val</span>
<span class="s1">'account =$account AND password=$password'</span>

<span class="p">(</span><span class="n">Pdb</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="n">vars</span>
<span class="p">{</span><span class="s1">'account'</span><span class="p">:</span><span class="w"> </span><span class="s2">"1' OR '1'='1"</span><span class="p">,</span><span class="w"> </span><span class="s1">'password'</span><span class="p">:</span><span class="w"> </span><span class="s2">"1' OR '1'='1"</span><span class="p">}</span>
</code></pre></div>
<h4 id="webdbpyreparam">web/db.py::reparam</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L344">web/db.py#L344</a></li>
<li>參數:<ul>
<li>val = <code>'account =$account AND password=$password'</code></li>
<li>vars = <code>{'account': "1' OR '1'='1", 'password': "1' OR '1'='1"}</code></li>
</ul>
</li>
</ul>
<p>一進到 <code>reparm</code> ，這些值就會繼續被傳到 <code>safteval</code></p>
<h4 id="webdbpysafeevalsafeeval">web/db.py::SafeEval::safeeval</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L1699">web/db.py#L1699</a></li>
<li>帶入參數<ul>
<li>text = <code>'account =$account AND password=$password'</code></li>
<li>mapping = <code>{'account': "1' OR '1'='1", 'password': "1' OR '1'='1"}</code></li>
</ul>
</li>
</ul>
<p>1700 行的 <code>Parser</code> 會將 text 分解成四個 SQL 的部分，並且將 nodes 連同 mapping 一個一個帶入 <code>eval_node</code></p>
<div class="highlight"><pre><span></span><code>(Pdb++) p list(nodes)
[Node('text', 'account =', None), Node('param', 'account', None), Node('text', ' AND password=', None), Node('param', 'password', None)]
</code></pre></div>
<h4 id="webdbpysafeevaleval_node">web/db.py::SafeEval::eval_node</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L1703">web/db.py#L1703</a></li>
</ul>
<p><code>self.eval_expr</code> 的功用是在讓 <code>node[1]</code> 能抓到 <code>"1' OR '1'='1"</code><br/>
抓到了字串 <code>"1' OR '1'='1"</code> 後會丟到 <code>sqlquote</code></p>
<h4 id="webdbpysqlquote">web/db.py::sqlquote</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L463">463行</a></li>
<li>參數:<ul>
<li>a = <code>"1' OR '1'='1"</code></li>
</ul>
</li>
</ul>
<p>a 會在 475 行被初始化成 <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L93">SQLParam</a> 物件 ，然後再產生 <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L142">SQLQuery</a> 物件</p>
<h4 id="webdbpysafeevaleval_node-back">web/db.py::SafeEval::eval_node (back)</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L1703">web/db.py#L1703</a></li>
</ul>
<p>回到 <code>eval_node</code> ，就會把剛剛的結果 <code>&lt;sql: '"1\' OR \'1\'=\'1"'&gt;</code> (<code>SQLQuery</code> 物件印出的形式) 回傳</p>
<h4 id="webdbpysafeevalsafeeval-back">web/db.py::SafeEval::safeeval (back)</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L1699">web/db.py#L1699</a></li>
</ul>
<p>1701 行的 <code>[self.eval_node(node, mapping) for node in nodes]</code> 會產生</p>
<!-- blacken-docs:off -->
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">eval_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span>
<span class="p">[</span><span class="s1">'account ='</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">sql</span><span class="p">:</span> <span class="s1">'"1</span><span class="se">\'</span><span class="s1"> OR </span><span class="se">\'</span><span class="s1">1</span><span class="se">\'</span><span class="s1">=</span><span class="se">\'</span><span class="s1">1"'</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">' AND password='</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">sql</span><span class="p">:</span> <span class="s1">'"1</span><span class="se">\'</span><span class="s1"> OR </span><span class="se">\'</span><span class="s1">1</span><span class="se">\'</span><span class="s1">=</span><span class="se">\'</span><span class="s1">1"'</span><span class="o">&gt;</span><span class="p">]</span>
</code></pre></div>
<!-- blacken-docs:on -->
<p>這個 list 會接著被帶入 <code>SQLQuery.join</code> 整合成一整個 SQL 的片段</p>
<h4 id="webdbpysqlqueryjoin">web/db.py::SQLQuery::join</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L254">web/db.py#L254</a></li>
</ul>
<p>277 ~ 285 行的 for loop 執行完會產生一個新的 target (<code>SQLQuery</code> 物件)</p>
<div class="highlight"><pre><span></span><code>(Pdb++) p target
&lt;sql: 'account ="1\' OR \'1\'=\'1" AND password="1\' OR \'1\'=\'1"'&gt;

(Pdb++) p target.items
['account =', &lt;param: "1' OR '1'='1"&gt;, ' AND password=', &lt;param: "1' OR '1'='1"&gt;]

(Pdb++) p target.values()
["1' OR '1'='1", "1' OR '1'='1"]

(Pdb++) p target.query()
'account =%s AND password=%s'
</code></pre></div>
<p>可以發現這時候要回傳的 <code>SQLQuery</code> 物件已經把查詢時跟要帶入的值分開儲存</p>
<h4 id="webdbpyreparamback">web/db.py::reparam（back）</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L344">web/db.py#L344</a></li>
</ul>
<h4 id="webdbpydbgen_clause-back">web/db.py::DB::gen_clause (back)</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L948">web/db.py#L948</a></li>
</ul>
<p>在 956 行，剛剛回傳的 <code>nout</code> 會透過 <code>xjoin</code> 跟字串 <code>WHERE</code> 整合成一個新的 <code>SQLQuery</code> 物件<br/>
字串跟 <code>SQLQuery</code> 相加的行為被定義在 <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L196">196 行</a> 的 <code>__radd__</code><br/>
但因為沒有什麼太意料之外的行為，這裡就不繼續追下去了</p>
<h4 id="webdbpydbselect-back">web/db.py::DB::select (back)</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L874">web/db.py#L874</a></li>
</ul>
<p>取得了回傳的 <code>clauses</code> 後，它會在 879 行的 <code>SQLQuery.join</code> 整合成一個 <code>SQLQuery</code> 物件<br/>
產生 <code>qout</code></p>
<div class="highlight"><pre><span></span><code>(Pdb++) p qout
&lt;sql: 'SELECT * FROM USER WHERE account ="1\' OR \'1\'=\'1" AND password="1\' OR \'1\'=\'1"'&gt;
</code></pre></div>
<p>最後就要看 884 行的 <code>self.query(qout, processed=True)</code> 是不是真的會以參數化的方式執行這段 SQL</p>
<h4 id="webdbpydbquery">web/db.py::DB::query</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L807">web/db.py#L807</a></li>
</ul>
<p>執行到 831 行 <code>self._db_execute(db_cursor, sql_query)</code> 才會用到傳進來的 <code>sql_query</code></p>
<h4 id="webdbpydb_db_execute">web/db.py::DB::_db_execute</h4>
<ul>
<li>位置: <a href="https://github.com/webpy/webpy/blob/0.40/web/db.py#L750">web/db.py#L750</a></li>
</ul>
<p>在 756 行的 <code>_process_query</code> 產生要執行的 SQL query 跟它的參數，回傳的結果分別是</p>
<ul>
<li>query = <code>'SELECT * FROM USER WHERE account =? AND password=?'</code></li>
<li>params = <code>["1' OR '1'='1", "1' OR '1'='1"])</code></li>
</ul>
<p>再帶到 757 行的<code>out = cur.execute(query, params)</code> 直接對資料庫作查詢，所以就不會遇到 SQL injection 了</p>
<h4 id="delete">原本好像是要追 delete 才對</h4>
<p>顧著重現維基百科的例子，竟然忘記了原本要追的其實是另一段程式碼<br/>
不過我想本質應該還是相同的<br/>
有興趣的話，可以拿以下這段 SQL 來測測看 delete 的 SQL injection 是不是真的能清空整個資料表<br/>
<strong>disclaimer: 請不要拿它用在會影響到其他人的程式上 (e.g., production 環境)</strong></p>
<div class="highlight"><pre><span></span><code><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">account</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">''</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="s1">''</span><span class="o">=</span><span class="s1">''</span>
</code></pre></div>
<p><img alt="xkcd joke" src="https://imgs.xkcd.com/comics/exploits_of_a_mom.png"/></p>
<blockquote>
<p>你是不是真的把你的兒子取名為 <code>Rober'); DROP TABLE Students;</code></p>
</blockquote>
<h2 id="_6">結語</h2>
<p>結論是「雖然小林的程式碼可能遇到 SQL injection，但也存在著很簡單的解決方案，只要使用者有讀文件，應該就不會遇到」<br/>
我完全不是資訊安全的專家，只是抱持著對京都動畫和 Python 的愛來追這段程式碼<br/>
如果有說錯或可以補充的部分，再麻煩留言讓我知道 🙏</p>
<p>其實小林家的龍女僕，還有其他場景也有出現 Python<br/>
像是這裡說了小林自從開始寫 Python 後變得開朗了許多呢（誤</p>
<p><img alt="kobayashi becomes hayppier" src="/images/posts-image/2020-will-kobayashi-s-code-encounter-sql-injection/kobayashi becomes hayppier.png"/></p>
<p>我也是自從寫了 Python 後，每次考試都考 100 分呢（並沒有）<br/>
所以大家一起來寫 Python 吧 🐍<br/>
那寫 Python 的人最好的交流平台是什麼呢 🤔<br/>
當然是 <a href="https://tw.pycon.org/">PyCon TW</a> 啊 🤩<br/>
來當 PyCon TW 志工，跟大家交流 Python，變成一個開朗的人吧 💪</p>
<h2 id="one-more-thing">One more thing</h2>
<p>去年七月一場不幸的縱火案，大大的重創了京都動畫<br/>
PyCon JP 2019 時，我也去了鷲宮神社留下我的祝福<br/>
不會日文的我，就只簡單的寫了 <strong>Pray for Kyoani</strong></p>
<p><img alt="pray for kyoani" src="/images/posts-image/2020-will-kobayashi-s-code-encounter-sql-injection/pray for kyoani.jpg"/></p>
<p>即便如此，京阿尼還是很快就站起來<br/>
一年過後的現在宣布「小林家的龍女僕將於 2021 年開播 」🎉</p>
<blockquote class="twitter-tweet"><p dir="ltr" lang="ja">TVアニメ第2期「小林さんちのメイドラゴンS」2021年放送決定！SuperでSupremeなSecond lifeがStartします！<br/>そして、メイドラゴンS(読み:エス)ティザービジュアル公開！ティザーサイトもぜひチェックお願いします！　<a href="https://t.co/pKOgbEe3sL">https://t.co/pKOgbEe3sL</a> <a href="https://twitter.com/hashtag/meidragon?src=hash&amp;ref_src=twsrc%5Etfw">#meidragon</a> <a href="https://t.co/XoyiBPbnvt">pic.twitter.com/XoyiBPbnvt</a></p>— TVアニメ「小林さんちのメイドラゴンS」公式 (@maidragon_anime) <a href="https://twitter.com/maidragon_anime/status/1292838380187746305?ref_src=twsrc%5Etfw">August 10, 2020</a></blockquote>
<script async="" charset="utf-8" src="https://platform.twitter.com/widgets.js"></script>
</section>
<section class="post-footer">
<div class="post-share">
<span class="post-info-label">Share</span>
<a aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=小林的程式會不會遇到 SQL Injection &amp;url=https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;" title="Twitter">
<i aria-hidden="true" class="icon icon-twitter"></i><span class="hidden">Twitter</span>
</a>
<a aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;" title="Facebook">
<i aria-hidden="true" class="icon icon-facebook"></i><span class="hidden">Facebook</span>
</a>
<a aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection&amp;title=小林的程式會不會遇到 SQL Injection" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720');return false;" title="LinkedIn">
<i aria-hidden="true" class="icon icon-linkedin"></i><span class="hidden">LinkedIn</span>
</a>
<a aria-label="Email" class="email" href="mailto:?subject=小林的程式會不會遇到 SQL Injection&amp;body=https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" title="Email">
<i aria-hidden="true" class="icon icon-mail"></i><span class="hidden">Email</span>
</a>
<div class="clear"></div>
</div>
<aside class="post-tags">
<a href="https://blog.wei-lee.me/tag/python.html">Python</a><a href="https://blog.wei-lee.me/tag/anime.html">Anime</a> </aside>
<div class="clear"></div>
</section>
<script type="text/javascript">var use_utterance = true;</script>
<section class="post-comments">
<script async="" crossorigin="anonymous" data-issue-term="https://blog.wei-lee.me/posts/tech/2020/09/will-kobayashi-s-code-encounter-sql-injection" data-label="blog-comment" data-repo="Lee-W/main-blog" data-theme="github-light" src="https://utteranc.es/client.js">
</script>
</section>
<aside class="post-nav">
<div class="clear"></div>
</aside>
</div>
</article>
</main>
<div class="nav-footer">
<nav aria-label="Footer" class="nav-wrapper">
<span class="nav-copy">Those aren't written down are meant to be forgotten © 2023
          <a class="nav-rss" href="https://blog.wei-lee.me/feeds/all.atom.xml" target="_blank" title="RSS"><i class="icon icon-rss"></i></a>
</span>
<span class="nav-credits">



          Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a> • Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a> •
          <a class="menu-item js-theme" data-dark="Dark theme" data-light="Light theme" data-system="System theme" href="#">
<span class="theme-icon"></span><span class="theme-text">System theme</span>
</a>
</span>
</nav>
</div>
</section>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<!-- TODO: minify -->
<script src="https://blog.wei-lee.me/theme/js/jquery.fitvids.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/script.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/clipboard.min.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/copy-to-clipboard.js" type="text/javascript"></script>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3J7XQ46QH5"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3J7XQ46QH5', { 'anonymize_ip': true });
    </script>
<script src="/pagefind/pagefind-ui.js"></script>
<script>
      window.addEventListener('DOMContentLoaded', (event) => {
          new PagefindUI({
              element: "#search",
              showImages: false,
          });
      });
  </script>
<!-- 	The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in article.html, but it needs to be included down here, after jQuery has already loaded. -->
<!-- Add MathJax and FontAwesome for Asciidoc -->\
<script>
  $(document).ready(function () {
    var viewport = $(window);
    var post = $('.post-content');
    // Responsive videos with fitVids
    post.fitVids();

    var mdSelector=".highlight pre";
    var rstSelector=".highlight pre";
    // For ":source-highlighter: highlight.js`" in asciidoc
    var adocSelector="pre.highlight > code[data-lang]"
    var selector=mdSelector;
    // Format code blocks and add line numbers
    function codestyling() {
      $(selector).each(function(i, e) {
        // Code highlight
        hljs.highlightElement(e);
        // No lines for plain text blocks
        if (!$(this).hasClass('language-text')) {
          var code = $(this);
          // Calculate amount of lines
          var lines = code.html().split(/\n(?!$)/g).length;
          var numbers = [];
          if (lines > 1) {
            lines++;
          }
          for (i = 1; i < lines; i++) {
            numbers += '<span class="line" aria-hidden="true">' + i + '</span>';
          }
          code.parent().append('<div class="lines">' + numbers + '</div>');
        }
      });
    }

    // Format code blocks only
    function codestylingWithoutLineNumbers() {
      $(selector).each(function(i, e) {
        // Code highlight
        hljs.highlightElement(e);
      });
    }

    codestylingWithoutLineNumbers();
    // Reading progress bar on window top
    function readingProgress() {
      var postBottom = post.offset().top + post.height();
      var viewportHeight = viewport.height();
      var progress = 100 - (((postBottom - (viewport.scrollTop() + viewportHeight) + viewportHeight / 3) / (postBottom - viewportHeight + viewportHeight / 3)) * 100);
      $('.progress-bar').css('width', progress + '%');
      (progress > 100) ? $('.progress-container').addClass('complete'): $('.progress-container').removeClass('complete');
    }
    readingProgress();
    // Trigger reading progress
    viewport.on({
      'scroll': function() {
        readingProgress();
      },
      'resize': function() {
        readingProgress();
      },
      'orientationchange': function() {
        readingProgress();
      }
    });

  });
</script>
</body>
</html>
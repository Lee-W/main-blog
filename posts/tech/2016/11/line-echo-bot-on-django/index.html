<!DOCTYPE html>

<html lang="zh-tw">
<head>
<meta charset="utf-8"/>
<meta charset="utf-8" content="text/html" http-equiv="Content-Type">
<meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible"/>
<title>Line Echo Bot on Django </title>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="origin" name="referrer"/>
<meta content="Pelican" name="generator"/>
<link href="https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" rel="canonical"/>
<!-- Feed -->
<link href="https://blog.wei-lee.me/feeds/all.atom.xml" rel="alternate" title="Those aren't written down are meant to be forgotten Full Atom Feed" type="application/atom+xml"/>
<!-- TODO: combine -->
<link href="https://blog.wei-lee.me/theme/css/style.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pygments.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/pagefind-ui-custom.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/code-copy.css" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/custom.css" rel="stylesheet" type="text/css"/>
<link href="/pagefind/pagefind-ui.css" rel="stylesheet"/>
<!-- Custom fonts -->
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,300" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css"/>
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->
<script>
    var siteUrl = 'https://blog.wei-lee.me';
  </script>
<script>
    var localTheme = localStorage.getItem('attila_theme');
    switch (localTheme) {
      case 'dark':
        document.documentElement.classList.add('theme-dark');
        break;
      case 'light':
        document.documentElement.classList.add('theme-light');
        break;
      default:
        break;
    }
  </script>
<meta content="單純要寫一個只會 Echo 的 Line Chat Bot 用 flask 只要 85 行的 code 就能解決 官方已經有提供相當清楚的範例flask-echo 了 這篇文章則是提供了 django 的做法 想直接看 code 也可以參考line_echobot" name="description"/>
<meta content="Wei Lee" name="author"/>
<meta content="Django" name="tags"/>
<meta content="Chat Bot" name="tags"/>
<!-- Open Graph -->
<meta content="Those aren't written down are meant to be forgotten" prefix="og: http://ogp.me/ns#" property="og:site_name">
<meta content="Line Echo Bot on Django " prefix="og: http://ogp.me/ns#" property="og:title">
<meta content="單純要寫一個只會 Echo 的 Line Chat Bot 用 flask 只要 85 行的 code 就能解決 官方已經有提供相當清楚的範例flask-echo 了 這篇文章則是提供了 django 的做法 想直接看 code 也可以參考line_echobot" prefix="og: http://ogp.me/ns#" property="og:description">
<meta content="zh-tw" prefix="og: http://ogp.me/ns#" property="og:locale">
<meta content="https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" prefix="og: http://ogp.me/ns#" property="og:url"/>
<meta content="article" prefix="og: http://ogp.me/ns#" property="og:type"/>
<meta content="2016-11-24 03:26:00+08:00" prefix="og: http://ogp.me/ns#" property="article:published_time"/>
<meta content="" prefix="og: http://ogp.me/ns#" property="article:modified_time"/>
<meta content="https://blog.wei-lee.me/author/wei-lee.html" prefix="og: http://ogp.me/ns#" property="article:author"/>
<meta content="Tech" prefix="og: http://ogp.me/ns#" property="article:section">
<meta content="Django" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="Chat Bot" prefix="og: http://ogp.me/ns#" property="article:tag"/>
<meta content="https://blog.wei-lee.me/images/cover.jpeg" prefix="og: http://ogp.me/ns#" property="og:image"/>
<!-- Twitter Card -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="@clleew" name="twitter:site"/>
<meta content="Line Echo Bot on Django " name="twitter:title"/>
<meta content="https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" name="twitter:url"/>
<meta content="https://blog.wei-lee.me/images/cover.jpeg" name="twitter:image:src"/>
<meta content="單純要寫一個只會 Echo 的 Line Chat Bot 用 flask 只要 85 行的 code 就能解決 官方已經有提供相當清楚的範例flask-echo 了 這篇文章則是提供了 django 的做法 想直接看 code 也可以參考line_echobot" name="twitter:description"/>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "Line Echo Bot on Django",
  "headline": "Line Echo Bot on Django",
  "datePublished": "2016-11-24 03:26:00+08:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Wei Lee",
    "url": "https://blog.wei-lee.me/author/wei-lee.html"
  },
  "image": "https://blog.wei-lee.me//images/cover.jpeg",
  "url": "https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django",
  "description": "單純要寫一個只會 Echo 的 Line Chat Bot 用 flask 只要 85 行的 code 就能解決 官方已經有提供相當清楚的範例flask-echo 了 這篇文章則是提供了 django 的做法 想直接看 code 也可以參考line_echobot"
}
</script>
</meta></meta></meta></meta></meta></link></meta><link href="https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Those aren't written down are meant to be forgotten", "item": "https://blog.wei-lee.me"}, {"@type": "ListItem", "position": 2, "name": "Posts", "item": "https://blog.wei-lee.me/posts"}, {"@type": "ListItem", "position": 3, "name": "Tech", "item": "https://blog.wei-lee.me/posts/tech"}, {"@type": "ListItem", "position": 4, "name": "2016", "item": "https://blog.wei-lee.me/posts/tech/2016"}, {"@type": "ListItem", "position": 5, "name": "11", "item": "https://blog.wei-lee.me/posts/tech/2016/11"}, {"@type": "ListItem", "position": 6, "name": "Line echo bot on django", "item": "https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django"}, {"@type": "ListItem", "position": 7, "name": "Index", "item": "https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Wei Lee"}, "publisher": {"@type": "Organization", "name": "Those aren't written down are meant to be forgotten"}, "headline": "Line Echo Bot on Django", "about": "Tech", "datePublished": "2016-11-24 03:26"}</script><meta content="summary" name="twitter:card"/><meta content="https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" property="og:url"/><meta content="article" property="og:type"/><meta content="Line Echo Bot on Django" property="og:title"/><meta content="C" property="og:locale"/></head>
<body class="category-template">
<div class="nav-header">
<nav aria-label="Main" class="nav-wrapper">
<ul>
<li class="nav-🏠 Home" role="presentation"><a href="/"><span>🏠 Home</span></a></li>
<li class="nav-About Me" role="presentation"><a href="/pages/about-me.html"><span>About Me</span></a></li>
<li class="nav-👨‍💻 Tech active" role="presentation"><a href="/category/tech.html"><span>👨‍💻 Tech</span></a></li>
<li class="nav-📚 Book Digest" role="presentation"><a href="/category/book.html"><span>📚 Book Digest</span></a></li>
<li class="nav-💬 Gossiping" role="presentation"><a href="/category/gossiping.html"><span>💬 Gossiping</span></a></li>
<li class="nav-🏷️ Tags" role="presentation"><a href="/tags.html"><span>🏷️ Tags</span></a></li>
<li class="nav-🗄️ Archives" role="presentation"><a href="/archives.html"><span>🗄️ Archives</span></a></li>
<li class="nav-📚 Series" role="presentation"><a href="/series_list.html"><span>📚 Series</span></a></li>
<li class="nav-🔍 Search" role="presentation"><a href="/search.html"><span>🔍 Search</span></a></li>
</ul>
<ul class="nav-meta">
<li class="nav-linkedin"><a aria-label="Linkedin" href="https://tw.linkedin.com/in/clleew" target="_blank"><i aria-hidden="true" class="icon icon-linkedin"></i>
<span>Linkedin</span>
</a></li>
<li class="nav-github"><a aria-label="Github" href="https://github.com/Lee-W" target="_blank"><i aria-hidden="true" class="icon icon-github"></i>
<span>GitHub</span>
</a></li>
<li class="nav-twitter"><a aria-label="Twitter" href="https://twitter.com/clleew" target="_blank"><i aria-hidden="true" class="icon icon-twitter"></i>
<span>Twitter</span>
</a></li>
<li class="nav-search" style="display: none;">
<a title="Search">
<i aria-hidden="true" class="icon icon-search"></i>
<span>Search</span>
</a>
</li>
</ul> </nav>
<div class="nav-wrapper-control">
<div class="inner">
<a class="nav-menu" role="button"><i aria-hidden="true" class="icon icon-menu"></i>Menu</a>
<a class="nav-search" role="button" style="display: none;" title="Search"><i aria-hidden="true" class="icon icon-search"></i></a>
</div>
</div>
</div>
<div aria-label="Close" class="nav-close" role="button"></div>
<section class="page-wrapper" id="wrapper">
<!-- Progressbar -->
<div class="progress-container">
<span class="progress-bar"></span>
</div>
<!-- Page Header -->
<!-- Set your background image for this header on the line below. -->
<header class="post-header has-cover">
<div class="inner">
<span class="post-info">
<span class="post-type">Article</span>
<span class="post-count">Tech</span>
</span>
<h1 class="post-title">
            Line Echo Bot on Django
        </h1>
<div class="post-meta">
<div class="post-meta-avatars">
<figure class="post-meta-avatar avatar">
<a class="author-avatar" href="https://blog.wei-lee.me/author/wei-lee.html">
<img alt="Wei Lee" class="author-profile-image" src="https://blog.wei-lee.me//images/avatar.jpeg"/>
</a>
</figure>
</div>
<h4 class="post-meta-author">
            Wei Lee
          </h4>
<time datetime="2016/11/24 - Thu">2016/11/24 - Thu</time>
          • 4 min read
        </div>
<div class="post-cover cover">
<img alt="Category Tech" src="https://blog.wei-lee.me/images/cover.jpeg"/>
</div>
</div>
</header>
<!-- Post content -->
<main class="content" data-pagefind-body="" role="main">
<article class="post">
<div class="inner">
<section class="post-content">
<p>單純要寫一個只會 Echo 的 Line Chat Bot<br/>
用 flask 只要 85 行的 code 就能解決<br/>
官方已經有提供相當清楚的範例<a href="https://github.com/line/line-bot-sdk-python/tree/master/examples/flask-echo">flask-echo</a> 了</p>
<p>這篇文章則是提供了 django 的做法<br/>
想直接看 code 也可以參考<a href="https://github.com/Lee-W/line_echobot">line_echobot</a></p>
<!--more-->
<h1 id="line-messaging-api-line-bot-sdk-python">Line Messaging API (line-bot-sdk-python)</h1>
<p>詳細的 Line Bot 提供哪些功能，該如何使用<br/>
可以在<a href="https://devdocs.line.me/en/">API Reference - Messaging API</a> 找到<br/>
之後的文章，會談如何使用文字以外的功能</p>
<p>這裡直接使用官方提供的<a href="https://github.com/line/line-bot-sdk-python">line-bot-sdk-python</a></p>
<div class="highlight"><pre><span></span><code>pip3<span class="w"> </span>install<span class="w"> </span>line-bot-sdk
</code></pre></div>
<p>另外官方也提供<a href="https://github.com/line/line-bot-sdk-java">java</a>, <a href="https://github.com/line/line-bot-sdk-go">go</a>, <a href="https://github.com/line/line-bot-sdk-php">php</a>, <a href="https://github.com/line/line-bot-sdk-ruby">ruby</a>, <a href="https://github.com/line/line-bot-sdk-perl">perl</a> 的版本</p>
<h1 id="start-project">Start Project</h1>
<h2 id="create-project">Create Project</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># Create a line_echobot project</span>
django-admin<span class="w"> </span>startproject<span class="w"> </span>line_echobot

<span class="c1"># Create an echobot app</span>
python3<span class="w"> </span>manage.py<span class="w"> </span>startapp<span class="w"> </span>echobot
</code></pre></div>
<h2 id="setup-line-secrets">Setup Line Secrets</h2>
<p>接著設定 Line Bot 的 <code>Channel Secret</code>, <code>Channel Access Token</code><br/>
( 可以在 Line Bot 的 <code>Line Developer</code> 頁面取得 )</p>
<p>不過這些值不該被 git 記錄，所以不該被寫死在 <code>settings.py</code> 中<br/>
建議將這些值寫入環境變數</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">SECRET_KEY</span><span class="o">=</span><span class="s1">'Your django secret key'</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LINE_CHANNEL_ACCESS_TOKEN</span><span class="o">=</span><span class="s1">'Your line channel access token'</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LINE_CHANNEL_SECRET</span><span class="o">=</span><span class="s1">'Your line channel secret'</span>
</code></pre></div>
<p>執行時，讓設定檔先去讀取這些環境變數<br/>
下面的 <code>get_env_variable</code> 函式是用來取得環境變數<br/>
只要有少設定，就會丟出 ImproperlyConfigured 的例外事件中斷執行</p>
<div class="highlight"><pre><span></span><code><span class="c1"># line_echobot/settings.py</span>

<span class="o">...</span>


<span class="k">def</span> <span class="nf">get_env_variable</span><span class="p">(</span><span class="n">var_name</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">"Set the </span><span class="si">{}</span><span class="s2"> environment variable"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var_name</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>


<span class="n">SECRET_KEY</span> <span class="o">=</span> <span class="n">get_env_variable</span><span class="p">(</span><span class="s2">"SECRET_KEY"</span><span class="p">)</span>
<span class="n">LINE_CHANNEL_ACCESS_TOKEN</span> <span class="o">=</span> <span class="n">get_env_variable</span><span class="p">(</span><span class="s2">"LINE_CHANNEL_ACCESS_TOKEN"</span><span class="p">)</span>
<span class="n">LINE_CHANNEL_SECRET</span> <span class="o">=</span> <span class="n">get_env_variable</span><span class="p">(</span><span class="s2">"LINE_CHANNEL_SECRET"</span><span class="p">)</span>

<span class="o">...</span>

<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="s2">"echobot"</span><span class="p">]</span>
</code></pre></div>
<p>不過如果只是單純測試用，這些值也可以直接寫死在 settings.py 中</p>
<p>另外也不要忘了在 <code>INSTLLED_APPS</code> 加入 echobot</p>
<p>一般來說，django 產生 project 時<br/>
<code>settings.py</code> 裡面就會有 secret key<br/>
這裡的做法是把預設的 secret key 刪掉<br/>
設定到環境變數中，避免被 git 記錄下來<br/>
如果還需要另外還要重新產生可以透過<a href="https://gist.github.com/mattseymour/9205591">django-secret-keygen.py</a></p>
<h2 id="setup-line-webhook-url">Setup Line Webhook URL</h2>
<p>再來要設定一個 Webhook URL<br/>
讓 Line 可以把 Bot 收到的訊息傳給我們</p>
<p>先在 project 的 <code>urls.py</code> 設定<br/>
讓 project 可以找到 echobot 這個 app 的 <code>urls.py</code></p>
<div class="highlight"><pre><span></span><code><span class="c1"># line_echobot/urls.py</span>
<span class="o">...</span>

<span class="kn">import</span> <span class="nn">echobot</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="o">...</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s2">"^echobot/"</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s2">"echobot.urls"</span><span class="p">)),</span>
<span class="p">]</span>

<span class="o">...</span>
</code></pre></div>
<p>接著在 echobot 內，創一個 <code>urls.py</code><br/>
並將 url 再導到 <code>callback</code>，呼叫 <code>views.py</code> 裡面的 <code>callback</code> 函式 ( 接下來才會實作 )</p>
<div class="highlight"><pre><span></span><code><span class="c1"># echobot/urls.py</span>

<span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="s2">"^callback/"</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">callback</span><span class="p">),</span>
<span class="p">]</span>
</code></pre></div>
<p>這些都設定完後，要在 Line 那邊設定的 Webhook Url 就是 <code>https://"your domain name"/echobot/callback/</code><br/>
(<code>your domain name</code> 要設定什麼，會在這篇文章的<a href="#https-server">最後</a> 說明)</p>
<h2 id="implement-callback-function">Implement Callback Function</h2>
<p>接下來就是要在 <code>echobot/views.py</code> 實作 <code>callback</code> 了</p>
<h3 id="initial">Initial</h3>
<p>先 import 相關的函式庫</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">HttpResponseForbidden</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>

<span class="kn">from</span> <span class="nn">linebot</span> <span class="kn">import</span> <span class="n">LineBotApi</span><span class="p">,</span> <span class="n">WebhookParser</span><span class="p">,</span> <span class="n">WebhookHandler</span>
<span class="kn">from</span> <span class="nn">linebot.exceptions</span> <span class="kn">import</span> <span class="n">InvalidSignatureError</span><span class="p">,</span> <span class="n">LineBotApiError</span>
<span class="kn">from</span> <span class="nn">linebot.models</span> <span class="kn">import</span> <span class="n">MessageEvent</span><span class="p">,</span> <span class="n">TextMessage</span><span class="p">,</span> <span class="n">TextSendMessage</span>
</code></pre></div>
<p>透過 line_bot_api 傳訊息給 Line，讓 Line 轉傳給使用者</p>
<div class="highlight"><pre><span></span><code><span class="n">line_bot_api</span> <span class="o">=</span> <span class="n">LineBotApi</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LINE_CHANNEL_ACCESS_TOKEN</span><span class="p">)</span>
</code></pre></div>
<h3 id="callback-function">Callback Function</h3>
<p>有兩種方法可以處理 Line Server 送過來的訊息<br/>
這裡先用 Todo 記著，待會再來補上</p>
<div class="highlight"><pre><span></span><code><span class="c1"># TODO: Define Receiver</span>


<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">:</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">"HTTP_X_LINE_SIGNATURE"</span><span class="p">]</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>

        <span class="c1"># TODO: Handler when receiver Line Message</span>

        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">()</span>
</code></pre></div>
<h3 id="validate-signature">Validate Signature</h3>
<p>處理訊息之前<br/>
先確認這個 request 是不是真的是從 Line Server 傳來的<br/>
要確認這件事，需要</p>
<ul>
<li>request 的 body</li>
<li>request header 中的 X-Line-Signature</li>
</ul>
<p>也就是上面的</p>
<div class="highlight"><pre><span></span><code><span class="n">signature</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">"HTTP_X_LINE_SIGNATURE"</span><span class="p">]</span>
<span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>
</code></pre></div>
<h3 id="handle-received-message">Handle Received Message</h3>
<p>取得 body 跟 signature 後<br/>
Line Bot API 會在處理訊息的同時，確認這個訊息是否來自 Line</p>
<p>而處理 Line 傳過來給我們的訊息，有兩種不同的做法</p>
<h4 id="webhookparser">WebhookParser</h4>
<p>WebhookParser 會 Parse 這個訊息的所有欄位<br/>
讓我們針對各種不同型別的訊息做個別的處理<br/>
e.g.</p>
<ul>
<li>UserID</li>
<li>Event Type</li>
<li>Message Content</li>
<li>and etc.</li>
</ul>
<p>在<a href="https://github.com/line/line-bot-sdk-python#webhook-event-object">這裡</a> 可以找到有哪些欄位</p>
<p>這段 code 要取代上面的 <code># TODO: Define Receiver</code></p>
<div class="highlight"><pre><span></span><code><span class="n">parser</span> <span class="o">=</span> <span class="n">WebhookParser</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LINE_CHANNEL_SECRET</span><span class="p">)</span>
</code></pre></div>
<p>下面三段 code 則要取代 <code># TODO: Handler when receiver Line Message</code></p>
<p>parser 會 parse 所有的 event 跟各個 event 中的所有欄位<br/>
如果 request 不是從 Line Server 來的，就會丟出 InvalidSignatureError<br/>
其他使用錯誤，或 Line Server 的問題都會是丟出 LineBotApiError</p>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">events</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
<span class="k">except</span> <span class="n">InvalidSignatureError</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>
<span class="k">except</span> <span class="n">LineBotApiError</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">()</span>
</code></pre></div>
<p>再來要判斷收到的事件是什麼事件<br/>
這個 Bot 只需要 echo 純文字訊息<br/>
所以先判斷這個事件是不是訊息事件，而這個訊息是不是文字訊息</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">MessageEvent</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">TextMessage</span><span class="p">):</span>
            <span class="n">line_bot_api</span><span class="o">.</span><span class="n">reply_message</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">reply_token</span><span class="p">,</span> <span class="n">TextSendMessage</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
</code></pre></div>
<p>最後的 <code>reply_message</code> 函式，讓我們傳訊息給 Line Server<br/>
第一個參數是要回傳要用的 reply_token，可以從事件中取得 （<code>event.reply_token</code>）<br/>
使用這個 reply_token 做回覆，是不用收費的<br/>
不過同一個 reply_token 只能使用一次，而且在一定的時間內就會失效</p>
<p>第二個參數是這次要回傳的訊息<br/>
<a href="https://github.com/line/line-bot-sdk-python#send-message-object">這裡</a> 有所有能回傳的訊息<br/>
也可以傳一個都是訊息的 list 或 tuple<br/>
不過一次最多只能傳 5 個<br/>
只要超過就會有 LineBotApiError</p>
<h4 id="webhookhandler">WebhookHandler</h4>
<p>WebhookHandler 是針對每一種不同的訊息型態註冊一個處理器<br/>
只要收到這樣的訊息，就會丟給對應的處理器<br/>
如果確定每一類訊息，在任何情況下都會有相似的處理方式，就很適合這樣的設計</p>
<p>接下來的三段 code 要取代 <code># TODO: Define Receiver</code></p>
<div class="highlight"><pre><span></span><code><span class="n">handler</span> <span class="o">=</span> <span class="n">WebhookHandler</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LINE_CHANNEL_SECRET</span><span class="p">)</span>
</code></pre></div>
<p>先為 handler 加入，TextMessage 的處理器<br/>
參數是接收到的 event<br/>
這裡做的也是讀取到原本 event 中的文字，並回傳回去</p>
<div class="highlight"><pre><span></span><code><span class="nd">@handler</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MessageEvent</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">TextMessage</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_text_message</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">line_bot_api</span><span class="o">.</span><span class="n">reply_message</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">reply_token</span><span class="p">,</span> <span class="n">TextSendMessage</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>
</code></pre></div>
<p>因為沒有要處理其他訊息<br/>
如果收到其他訊息 (e.g. 貼圖 , 照片 ) 或訊息以外的事件<br/>
使用 default 來回傳 "Currently Not Support None Text Message" 的文字訊息</p>
<div class="highlight"><pre><span></span><code><span class="nd">@handler</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">line_bot_api</span><span class="o">.</span><span class="n">reply_message</span><span class="p">(</span>
        <span class="n">event</span><span class="o">.</span><span class="n">reply_token</span><span class="p">,</span> <span class="n">TextSendMessage</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"Currently Not Support None Text Message"</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>
<p>下面的這段 code 是要取代 <code># TODO: Handler when receiver Line Message</code><br/>
handler 判斷完這個訊息，應該被哪個處理器處理，就會傳給那個函式處理</p>
<div class="highlight"><pre><span></span><code><span class="k">try</span><span class="p">:</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
<span class="k">except</span> <span class="n">InvalidSignatureError</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>
<span class="k">except</span> <span class="n">LineBotApiError</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">()</span>
</code></pre></div>
<h4 id="full-code">Full Code</h4>
<p>由於上面的 code 說明比較分散<br/>
這裡附上兩個版本各自的完整版</p>
<ul>
<li>WebhookParser</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># line_echobot/echobot/views.py</span>
<span class="c1"># WebhookParser version</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">HttpResponseForbidden</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>

<span class="kn">from</span> <span class="nn">linebot</span> <span class="kn">import</span> <span class="n">LineBotApi</span><span class="p">,</span> <span class="n">WebhookParser</span>
<span class="kn">from</span> <span class="nn">linebot.exceptions</span> <span class="kn">import</span> <span class="n">InvalidSignatureError</span><span class="p">,</span> <span class="n">LineBotApiError</span>
<span class="kn">from</span> <span class="nn">linebot.models</span> <span class="kn">import</span> <span class="n">MessageEvent</span><span class="p">,</span> <span class="n">TextMessage</span><span class="p">,</span> <span class="n">TextSendMessage</span>

<span class="n">line_bot_api</span> <span class="o">=</span> <span class="n">LineBotApi</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LINE_CHANNEL_ACCESS_TOKEN</span><span class="p">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">WebhookParser</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LINE_CHANNEL_SECRET</span><span class="p">)</span>


<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">:</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">"HTTP_X_LINE_SIGNATURE"</span><span class="p">]</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">events</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InvalidSignatureError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">LineBotApiError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">MessageEvent</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">TextMessage</span><span class="p">):</span>
                    <span class="n">line_bot_api</span><span class="o">.</span><span class="n">reply_message</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">reply_token</span><span class="p">,</span> <span class="n">TextSendMessage</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">()</span>
</code></pre></div>
<ul>
<li>WebhookHandler</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># line_echobot/echobot/views.py</span>
<span class="c1"># WebhookHandler version</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseBadRequest</span><span class="p">,</span> <span class="n">HttpResponseForbidden</span>
<span class="kn">from</span> <span class="nn">django.views.decorators.csrf</span> <span class="kn">import</span> <span class="n">csrf_exempt</span>

<span class="kn">from</span> <span class="nn">linebot</span> <span class="kn">import</span> <span class="n">LineBotApi</span><span class="p">,</span> <span class="n">WebhookHandler</span>
<span class="kn">from</span> <span class="nn">linebot.exceptions</span> <span class="kn">import</span> <span class="n">InvalidSignatureError</span><span class="p">,</span> <span class="n">LineBotApiError</span>
<span class="kn">from</span> <span class="nn">linebot.models</span> <span class="kn">import</span> <span class="n">MessageEvent</span><span class="p">,</span> <span class="n">TextSendMessage</span><span class="p">,</span> <span class="n">TextMessage</span>

<span class="n">line_bot_api</span> <span class="o">=</span> <span class="n">LineBotApi</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LINE_CHANNEL_ACCESS_TOKEN</span><span class="p">)</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">WebhookHandler</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LINE_CHANNEL_SECRET</span><span class="p">)</span>


<span class="nd">@handler</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MessageEvent</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">TextMessage</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">handle_text_message</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">line_bot_api</span><span class="o">.</span><span class="n">reply_message</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">reply_token</span><span class="p">,</span> <span class="n">TextSendMessage</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>


<span class="nd">@handler</span><span class="o">.</span><span class="n">default</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">line_bot_api</span><span class="o">.</span><span class="n">reply_message</span><span class="p">(</span>
        <span class="n">event</span><span class="o">.</span><span class="n">reply_token</span><span class="p">,</span> <span class="n">TextSendMessage</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s2">"Currently Not Support None Text Message"</span><span class="p">)</span>
    <span class="p">)</span>


<span class="nd">@csrf_exempt</span>
<span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">:</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">[</span><span class="s2">"HTTP_X_LINE_SIGNATURE"</span><span class="p">]</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">"utf-8"</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">InvalidSignatureError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">LineBotApiError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseBadRequest</span><span class="p">()</span>
</code></pre></div>
<p>到了這裡，echo bot 實作的部分就完成了</p>
<p><a name="https-server"></a></p>
<h2 id="https-server-setup-your-domain-name">Https Server (Setup 'your domain name')</h2>
<p>使用這些 Bot 的服務時，大多會要求我們一定要先有一個 Https Server<br/>
除了自己架 Http Server 外，還透過其他服務，更方便我們做測試<br/>
接下來我會分享兩種做法</p>
<ol>
<li>架在<a href="https://www.heroku.com">Heroku</a> ( 由於篇幅的關係，Heroku 會在接下來的文章談 )</li>
<li>使用<a href="https://ngrok.com">ngrok</a></li>
</ol>
<h3 id="ngrok">ngrok</h3>
<p>ngrok 提供的服務是<br/>
讓外部的訊息先經過 ngrok 的 server，ngrok 再將這個訊息傳給你的 server<br/>
回傳時也是從你的 server 傳給 ngrok 的 server，再把訊息傳出去<br/>
所以外部都只會看到 ngrok 的 server</p>
<p><img alt="ngrok" src="https://ngrok.com/static/img/demo.png"/></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Install ngrok on mac</span>
brew<span class="w"> </span>cask<span class="w"> </span>install<span class="w"> </span>ngrok
</code></pre></div>
<p>先把 django 的 server run 起來</p>
<div class="highlight"><pre><span></span><code>python3<span class="w">  </span>manage.py<span class="w"> </span>runserver
</code></pre></div>
<p>預設 django 的 port 是 8000<br/>
這裡並不需要使用 0.0.0.0:8000，讓外部可以連到這個 django server<br/>
ngrok 會把 request 傳到 local 端相對應的 port</p>
<p>接著就要用 ngrok 將 request 導到本地端的 port 8000</p>
<div class="highlight"><pre><span></span><code>ngrok<span class="w"> </span>http<span class="w"> </span><span class="m">8000</span>
</code></pre></div>
<p><img alt="1_ngrok_example" src="/images/posts-image/2016-11-24-line-echo-bot-on-django/r525wEI.png"/></p>
<p>再來到 Line Bot 的 <code>Line Developer</code> 頁面設定 Webhook URL<br/>
這時候填上 ngrok 後的 https 那串 url，再加上 <code>echobot/callback/</code>( 我們設定的 callback url)<br/>
(e.g. <code>https://2.....f.ngrok.io/echobot/callback/</code>)<br/>
<img alt="2_webhook_url" src="/images/posts-image/2016-11-24-line-echo-bot-on-django/qVWlwoK.png"/></p>
<p>值得注意的是我的 Webhook URL 下面有一個 <code>Read timeout.</code><br/>
如果按了後面的 Verify，Line Server 會傳一些測試訊息過來<br/>
但是那個 reply_token 是無法被回覆的<br/>
這時候在 Server 就會丟出 LineBotApiError<br/>
不過沒關係，這只是給我們檢查用的<br/>
並沒有一定要通過才能使用 Line Bot</p>
<p>這時候加 Bot 為好友，就可以開始跟它聊天了<br/>
<img alt="3_message_sample" src="/images/posts-image/2016-11-24-line-echo-bot-on-django/boxeHoG.png"/></p>
<p>如果你發現除了 echo 訊息外，還有其他的訊息<br/>
可能就是沒有把 Atuo Reply Message 關掉<br/>
這時候就可以去 Line Bot 的 <code>LINE@ Manager</code><br/>
<code>Settings</code> → <code>Bot Settings</code> 把它關掉<br/>
或者到 <code>Messages</code> → <code>Auto Reply Message</code> 做修改訊息內容</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="http://studyhost.blogspot.tw/2016/10/line-messaging-api-line-bot-v2.html">新版 Line@ Messaging API 使用心得 (Line Bot v2)</a></li>
<li><a href="http://jiunjiun.logdown.com/posts/2016/10/06/linebot-with-sinatra">LineBot - Sinatra</a></li>
<li><a href="https://ngrok.com">ngrok</a></li>
</ul>
</section>
<section class="post-footer">
<div class="post-share">
<span class="post-info-label">Share</span>
<a aria-label="Twitter" class="twitter" href="https://twitter.com/share?text=Line Echo Bot on Django&amp;url=https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Twitter">
<i aria-hidden="true" class="fab fa-twitter"></i>
<span class="hidden">Twitter</span>
</a>
<a aria-label="Facebook" class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Facebook">
<i aria-hidden="true" class="fa-brands fa-facebook"></i>
<span class="hidden">Facebook</span>
</a>
<a aria-label="LinkedIn" class="linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django&amp;title=Line Echo Bot on Django" onclick="window.open(this.href, 'linkedin-share', 'width=930,height=720'); return false;" title="LinkedIn">
<i aria-hidden="true" class="fa-brands fa-linkedin"></i>
<span class="hidden">LinkedIn</span>
</a>
<a aria-label="Mastodon" class="mastodon" href="https://mtd.pythonasia.org/share?text=Line%20Echo%20Bot%20on%20Django%20https%3A//blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" onclick="window.open(this.href, 'mastodon-share', 'width=930,height=720'); return false;" title="Mastodon">
<i aria-hidden="true" class="fa-brands fa-mastodon fa-xl" style="color: #74C0FC;"></i>
<span class="hidden">Mastodon</span>
</a>
<a aria-label="Email" class="email" href="mailto:?subject=Line Echo Bot on Django&amp;body=https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" title="Email">
<i aria-hidden="true" class="fa-solid fa-envelope"></i>
<span class="hidden">Email</span>
</a>
<div class="clear"></div>
</div>
<aside class="post-tags">
<a href="https://blog.wei-lee.me/tag/django.html">Django</a><a href="https://blog.wei-lee.me/tag/chat-bot.html">Chat Bot</a> </aside>
<div class="clear"></div>
<div class="series">
<p>This post is part 3 of the "Line Bot Tutorial" series:</p>
<ol class="parts">
<li>
<a href="https://blog.wei-lee.me/posts/tech/2016/11/introduction-to-chatbot">Introduction to Chatbot</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2016/11/apply-line-messaging-api">Apply Line Messaging API</a>
</li>
<li class="active">
<a href="https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django">Line Echo Bot on Django</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2016/11/deploy-linebot-on-heroku">Deploy LineBot on Heroku</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2016/11/more-about-line-messaging-api-template-messages">More About Line Messaging API - Template Messages</a>
</li>
<li>
<a href="https://blog.wei-lee.me/posts/tech/2016/11/more-than-just-echo-bot">More than Just Echo Bot</a>
</li>
</ol>
</div>
</section>
<aside class="post-nav">
<a class="post-nav-next" href="https://blog.wei-lee.me/posts/tech/2016/11/deploy-linebot-on-heroku">
<section class="post-nav-teaser">
<i class="icon icon-arrow-left"></i>
<h2 class="post-nav-title">Deploy LineBot on Heroku</h2>
<p class="post-nav-excerpt">上一篇提到如何用 ngrok 讓我們可以不用架 Https Server，直接在本地端測試 Bot 再來要談的是如何把 Bot 部署到 Heroku 上</p>
<p class="post-nav-meta"><time datetime="2016/11/27 - Sun">2016/11/27 - Sun</time></p>
</section>
</a>
<a class="post-nav-prev" href="https://blog.wei-lee.me/posts/tech/2016/11/apply-line-messaging-api">
<section class="post-nav-teaser">
<i class="icon icon-arrow-right"></i>
<h2 class="post-nav-title">Apply Line Messaging API</h2>
<p class="post-nav-excerpt">先到Messaging API 申請帳號 開始使用 Messaging API 和 開始使用 Developer Trial 申請到的帳號是不同的...</p>
<p class="post-nav-meta"><time datetime="2016/11/22 - Tue">2016/11/22 - Tue</time></p>
</section>
</a>
<div class="clear"></div>
</aside>
</div>
<script type="text/javascript">var use_utterance = true;</script>
<section class="post-comments">
<script async="" crossorigin="anonymous" data-issue-term="https://blog.wei-lee.me/posts/tech/2016/11/line-echo-bot-on-django" data-label="blog-comment" data-repo="Lee-W/main-blog" data-theme="github-light" src="https://utteranc.es/client.js">
</script>
</section>
</article>
</main>
<div class="nav-footer">
<nav aria-label="Footer" class="nav-wrapper">
<span class="nav-copy">Those aren't written down are meant to be forgotten © 2023
          <a class="nav-rss" href="https://blog.wei-lee.me/feeds/all.atom.xml" target="_blank" title="RSS"><i class="icon icon-rss"></i></a>
</span>
<span class="nav-credits">



          Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a> • Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a> •
          <a class="menu-item js-theme" data-dark="Dark theme" data-light="Light theme" data-system="System theme" href="#">
<span class="theme-icon"></span><span class="theme-text">System theme</span>
</a>
</span>
</nav>
</div>
</section>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.slim.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
<!-- TODO: minify -->
<script src="https://blog.wei-lee.me/theme/js/jquery.fitvids.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/script.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/clipboard.min.js" type="text/javascript"></script>
<script src="https://blog.wei-lee.me/theme/js/copy-to-clipboard.js" type="text/javascript"></script>
<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3J7XQ46QH5"></script>
<script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-3J7XQ46QH5', { 'anonymize_ip': true });
    </script>
<script src="/pagefind/pagefind-ui.js"></script>
<script>
      window.addEventListener('DOMContentLoaded', (event) => {
          new PagefindUI({
              element: "#search",
              showImages: false,
          });
      });
  </script>
<!-- 	The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in article.html, but it needs to be included down here, after jQuery has already loaded. -->
<!-- Add MathJax and FontAwesome for Asciidoc -->\
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" rel="stylesheet"/>
<script>
  $(document).ready(function () {
    var viewport = $(window);
    var post = $('.post-content');
    // Responsive videos with fitVids
    post.fitVids();

    var mdSelector=".highlight pre code";
    var rstSelector=".highlight pre code";
    // For ":source-highlighter: highlight.js`" in asciidoc
    var adocSelector="pre.highlight > code[data-lang]"
    var selector=mdSelector;
    // Format code blocks and add line numbers
    function codestyling() {
      $(selector).each(function(i, e) {
        // Code highlight
        hljs.highlightElement(e);
        // No lines for plain text blocks
        if (!$(this).hasClass('language-text')) {
          var code = $(this);
          // Calculate amount of lines
          var lines = code.html().split(/\n(?!$)/g).length;
          var numbers = [];
          if (lines > 1) {
            lines++;
          }
          for (i = 1; i < lines; i++) {
            numbers += '<span class="line" aria-hidden="true">' + i + '</span>';
          }
          code.parent().append('<div class="lines">' + numbers + '</div>');
        }
      });
    }

    // Format code blocks only
    function codestylingWithoutLineNumbers() {
      $(selector).each(function(i, e) {
        // Code highlight
        hljs.highlightElement(e);
      });
    }

    codestylingWithoutLineNumbers();
    // Reading progress bar on window top
    function readingProgress() {
      var postBottom = post.offset().top + post.height();
      var viewportHeight = viewport.height();
      var progress = 100 - (((postBottom - (viewport.scrollTop() + viewportHeight) + viewportHeight / 3) / (postBottom - viewportHeight + viewportHeight / 3)) * 100);
      $('.progress-bar').css('width', progress + '%');
      (progress > 100) ? $('.progress-container').addClass('complete'): $('.progress-container').removeClass('complete');
    }
    readingProgress();
    // Trigger reading progress
    viewport.on({
      'scroll': function() {
        readingProgress();
      },
      'resize': function() {
        readingProgress();
      },
      'orientationchange': function() {
        readingProgress();
      }
    });

  });
</script>
</body>
</html>
<!DOCTYPE html>

<html lang="zh-tw">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" rel="stylesheet"/>
<link href="https://blog.wei-lee.me/theme/css/elegant.prod.9e9d5ce754.css" media="screen" rel="stylesheet" type="text/css"/>
<link href="https://blog.wei-lee.me/theme/css/custom.css" media="screen" rel="stylesheet" type="text/css"/>
<link href="//fonts.googleapis.com" rel="dns-prefetch"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<meta content="Wei Lee" name="author">
<meta content="article" property="og:type">
<meta content="summary" name="twitter:card"/>
<meta content="Data, Version Control, DVC, Tech, " name="keywords">
<meta content="DVC - Pipeline Versioning " property="og:title">
<meta content="https://blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning" property="og:url"/>
<meta content="We've versioned our data in the previous post. This article will demonstrate how we could define a data pipeline and version it through DVC. Pipeline versioning We'll continue using dvc_example. You can checkout to tag v3-remove-2-rows to follow along. Split training logic into different stages In the original design, we …" property="og:description"/>
<meta content="Those aren't written down are meant to be forgotten" property="og:site_name"/>
<meta content="Wei Lee" property="og:article:author"/>
<meta content="2021-06-20T11:30:00+08:00" property="og:article:published_time"/>
<meta content="2021-06-27T17:58:00+08:00" property="og:article:modified_time"/>
<meta content="DVC - Pipeline Versioning " name="twitter:title"/>
<meta content="We've versioned our data in the previous post. This article will demonstrate how we could define a data pipeline and version it through DVC. Pipeline versioning We'll continue using dvc_example. You can checkout to tag v3-remove-2-rows to follow along. Split training logic into different stages In the original design, we …" name="twitter:description"/>
<title>DVC - Pipeline Versioning  · Those aren't written down are meant to be forgotten
</title>
<link href="https://blog.wei-lee.me/feeds/all.atom.xml" rel="alternate" title="Those aren't written down are meant to be forgotten - Full Atom Feed" type="application/atom+xml">
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-3J7XQ46QH5"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-3J7XQ46QH5');
</script>
</link></meta></meta></meta></meta><link href="https://blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning" rel="canonical"/><script type="application/ld+json">{"@context": "https://schema.org", "@type": "BreadcrumbList", "itemListElement": [{"@type": "ListItem", "position": 1, "name": "Those aren't written down are meant to be forgotten", "item": "https://blog.wei-lee.me"}, {"@type": "ListItem", "position": 2, "name": "Posts", "item": "https://blog.wei-lee.me/posts"}, {"@type": "ListItem", "position": 3, "name": "Tech", "item": "https://blog.wei-lee.me/posts/tech"}, {"@type": "ListItem", "position": 4, "name": "2021", "item": "https://blog.wei-lee.me/posts/tech/2021"}, {"@type": "ListItem", "position": 5, "name": "06", "item": "https://blog.wei-lee.me/posts/tech/2021/06"}, {"@type": "ListItem", "position": 6, "name": "Dvc pipeline versioning", "item": "https://blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning"}, {"@type": "ListItem", "position": 7, "name": "Index", "item": "https://blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning/index.html"}]}</script><script type="application/ld+json">{"@context": "https://schema.org", "@type": "Article", "author": {"@type": "Person", "name": "Wei Lee"}, "publisher": {"@type": "Organization", "name": "Those aren't written down are meant to be forgotten"}, "headline": "DVC - Pipeline Versioning", "about": "Tech", "datePublished": "2021-06-20 11:30"}</script></head>
<body>
<div id="content">
<div class="navbar navbar-static-top">
<div class="navbar-inner">
<div class="container-fluid">
<a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
<span class="icon-bar"></span>
<span class="icon-bar"></span>
<span class="icon-bar"></span>
</a>
<a class="brand" href="https://blog.wei-lee.me/"><span class="site-name">Those aren't written down are meant to be forgotten</span></a>
<div class="nav-collapse collapse">
<ul class="nav pull-right top-menu">
<li>
<a href="https://blog.wei-lee.me">Home</a>
</li>
<li><a href="https://blog.wei-lee.me/pages/about-me.html">About Me</a></li>
<li><a href="https://blog.wei-lee.me/categories.html">Categories</a></li>
<li><a href="https://blog.wei-lee.me/tags.html">Tags</a></li>
<li><a href="https://blog.wei-lee.me/archives.html">Archives</a></li>
<li><form action="https://blog.wei-lee.me/search.html" class="navbar-search" onsubmit="return validateForm(this.elements['q'].value);"> <input class="search-query" id="tipue_search_input" name="q" placeholder="Search" type="text"/></form></li>
</ul>
</div>
</div>
</div>
</div>
<div class="container-fluid">
<div class="row-fluid">
<div class="span1"></div>
<div class="span10">
<article itemscope="">
<div class="row-fluid">
<header class="page-header span10 offset2">
<h1>
<a href="https://blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning">
                DVC - Pipeline Versioning
            </a>
</h1>
</header>
</div>
<div class="row-fluid">
<div class="span2 table-of-content">
<nav>
<h4>Contents</h4>
<div class="toc">
<ul>
<li><a href="#pipeline-versioning">Pipeline versioning</a><ul>
<li><a href="#split-training-logic-into-different-stages">Split training logic into different stages</a></li>
<li><a href="#add-the-first-stage-in-our-pipeline-to-dvc">Add the first stage in our pipeline to DVC</a></li>
<li><a href="#define-the-whole-pipeline">Define the whole pipeline</a></li>
<li><a href="#run-the-pipeline">Run the pipeline</a></li>
<li><a href="#track-parameters">Track parameters</a></li>
<li><a href="#track-metrics">Track metrics</a></li>
<li><a href="#plotting">plotting</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
<li><a href="#one-more-thing-when-should-we-save-files-to-dvc-instead-of-git">One more thing: When should we save files to DVC instead of git?</a></li>
<li><a href="#reference">Reference</a></li>
</ul>
</div>
</nav>
</div>
<div class="span8 article-content">
<p>We've versioned our data in the previous post. This article will demonstrate how we could define a data pipeline and version it through DVC.</p>
<!--more-->
<h2 id="pipeline-versioning">Pipeline versioning</h2>
<p>We'll continue using <a href="https://github.com/Lee-W/dvc_example/">dvc_example</a>. You can checkout to tag <a href="https://github.com/Lee-W/dvc_example/tree/v3-remove-2-rows">v3-remove-2-rows</a> to follow along.</p>
<h3 id="split-training-logic-into-different-stages">Split training logic into different stages</h3>
<p>In the original design, we use <code>pipenv run python digit_recognizer/digit_recognizer.py</code> to run the whole training process. We'll split them into <code>process-data</code>, <code>train</code>, and <code>report</code> stages.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="o">......</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">"process-data"</span><span class="p">:</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="s2">"data/digit_data.csv"</span><span class="p">,</span> <span class="s2">"data/digit_target.csv"</span><span class="p">)</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">export_processed_data</span><span class="p">((</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="s2">"output/training_data.pkl"</span><span class="p">)</span>
        <span class="n">export_processed_data</span><span class="p">((</span><span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">),</span> <span class="s2">"output/testing_data.pkl"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">"train"</span><span class="p">:</span>
        <span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">load_processed_data</span><span class="p">(</span><span class="s2">"output/training_data.pkl"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="n">export_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s2">"output/model.pkl"</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">command</span> <span class="o">==</span> <span class="s2">"report"</span><span class="p">:</span>
        <span class="n">X_test</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">load_processed_data</span><span class="p">(</span><span class="s2">"output/testing_data.pkl"</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s2">"output/model.pkl"</span><span class="p">)</span>
        <span class="n">predicted_y</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
        <span class="n">output_test_data_results</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predicted_y</span><span class="p">)</span>
        <span class="n">output_metrics</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">predicted_y</span><span class="p">)</span>
</pre></div>
<p>You can view the complete code change on <a href="https://github.com/Lee-W/dvc_example/compare/v3-remove-2-rows...v4-split-pipeline-logic">v3-remove-2-rows...v4-split-pipeline-logic</a>.</p>
<p>After these changes, we'll use the following 3 commands to run the pipeline.</p>
<div class="highlight"><pre><span></span>pipenv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span>process-data
pipenv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span>train
pipenv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span>report
</pre></div>
<h3 id="add-the-first-stage-in-our-pipeline-to-dvc">Add the first stage in our pipeline to DVC</h3>
<p>We add stages through <a href="https://dvc.org/doc/command-reference/run">dvc run</a> command. Let's add our first stage <code>process-data</code>.</p>
<div class="highlight"><pre><span></span><span class="c1"># add process-data stage</span>
$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>process-data<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>data/digit_data.csv<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>data/digit_target.csv<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/training_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/testing_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">"pipenv run python digit_recognizer/digit_recognizer.py process-data"</span>

Running<span class="w"> </span>stage<span class="w"> </span><span class="s1">'process-data'</span>:
&gt;<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span>process-data
Creating<span class="w"> </span><span class="s1">'dvc.yaml'</span>
Adding<span class="w"> </span>stage<span class="w"> </span><span class="s1">'process-data'</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s1">'dvc.yaml'</span>
Generating<span class="w"> </span>lock<span class="w"> </span>file<span class="w"> </span><span class="s1">'dvc.lock'</span>
Updating<span class="w"> </span>lock<span class="w"> </span>file<span class="w"> </span><span class="s1">'dvc.lock'</span>

To<span class="w"> </span>track<span class="w"> </span>the<span class="w"> </span>changes<span class="w"> </span>with<span class="w"> </span>git,<span class="w"> </span>run:

git<span class="w"> </span>add<span class="w"> </span>dvc.yaml<span class="w"> </span>output/.gitignore<span class="w"> </span>dvc.lock


Next,<span class="w"> </span>we<span class="w"> </span>add<span class="w"> </span>these<span class="w"> </span>DVC<span class="w"> </span>files<span class="w"> </span>into<span class="w"> </span>git<span class="w"> </span>to<span class="w"> </span>track.

<span class="c1"># add DVC configuration to git and commit</span>
$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>dvc.yaml<span class="w"> </span>dvc.lock<span class="w"> </span>output/.gitignore
$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>cz<span class="w"> </span>commit
</pre></div>
<p>See what's composed of this command</p>
<ul>
<li><code>--name</code>: the name of this stage<ul>
<li>It must be unique throughout the project.</li>
</ul>
</li>
<li><code>-d</code>: the dependencies of this stage<ul>
<li>All the files related to running this stage should be counted as dependencies.</li>
<li>DVC won't these dependency files into it storage but only store the hashes of them.</li>
<li>In this example, we need <code>digit_recognizer/digit_recognizer.py</code> to load <code>data/digit_data.csv</code> and <code>data/digit_target.csv</code> to process the data. Thus, these 3 files are added as dependencies.</li>
</ul>
</li>
<li><code>-o</code>: the output files of this stage<ul>
<li>DVC stores these files in its storage. If you want to track it through git or simply don't want to track it, you can use <code>-O</code> instead.</li>
</ul>
</li>
</ul>
<p><code>dvc run</code> runs the stage right after adding it. If you don't want DVC to run it, you can add <code>--no-exec</code> flag or <a href="https://dvc.org/doc/command-reference/stage/add">dvc stage add</a> with the same arguments</p>
<p>After adding a stage, DVC updates <code>dvc.yaml</code>, <code>output/.gitignore</code> and <code>dvc.lock</code></p>
<h4><code>dvc.yaml</code>: the definition of stages</h4>
<div class="highlight"><pre><span></span><span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="nt">process-data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pipenv run python digit_recognizer/digit_recognizer.py process-data</span>
<span class="w">    </span><span class="nt">deps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data/digit_data.csv</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data/digit_target.csv</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">digit_recognizer/digit_recognizer.py</span>
<span class="w">    </span><span class="nt">outs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/testing_data.pkl</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/training_data.pkl</span>
</pre></div>
<p>DVC transforms what we defined in <code>dvc run</code> to a human-readable format and store it. But if you already know how to define the stage, you can edit <code>dvc.yaml</code> directly. In addition, there're advanced techniques like <a href="https://dvc.org/doc/user-guide/project-structure/pipelines-files#templating">Templating</a> and <a href="https://dvc.org/doc/user-guide/project-structure/pipelines-files#foreach-stages">foreach stages</a> that can help us define complicated stages.</p>
<h4><code>dvc.lock</code>: the hashes of dependencies and outputs</h4>
<div class="highlight"><pre><span></span><span class="nt">schema</span><span class="p">:</span><span class="w"> </span><span class="s">'2.0'</span>
<span class="nt">stages</span><span class="p">:</span>
<span class="w">  </span><span class="nt">process-data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pipenv run python digit_recognizer/digit_recognizer.py process-data</span>
<span class="w">    </span><span class="nt">deps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data/digit_data.csv</span>
<span class="w">      </span><span class="nt">md5</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">942481fce846fb9750b7b8023c80a5ef</span>
<span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">490582</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data/digit_target.csv</span>
<span class="w">      </span><span class="nt">md5</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2a6cfa13365ac9b3af5146133aca6789</span>
<span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3590</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">digit_recognizer/digit_recognizer.py</span>
<span class="w">      </span><span class="nt">md5</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65ecf27479538a74ade42462b1566db1</span>
<span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3629</span>
<span class="w">    </span><span class="nt">outs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/testing_data.pkl</span>
<span class="w">      </span><span class="nt">md5</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">78be1761d227f71b1a8f858fed766982</span>
<span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">529016</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/training_data.pkl</span>
<span class="w">      </span><span class="nt">md5</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">f95e8f978a05395ba23479ff60eda076</span>
<span class="w">      </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">528427</span>
</pre></div>
<p>DVC uses these hashes to know whether there's any modification on our stages. Therefore, we only add deterministic files. Randomness might make this lock file meaningless. Take a look at the "Avoiding unexpected behavior" in <a href="https://dvc.org/doc/command-reference/run#description">dvc run - Description</a> could save your time debugging unexpected failure.</p>
<h4><code>output/.gitignore</code>: Add files that DVC should track to gitignore</h4>
<h3 id="define-the-whole-pipeline">Define the whole pipeline</h3>
<p>With similar command, we can add <code>train</code> and <code>report</code> stages to our pipeline.</p>
<div class="highlight"><pre><span></span><span class="c1"># add train stage</span>
pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>train<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>output/training_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/model.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">"pipenv run python digit_recognizer/digit_recognizer.py train"</span>

<span class="c1"># add report stage</span>
pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>run<span class="w"> </span>--name<span class="w"> </span>report<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>output/testing_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>output/model.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/metrics.json<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/test_data_results.csv<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">"pipenv run python digit_recognizer/digit_recognizer.py report"</span>

<span class="c1"># add DVC configuration to git and commit</span>
git<span class="w"> </span>add<span class="w"> </span>dvc.yaml<span class="w"> </span>dvc.lock<span class="w"> </span>model/.gitignore
pipenv<span class="w"> </span>run<span class="w"> </span>cz<span class="w"> </span>commit
</pre></div>
<p>Similar to our previous step, DVC updates <code>dvc.yaml</code>, <code>dvc.lock</code> and <code>output/.gitignore</code>.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">$ cat dvc.yaml</span>

<span class="nn">...</span>
<span class="w">  </span><span class="nt">train</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pipenv run python digit_recognizer/digit_recognizer.py train</span>
<span class="w">    </span><span class="nt">deps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">digit_recognizer/digit_recognizer.py</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/training_data.pkl</span>
<span class="w">    </span><span class="nt">outs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/model.pkl</span>
<span class="w">  </span><span class="nt">report</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cmd</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pipenv run python digit_recognizer/digit_recognizer.py report</span>
<span class="w">    </span><span class="nt">deps</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">digit_recognizer/digit_recognizer.py</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/model.pkl</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/testing_data.pkl</span>
<span class="w">    </span><span class="nt">outs</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/metrics.json</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output/test_data_results.csv</span>
</pre></div>
<p>We can visualize the pipeline through <a href="https://dvc.org/doc/command-reference/dag">dvc dag</a></p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>dag

<span class="w">    </span>+----------+
<span class="w">    </span><span class="p">|</span><span class="w"> </span>data.dvc<span class="w"> </span><span class="p">|</span>
<span class="w">    </span>+----------+
<span class="w">          </span>*
<span class="w">          </span>*
<span class="w">          </span>*
<span class="w">  </span>+--------------+
<span class="w">  </span><span class="p">|</span><span class="w"> </span>process-data<span class="w"> </span><span class="p">|</span>
<span class="w">  </span>+--------------+
<span class="w">     </span>**<span class="w">        </span>**
<span class="w">   </span>**<span class="w">            </span>*
<span class="w">  </span>*<span class="w">               </span>**
+-------+<span class="w">           </span>*
<span class="p">|</span><span class="w"> </span>train<span class="w"> </span><span class="p">|</span><span class="w">         </span>**
+-------+<span class="w">        </span>*
<span class="w">     </span>**<span class="w">        </span>**
<span class="w">       </span>**<span class="w">    </span>**
<span class="w">         </span>*<span class="w">  </span>*
<span class="w">     </span>+--------+
<span class="w">     </span><span class="p">|</span><span class="w"> </span>report<span class="w"> </span><span class="p">|</span>
<span class="w">     </span>+--------+
</pre></div>
<p>If you pay attention to each parameter passes to <code>dvc run</code>, you might have noticed that <code>train</code> stage depends on the output <code>output/training_data.pkl</code> from <code>process-data</code> stage. This is how DVC decides the order of each stage in our pipeline.</p>
<h3 id="run-the-pipeline">Run the pipeline</h3>
<p>Contradict to its naming, <code>dvc run</code> is only used for defining the stage and run it for the first time. <a href="https://dvc.org/doc/command-reference/repro#repro">dvc repro</a> (reproduce) is what we use to run the pipeline,</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>repro

<span class="s1">'data.dvc'</span><span class="w"> </span>didn<span class="s1">'t change, skipping</span>
<span class="s1">Stage '</span>train<span class="s1">' didn'</span>t<span class="w"> </span>change,<span class="w"> </span>skipping
Data<span class="w"> </span>and<span class="w"> </span>pipelines<span class="w"> </span>are<span class="w"> </span>up<span class="w"> </span>to<span class="w"> </span>date.
</pre></div>
<p>Because we've not yet made any changes since we define our pipeline, DVC won't waste time and resources to generate results it has already known. However, you can add a <code>-f</code> flag to force DVC to rerun the pipeline.</p>
<p>Next, we'll change gamma to 0.01 to see how <code>dvc repro</code> works.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">train_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">clf</span> <span class="o">=</span> <span class="n">svm</span><span class="o">.</span><span class="n">SVC</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
<p>Because our dependency <code>digit_recognizer/digit_recognizer.py</code> has been modified, DVC expects the result might be different. Therefore, we can now run <code>dvc repro</code>.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>repro

<span class="s1">'data.dvc'</span><span class="w"> </span>didn<span class="s1">'t change, skipping</span>
<span class="s1">Running stage '</span>process-data<span class="s1">':</span>
<span class="s1">&gt; pipenv run python digit_recognizer/digit_recognizer.py process-data</span>
<span class="s1">Updating lock file '</span>dvc.lock<span class="s1">'</span>

<span class="s1">Running stage '</span>train<span class="s1">':</span>
<span class="s1">&gt; pipenv run python digit_recognizer/digit_recognizer.py train</span>
<span class="s1">Updating lock file '</span>dvc.lock<span class="s1">'</span>

<span class="s1">Running stage '</span>report<span class="s1">':</span>
<span class="s1">&gt; pipenv run python digit_recognizer/digit_recognizer.py report</span>
<span class="s1">Updating lock file '</span>dvc.lock<span class="err">'</span>

To<span class="w"> </span>track<span class="w"> </span>the<span class="w"> </span>changes<span class="w"> </span>with<span class="w"> </span>git,<span class="w"> </span>run:

git<span class="w"> </span>add<span class="w"> </span>dvc.lock
Use<span class="w"> </span><span class="sb">`</span>dvc<span class="w"> </span>push<span class="sb">`</span><span class="w"> </span>to<span class="w"> </span>send<span class="w"> </span>your<span class="w"> </span>updates<span class="w"> </span>to<span class="w"> </span>remote<span class="w"> </span>storage.
</pre></div>
<p>By running <code>git diff</code>, you'll find out that the hashes of <code>digit_recognizer/digit_recognizer.py</code>, <code>output/model.pkl</code>, <code>output/metrics.json</code>, <code>output/test_data_results.csv</code> inside <code>dvc.lock</code> has been changed.</p>
<h3 id="track-parameters">Track parameters</h3>
<p>In the previous section, even though we change only the parameter related to the <code>train</code> stage, DVC still reruns the whole pipeline. To make DVC runs only the stages affect by the changed parameters, we can refactor our code to load parameters from a separate file <code>params.yaml</code>.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">load_params</span><span class="p">(</span><span class="s2">"params.yaml"</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">(</span><span class="s2">"data/digit_data.csv"</span><span class="p">,</span> <span class="s2">"data/digit_target.csv"</span><span class="p">)</span>
    <span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">process_data</span><span class="p">(</span>
        <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">"process_data"</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">train_model</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">"train"</span><span class="p">])</span>
    <span class="n">export_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="o">......</span>
</pre></div>
<p>This is how <code>params.yaml</code> looks like.</p>
<div class="highlight"><pre><span></span><span class="nt">process_data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">test_size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.5</span>
<span class="w">  </span><span class="nt">shuffle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="nt">train</span><span class="p">:</span>
<span class="w">  </span><span class="nt">gamma</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.01</span>
</pre></div>
<p>Full code changes can be found on <a href="https://github.com/Lee-W/dvc_example/tree/v5-parameters-in-separate-file">v5-parameters-in-separate-file</a>.</p>
<p>To add parameters to a stage, we'll need to run the previous <code>dvc run</code> command again with <code>-f</code> and <code>-p</code> flag.</p>
<ul>
<li><code>-f</code>: overwrite the stage with the same name</li>
<li><code>-p</code>: parameters<ul>
<li>Use "," to separate parameters</li>
</ul>
</li>
</ul>
<div class="highlight"><pre><span></span><span class="c1"># Add parameters process_data.test_size and process_data.shuffle to process-data stage</span>
pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>run<span class="w"> </span>-f<span class="w"> </span>--name<span class="w"> </span>process-data<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>data/digit_data.csv<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>data/digit_target.csv<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/training_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/testing_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-p<span class="w"> </span>process_data.test_size,process_data.shuffle<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">"pipenv run python digit_recognizer/digit_recognizer.py process-data"</span>

<span class="c1"># Add parameters train.gamma to train stage</span>
pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>run<span class="w"> </span>-f<span class="w"> </span>--name<span class="w"> </span>train<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>output/training_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/model.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-p<span class="w"> </span>train.gamma<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">"pipenv run python digit_recognizer/digit_recognizer.py train"</span><span class="w">  </span>

<span class="c1"># add DVC configuration to git and commit</span>
git<span class="w"> </span>add<span class="w"> </span>dvc.yaml<span class="w"> </span>dvc.lock<span class="w"> </span>model/.gitignore
pipenv<span class="w"> </span>run<span class="w"> </span>cz<span class="w"> </span>commit
</pre></div>
<p>DVC adds <code>params</code> key to both <code>process-data</code> and <code>train</code> stages in <code>dvc.yaml</code>.</p>
<div class="highlight"><pre><span></span>stages:
<span class="w">  </span>process-data:
<span class="w">    </span>......
<span class="w">    </span>params:
<span class="w">    </span>-<span class="w"> </span>process_data.shuffle
<span class="w">    </span>-<span class="w"> </span>process_data.test_size
<span class="w">  </span>train:
<span class="w">      </span>......
<span class="w">    </span>params:
<span class="w">    </span>-<span class="w"> </span>train.gamma
</pre></div>
<p><code>params.yaml</code> is the default parameter file name, but DVC also supports YAML, JSON, TOML, and <a href="https://dvc.org/doc/command-reference/params#examples-python-parameters-file">Python files</a>. We only need to add the file name as an additional layer to <code>params</code> to use it. e.g.,</p>
<div class="highlight"><pre><span></span><span class="w">  </span><span class="c1"># this is an example of using different parameter file name</span>
<span class="w">  </span><span class="c1"># we don't need to make changes to our code</span>
<span class="w">  </span><span class="nt">train</span><span class="p">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">......</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">params</span><span class="p p-Indicator">:</span>
<span class="w">  </span><span class="w w-Error">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">params.json</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">- train.gamma</span>
</pre></div>
<p>Let's change gamma to 0.1. We can check this change through <a href="https://dvc.org/doc/command-reference/params/diff">dvc params diff</a>. By providing git reference, we can even see parameters difference between different git commits. (e.g., <code>dvc params diff HEAD~1</code>)</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>params<span class="w"> </span>diff

Path<span class="w">     </span>Param<span class="w">        </span>Old<span class="w">    </span>New
params.yaml<span class="w">  </span>train.gamma<span class="w">  </span><span class="m">0</span>.01<span class="w">   </span><span class="m">0</span>.1
</pre></div>
<p>If we run <code>dvc repro</code> now, DVC reruns only <code>train</code> and <code>report</code> stages. <code>train</code> stage is affected by <code>train.gamma</code> change. Due to this change, the output file from the <code>train</code> stage has been updated. Thus, DVC reruns <code>report</code> stages as well.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>repro

<span class="s1">'data.dvc'</span><span class="w"> </span>didn<span class="s1">'t change, skipping</span>
<span class="s1">Stage '</span>process-data<span class="s1">' didn'</span>t<span class="w"> </span>change,<span class="w"> </span>skipping
Running<span class="w"> </span>stage<span class="w"> </span><span class="s1">'train'</span>:
&gt;<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span>train
Updating<span class="w"> </span>lock<span class="w"> </span>file<span class="w"> </span><span class="s1">'dvc.lock'</span>

Running<span class="w"> </span>stage<span class="w"> </span><span class="s1">'report'</span>:
&gt;<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>python<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span>report
Updating<span class="w"> </span>lock<span class="w"> </span>file<span class="w"> </span><span class="s1">'dvc.lock'</span>

To<span class="w"> </span>track<span class="w"> </span>the<span class="w"> </span>changes<span class="w"> </span>with<span class="w"> </span>git,<span class="w"> </span>run:

<span class="w">    </span>git<span class="w"> </span>add<span class="w"> </span>dvc.lock
Use<span class="w"> </span><span class="sb">`</span>dvc<span class="w"> </span>push<span class="sb">`</span><span class="w"> </span>to<span class="w"> </span>send<span class="w"> </span>your<span class="w"> </span>updates<span class="w"> </span>to<span class="w"> </span>remote<span class="w"> </span>storage.

<span class="c1"># reset gamma back to 0.01</span>
$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>dvc.lock<span class="w"> </span>params.yaml
</pre></div>
<p>We're not going to store this parameter change. Run <code>git checkout out params.yaml dvc.lock</code> to restore the previous state.</p>
<h3 id="track-metrics">Track metrics</h3>
<p>We now know how to track parameters. Next, we'll see how changing these parameters affect the performance of our models. You may have already noticed that we've outputted a <code>output/metrics.json</code> file. Although we could track it as the output file, DVC has better support for metrics files.</p>
<p>Like adding parameters, we add <code>-m</code> flag for DVC to recognize the output as metrics. Instead of using <code>-M</code> as the official tutorial did, I use <code>-m</code> because I prefer tracking metrics through DVC remote storage instead of saving it to git as part of our source code.</p>
<div class="highlight"><pre><span></span><span class="c1"># Add output/metrics.json as metrics to report stage</span>
$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>run<span class="w"> </span>-f<span class="w"> </span>--name<span class="w"> </span>report<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>output/testing_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>output/model.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/test_data_results.csv<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-m<span class="w"> </span>output/metrics.json<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">"pipenv run python digit_recognizer/digit_recognizer.py report"</span>

<span class="c1"># add DVC configuration to git and commit</span>
$<span class="w"> </span>git<span class="w"> </span>add<span class="w"> </span>dvc.yaml<span class="w"> </span>dvc.lock<span class="w"> </span>model/.gitignore
$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>cz<span class="w"> </span>commit

<span class="c1"># metrics have been added to the report stage as expected</span>
$<span class="w"> </span>cat<span class="w"> </span>dvc.yaml

...
<span class="w">  </span>report:
<span class="w">    </span>......
<span class="w">    </span>metrics:
<span class="w">    </span>-<span class="w"> </span>metrics.json:
</pre></div>
<p>Use <a href="https://dvc.org/doc/command-reference/metrics/show">dvc metrics show</a> to see how well our model performs<br/>
Note that values are not calculated through DVC. DVC only provides a way to display values in file organized as tree hierarchies and compare them throughout different git commits.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>metrics<span class="w"> </span>show

Path<span class="w">             </span>accuracy_score<span class="w">    </span>weighted_f1_score<span class="w">    </span>weighted_precision<span class="w">    </span>weighted_recall
output/metrics.json<span class="w">  </span><span class="m">0</span>.69265<span class="w">       </span><span class="m">0</span>.74567<span class="w">              </span><span class="m">0</span>.91941<span class="w">               </span><span class="m">0</span>.69265
</pre></div>
<p>Change gamma to 0.1 again and use <a href="https://dvc.org/doc/command-reference/metrics/diff">dvc metrics diff</a> to see if model performance is improved after this change.</p>
<div class="highlight"><pre><span></span><span class="c1"># reruns the pipeline with new parameters</span>
$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>repro

<span class="c1"># check metrics differences between unstaged and HEAD</span>
$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>metrics<span class="w"> </span>diff

Path<span class="w">             </span>Metric<span class="w">              </span>Old<span class="w">      </span>New<span class="w">      </span>Change
output/metrics.json<span class="w">  </span>accuracy_score<span class="w">  </span><span class="m">0</span>.69265<span class="w">  </span><span class="m">0</span>.10134<span class="w">  </span>-0.59131
output/metrics.json<span class="w">  </span>weighted_f1_score<span class="w">   </span><span class="m">0</span>.74567<span class="w">  </span><span class="m">0</span>.01865<span class="w">  </span>-0.72702
output/metrics.json<span class="w">  </span>weighted_precision<span class="w">  </span><span class="m">0</span>.91941<span class="w">  </span><span class="m">0</span>.01027<span class="w">  </span>-0.90914
output/metrics.json<span class="w">  </span>weighted_recall<span class="w"> </span><span class="m">0</span>.69265<span class="w">  </span><span class="m">0</span>.10134<span class="w">  </span>-0.59131

<span class="c1"># reset gamma back to 0.01</span>
$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>dvc.lock<span class="w"> </span>params.yaml
</pre></div>
<p>We don't need this change either. Reset gamma back to 0.01 through <code>git checkout</code></p>
<h3 id="plotting">plotting</h3>
<p>There's only one left output <code>output/test_data_results.csv</code> that has not yet been used. This file stores the ground truth and the predicted result from our model. We're going to use it to see how DVC plots our data. Before plotting, let's change gamma to 0.001 first and run <code>dvc repro</code>. Otherwise, the output plot will look a bit odd due to the low model performance.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>cat<span class="w"> </span>output/test_data_results.csv

actual,predicted
<span class="m">4</span>.0,4.0
<span class="m">8</span>.0,8.0
......
</pre></div>
<p>Add <code>--plots</code> flag and specify <code>output/test_data_results.csv</code> as the file to plot</p>
<div class="highlight"><pre><span></span><span class="c1"># add output/test_data_results.csv as the file to plot to report stage</span>
$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>run<span class="w"> </span>-f<span class="w"> </span>--name<span class="w"> </span>report<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>digit_recognizer/digit_recognizer.py<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>output/testing_data.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-d<span class="w"> </span>output/model.pkl<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-o<span class="w"> </span>output/test_data_results.csv<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>-m<span class="w"> </span>output/metrics.json<span class="w"> </span><span class="se">\</span>
<span class="w">      </span>--plots<span class="w"> </span>output/test_data_results.csv<span class="w"> </span><span class="se">\</span>
<span class="w">      </span><span class="s2">"pipenv run python digit_recognizer/digit_recognizer.py report"</span>

<span class="c1"># plots have been added to dvc.yaml</span>
$<span class="w"> </span>cat<span class="w"> </span>dvc.yaml
<span class="w">  </span>......
<span class="w">  </span>plots:
<span class="w">  </span>-<span class="w"> </span>output/test_data_results.csv
</pre></div>
<p>DVC generates plots through <a href="https://vega.github.io/vega/">Vega</a>, a declarative grammar that can define interactive graph in JSON format. It supports linear plot, scatter plot, and confusion matrix by default. These templates are stored in <code>.dvc/plots</code>. We can also define our plots. (Read<br/>
<a href="https://dvc.org/doc/command-reference/plots#custom-templates">dvc plots - Custom templates</a> to find out more)</p>
<p>In the following example, we'll plot a confusion matrix through <a href="https://dvc.org/doc/command-reference/plots/show">dvc plots show</a>.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>plots<span class="w"> </span>show<span class="w"> </span>output/test_data_results.csv<span class="w"> </span>--template<span class="w"> </span>confusion<span class="w"> </span>-x<span class="w"> </span>actual<span class="w"> </span>-y<span class="w"> </span>predicted<span class="w"> </span>--out<span class="w"> </span>confusion_matrix.html

file:///....../confusion_matrix.html
</pre></div>
<ul>
<li><code>--template</code>: name of the plot template</li>
<li><code>-x</code>: field name of the data for the X-axis</li>
<li><code>-y</code>: field name of the data for the y axis</li>
<li><code>--out</code>: output file name</li>
</ul>
<p>The following is a screenshot of the generated plot.</p>
<p><img alt="confusion-matrix" src="/images/posts-image/2021-dvc/confusion-matrix.jpg"/></p>
<p>As of now, DVC does not track our plot (i.e. <code>confusion-matrix.jpg</code>) but only our data to plot (i.e., <code>output/test_data_results.csv</code>). Let's add <code>plot</code> as the final stage of our pipeline.</p>
<div class="highlight"><pre><span></span><span class="c1"># Add stage plot</span>
pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>run<span class="w"> </span>-f<span class="w"> </span>--name<span class="w"> </span>plot<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-d<span class="w"> </span>output/test_data_results.csv<span class="w"> </span><span class="se">\</span>
<span class="w">          </span>-o<span class="w"> </span>confusion_matrix.html<span class="w"> </span><span class="se">\</span>
<span class="w">          </span><span class="s2">"pipenv run dvc plots show output/test_data_results.csv --template confusion -x actual -y predicted --out confusion_matrix.html"</span>
</pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>In this post, we create a data pipeline that process data, train the model, generate the report and visualize it.</p>
<div class="highlight"><pre><span></span>$<span class="w"> </span>pipenv<span class="w"> </span>run<span class="w"> </span>dvc<span class="w"> </span>dag

<span class="w">       </span>+----------+
<span class="w">       </span><span class="p">|</span><span class="w"> </span>data.dvc<span class="w"> </span><span class="p">|</span>
<span class="w">       </span>+----------+
<span class="w">             </span>*
<span class="w">             </span>*
<span class="w">             </span>*
<span class="w">     </span>+--------------+
<span class="w">     </span><span class="p">|</span><span class="w"> </span>process-data<span class="w"> </span><span class="p">|</span>
<span class="w">     </span>+--------------+
<span class="w">         </span>*<span class="w">        </span>*
<span class="w">       </span>**<span class="w">          </span>*
<span class="w">      </span>*<span class="w">             </span>**
+-------+<span class="w">             </span>*
<span class="p">|</span><span class="w"> </span>train<span class="w"> </span><span class="p">|</span><span class="w">           </span>**
+-------+<span class="w">          </span>*
<span class="w">         </span>*<span class="w">        </span>*
<span class="w">          </span>**<span class="w">    </span>**
<span class="w">            </span>*<span class="w">  </span>*
<span class="w">        </span>+--------+
<span class="w">        </span><span class="p">|</span><span class="w"> </span>report<span class="w"> </span><span class="p">|</span>
<span class="w">        </span>+--------+
<span class="w">             </span>*
<span class="w">             </span>*
<span class="w">             </span>*
<span class="w">         </span>+------+
<span class="w">         </span><span class="p">|</span><span class="w"> </span>plot<span class="w"> </span><span class="p">|</span>
<span class="w">         </span>+------+
</pre></div>
<p>We also see how to use DVC to track each component and provide an easy way to run the pipeline. In the following article, we will discuss how to run experiments with different parameters and compare the results in an even more convenient way.</p>
<h2 id="one-more-thing-when-should-we-save-files-to-dvc-instead-of-git">One more thing: When should we save files to DVC instead of git?</h2>
<p>Short answer: It depends.</p>
<p>When defining pipeline we can decide whether to save our outputs (<code>-o</code> / <code>-O</code>), metrics (<code>-m</code> / <code>-M</code>) and plots (<code>--plots</code> / <code>--plots-no-cache</code>) to DVC storage. DVC document suggests not storing metrics and plots to DVC as they are typically small enough for git to track. But I'd prefer storing only thing relates to our logic to git. That's why I use <code>-m</code> and <code>--plots</code> in the examples. If you don't want to track these, you could just pass <code>-O</code>, <code>-M</code>, or <code>--plots-no-cache</code> and add them to both <code>.gitignore</code> and <code>.dvcignore</code>.</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://dvc.org/">DVC</a></li>
<li><a href="https://stanford-cs329s.github.io/syllabus.html">CS 329S: Machine Learning Systems Design</a></li>
</ul>
<p id="post-share-links">
    Share on:
      <a href="https://twitter.com/intent/tweet?text=DVC%20-%20Pipeline%20Versioning&amp;url=https%3A//blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning&amp;hashtags=data,version-control,dvc" rel="nofollow noopener noreferrer" target="_blank" title="Share on Twitter">Twitter</a>
 ❄       <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning" rel="nofollow noopener noreferrer" target="_blank" title="Share on Facebook">Facebook</a>
 ❄       <a href="mailto:?subject=DVC%20-%20Pipeline%20Versioning&amp;body=https%3A//blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning" rel="nofollow noopener noreferrer" target="_blank" title="Share via Email">Email</a>
<section>
<h6 style="display:none;">Comments</h6>
<p id="comment-message">Do you like this article? What do your tink about it? Leave you comment below </p>
<div class="accordion" id="accordion2">
<div class="accordion-group">
<div class="accordion-heading">
<a class="accordion-toggle disqus-comment-count comment-count collapsed" data-parent="#accordion2" data-toggle="collapse" href="https://blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning#comment_thread" id="comment-accordion-toggle">
                    Comments
                </a>
</div>
<div class="accordion-body collapse" id="comment_thread">
<div class="accordion-inner">
<div class="comments">
<script async="" crossorigin="anonymous" data-issue-term="https://blog.wei-lee.me/posts/tech/2021/06/dvc-pipeline-versioning" data-label="comment" data-repo="Lee-W/main-blog" data-theme="" src="https://utteranc.es/client.js">
</script>
</div>
</div>
</div>
</div>
</div>
</section>
<hr/>
</p></div>
<section class="span2" id="article-sidebar">
<h4>Reading Time</h4>
<p>~9 min read</p>
<h4>Published</h4>
<time datetime="2021-06-20T11:30:00+08:00" itemprop="dateCreated">2021/06/20 - Sun</time>
<h4>Last Updated</h4>
<time datetime="2021-06-27T17:58:00+08:00">2021/06/27 - Sun</time>
<h4><built-in 0x7f7b5ad2a830="" at="" index="" method="" object="" of="" str=""></built-in></h4>
<ul class="multi-parts-list">
</ul>
<h4>Read Time</h4>
                9 min
            <h4>Category</h4>
<a class="category-link" href="https://blog.wei-lee.me/categories.html#tech-ref">Tech</a>
<h4>Tags</h4>
<ul class="list-of-tags tags-in-article">
<li><a href="https://blog.wei-lee.me/tags.html#data-ref">Data
                    <span class="superscript">2</span>
</a></li>
<li><a href="https://blog.wei-lee.me/tags.html#dvc-ref">DVC
                    <span class="superscript">2</span>
</a></li>
<li><a href="https://blog.wei-lee.me/tags.html#version-control-ref">Version Control
                    <span class="superscript">2</span>
</a></li>
</ul>
<h4>Keep In Touch</h4>
<div id="sidebar-social-link">
<a href="https://tw.linkedin.com/in/clleew" rel="nofollow noopener noreferrer" target="_blank" title="">
<svg aria-label="LinkedIn" fill="#fff" role="img" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><rect fill="#0077b5" height="512" rx="15%" width="512"></rect><circle cx="142" cy="138" r="37"></circle><path d="M244 194v198M142 194v198" stroke="#fff" stroke-width="66"></path><path d="M276 282c0-20 13-40 36-40 24 0 33 18 33 45v105h66V279c0-61-32-89-76-89-34 0-51 19-59 32"></path></svg>
</a>
<a href="https://github.com/Lee-W" rel="nofollow noopener noreferrer" target="_blank" title="">
<svg aria-label="GitHub" role="img" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><rect fill="#1B1817" height="512" rx="15%" width="512"></rect><path d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z" fill="#fff"></path></svg>
</a>
<a href="https://gitlab.com/Lee-W" rel="nofollow noopener noreferrer" target="_blank" title="">
<svg aria-label="GitLab" role="img" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><rect fill="#30353e" height="512" rx="15%" width="512"></rect><path d="M84 215l43-133c2-7 12-7 14 0l115 353L371 82c2-7 12-7 14 0l43 133" fill="#e24329"></path><path d="M256 435L84 215h100.4zm71.7-220H428L256 435l71.6-220z" fill="#fc6d26"></path><path d="M84 215l-22 67c-2 6 0 13 6 16l188 137zm344 0l22 67c2 6 0 13-6 16L256 435z" fill="#fca326"></path></svg>
</a>
<a href="https://twitter.com/clleew" rel="nofollow noopener noreferrer" target="_blank" title="">
<svg aria-label="Twitter" role="img" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><rect fill="#1da1f3" height="512" rx="15%" width="512"></rect><path d="M437 152a72 72 0 0 1-40 12 72 72 0 0 0 32-40 72 72 0 0 1-45 17 72 72 0 0 0-122 65 200 200 0 0 1-145-74 72 72 0 0 0 22 94 72 72 0 0 1-32-7 72 72 0 0 0 56 69 72 72 0 0 1-32 1 72 72 0 0 0 67 50 200 200 0 0 1-105 29 200 200 0 0 0 309-179 200 200 0 0 0 35-37" fill="#fff"></path></svg>
</a>
<a href="https://wei-lee.me/feeds/all.atom.xml" rel="nofollow noopener noreferrer" target="_blank" title="">
<svg aria-label="RSS" role="img" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><rect fill="#f80" height="512" rx="15%" width="512"></rect><circle cx="145" cy="367" fill="#fff" r="35"></circle><path d="M109 241c89 0 162 73 162 162M109 127c152 0 276 124 276 276" fill="none" stroke="#fff" stroke-width="60"></path></svg>
</a>
</div>
</section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div aria-hidden="true" class="pswp" role="dialog" tabindex="-1">
<!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
<div class="pswp__bg"></div>
<!-- Slides wrapper with overflow:hidden. -->
<div class="pswp__scroll-wrap">
<!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
<div class="pswp__container">
<div class="pswp__item"></div>
<div class="pswp__item"></div>
<div class="pswp__item"></div>
</div>
<!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
<div class="pswp__ui pswp__ui--hidden">
<div class="pswp__top-bar">
<!--  Controls are self-explanatory. Order can be changed. -->
<div class="pswp__counter"></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title="Share"></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
<!-- element will get class pswp__preloader--active when preloader is running -->
<div class="pswp__preloader">
<div class="pswp__preloader__icn">
<div class="pswp__preloader__cut">
<div class="pswp__preloader__donut"></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class="pswp__share-tooltip"></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class="pswp__caption">
<div class="pswp__caption__center"></div>
</div>
</div>
</div>
</div> </div>
<div class="span1"></div>
</div>
</div>
</div>
<footer>
<div>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license">
<img alt="Creative Commons License" src="https://i.creativecommons.org/l/by/4.0/88x31.png" style="border-width:0"/>
</a>
<br/>
This work is licensed under a
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license">
    Creative Commons Attribution 4.0 International License
</a>.

    </div>
<div id="fpowered">
        Powered by: <a href="http://getpelican.com/" rel="nofollow noopener noreferrer" target="_blank" title="Pelican Home Page">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" rel="nofollow noopener noreferrer" target="_blank" title="Theme Elegant Home Page">Elegant</a>
</div>
</footer> <script src="//code.jquery.com/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
<script src="https://blog.wei-lee.me/theme/js/elegant.prod.9e9d5ce754.js"></script>
<script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>
<script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>
</body>
<!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>